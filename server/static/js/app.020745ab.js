(function(e){function t(t){for(var s,r,a=t[0],l=t[1],c=t[2],u=0,d=[];u<a.length;u++)r=a[u],n[r]&&d.push(n[r][0]),n[r]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(e[s]=l[s]);h&&h(t);while(d.length)d.shift()();return o.push.apply(o,c||[]),i()}function i(){for(var e,t=0;t<o.length;t++){for(var i=o[t],s=!0,a=1;a<i.length;a++){var l=i[a];0!==n[l]&&(s=!1)}s&&(o.splice(t--,1),e=r(r.s=i[0]))}return e}var s={},n={app:0},o=[];function r(t){if(s[t])return s[t].exports;var i=s[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=s,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(i,s,function(t){return e[t]}.bind(null,s));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/";var a=window["webpackJsonp"]=window["webpackJsonp"]||[],l=a.push.bind(a);a.push=t,a=a.slice();for(var c=0;c<a.length;c++)t(a[c]);var h=l;o.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("cd49")},"0222":function(e,t,i){},"034f":function(e,t,i){"use strict";var s=i("64a9"),n=i.n(s);n.a},"0de1":function(e,t,i){},1:function(e,t){},1133:function(e,t,i){"use strict";var s=i("8336"),n=i.n(s);n.a},"12d3":function(e,t,i){"use strict";var s=i("a260"),n=i.n(s);n.a},"1e7c":function(e,t,i){},2777:function(e,t,i){},"291a":function(e,t,i){"use strict";var s=i("b98b"),n=i.n(s);n.a},"2a75":function(e,t,i){"use strict";var s=i("9195"),n=i.n(s);n.a},"31d1":function(e,t,i){},3972:function(e,t,i){},"3ba3":function(e,t,i){"use strict";var s=i("79b7"),n=i.n(s);n.a},"3d9b":function(e,t,i){"use strict";var s=i("703c"),n=i.n(s);n.a},"3f2c":function(e,t,i){},4315:function(e,t,i){},4612:function(e,t,i){"use strict";var s=i("3972"),n=i.n(s);n.a},"4a14":function(e,t,i){"use strict";var s=i("9850"),n=i.n(s);n.a},"559e":function(e,t,i){"use strict";var s=i("31d1"),n=i.n(s);n.a},"561b":function(e,t,i){"use strict";var s=i("a450"),n=i.n(s);n.a},"57af":function(e,t,i){"use strict";var s=i("1e7c"),n=i.n(s);n.a},"5b11":function(e,t,i){},6146:function(e,t,i){"use strict";var s=i("9ca7"),n=i.n(s);n.a},"618b":function(e,t,i){"use strict";var s=i("d450"),n=i.n(s);n.a},"618e":function(e,t,i){"use strict";var s=i("7985"),n=i.n(s);n.a},"64a9":function(e,t,i){},"6da0":function(e,t,i){"use strict";var s=i("e1a0"),n=i.n(s);n.a},"703c":function(e,t,i){},7392:function(e,t,i){"use strict";var s=i("0222"),n=i.n(s);n.a},"78c7":function(e,t,i){"use strict";var s=i("9227"),n=i.n(s);n.a},7985:function(e,t,i){},"79b7":function(e,t,i){},"7f1e":function(e,t,i){"use strict";var s=i("fe11"),n=i.n(s);n.a},8336:function(e,t,i){},8788:function(e,t,i){},"8d74":function(e,t,i){"use strict";var s=i("8788"),n=i.n(s);n.a},9195:function(e,t,i){},9227:function(e,t,i){},9850:function(e,t,i){},"9c0f":function(e,t,i){"use strict";var s=i("0de1"),n=i.n(s);n.a},"9ca7":function(e,t,i){},a126:function(e,t,i){},a260:function(e,t,i){},a450:function(e,t,i){},aa79:function(e,t,i){"use strict";var s=i("fce9"),n=i.n(s);n.a},ab66:function(e,t,i){"use strict";var s=i("ca99"),n=i.n(s);n.a},ae5a:function(e,t,i){"use strict";var s=i("3f2c"),n=i.n(s);n.a},b98b:function(e,t,i){},c098:function(e,t,i){},c4d5:function(e,t,i){},c947:function(e,t,i){"use strict";var s=i("5b11"),n=i.n(s);n.a},ca99:function(e,t,i){},cd49:function(e,t,i){"use strict";i.r(t);var s=i("a026"),n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"app"}},[i("router-view",{ref:"activeComponent"})],1)},o=[],r=(i("034f"),i("2877")),a={},l=Object(r["a"])(a,n,o,!1,null,null,null),c=l.exports,h=i("bc3a"),u=i.n(h),d=i("8c4f"),p=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"AssetManager"}},[i("div",{attrs:{id:"titlebar"}},[e._v("Asset Manager")]),i("div",{attrs:{id:"main"}},[i("div",{attrs:{id:"assets"},on:{dragover:function(t){return t.preventDefault(),e.moveDrag(t)},drop:function(t){return t.preventDefault(),t.stopPropagation(),e.stopDrag(t,e.currentFolder)}}},[i("div",{attrs:{id:"breadcrumbs"}},[i("div",[e._v("/")]),e._l(e.path,function(t){return i("div",{key:t},[e._v(e._s(e.idMap.get(t).name))])})],2),i("div",{attrs:{id:"actionbar"}},[i("input",{attrs:{id:"files",type:"file",multiple:"",hidden:""},on:{change:function(t){return e.upload()}}}),i("div",{attrs:{title:"Create folder"},on:{click:e.createDirectory}},[i("i",{staticClass:"fas fa-plus-square"})]),i("div",{attrs:{title:"Upload files"},on:{click:e.prepareUpload}},[i("i",{staticClass:"fas fa-upload"})])]),i("div",{attrs:{id:"explorer"}},[e.path.length?i("div",{staticClass:"inode folder",on:{dblclick:function(t){return e.changeDirectory(-1)},dragover:function(t){return t.preventDefault(),e.moveDrag(t)},dragleave:function(t){return t.preventDefault(),e.leaveDrag(t)},drop:function(t){return t.preventDefault(),t.stopPropagation(),e.stopDrag(t,e.parentFolder)}}},[i("i",{staticClass:"fas fa-folder",staticStyle:{"font-size":"50px"}}),i("div",{staticClass:"title"},[e._v("..")])]):e._e(),e._l(e.folders,function(t){return i("div",{key:t,staticClass:"inode folder",class:{"inode-selected":e.selected.includes(t)},attrs:{draggable:"true"},on:{click:function(i){return e.select(i,t)},dblclick:function(i){return e.changeDirectory(t)},contextmenu:function(i){return i.preventDefault(),e.$refs.cm.open(i,t)},dragstart:function(i){return e.startDrag(i,t)},dragover:function(t){return t.preventDefault(),e.moveDrag(t)},dragleave:function(t){return t.preventDefault(),e.leaveDrag(t)},drop:function(i){return i.preventDefault(),i.stopPropagation(),e.stopDrag(i,t)}}},[i("i",{staticClass:"fas fa-folder",staticStyle:{"font-size":"50px"}}),i("div",{staticClass:"title"},[e._v(e._s(e.idMap.get(t).name))])])}),e._l(e.files,function(t){return i("div",{key:t,staticClass:"inode file",class:{"inode-selected":e.selected.includes(t)},attrs:{draggable:"true"},on:{click:function(i){return e.select(i,t)},contextmenu:function(i){return i.preventDefault(),e.$refs.cm.open(i,t)},dragstart:function(i){return e.startDrag(i,t)}}},[i("img",{attrs:{src:"/static/assets/"+e.idMap.get(t).file_hash,width:"50"}}),i("div",{staticClass:"title"},[e._v(e._s(e.idMap.get(t).name))])])})],2)]),e.firstSelectedFile?i("div",{attrs:{id:"asset-details"}},[i("div",{attrs:{id:"asset-detail-title"}},[e._v(e._s(e.firstSelectedFile.name))]),i("img",{attrs:{src:"/static/assets/"+e.firstSelectedFile.file_hash}})]):e._e()]),i("AssetContextMenu",{ref:"cm"}),i("Prompt",{ref:"prompt"}),i("ConfirmDialog",{ref:"confirm"})],1)},f=[],v=i("9ab4"),g=i("2fe1"),m=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ContextMenu",{attrs:{visible:e.visible,left:e.left+"px",top:e.top+"px"},on:{close:e.close}},[i("li",{on:{click:e.rename}},[e._v("Rename")]),i("li",{on:{click:e.remove}},[e._v("Remove")])])},b=[],y=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.visible?i("div",{staticClass:"ContextMenu",style:{left:e.left,top:e.top},attrs:{tabindex:"-1"},on:{blur:function(t){return e.$emit("close")}}},[i("ul",[e._t("default")],2)]):e._e()},w=[];let x=class extends s["default"]{};x=v["a"]([Object(g["b"])({props:["visible","left","top"]})],x);var C=x,_=C,S=(i("7f1e"),Object(r["a"])(_,y,w,!1,null,null,null)),k=S.exports,L=i("8055"),E=i.n(L),I=(i("ac6a"),i("6fc5")),O=i("2f62");s["default"].use(O["a"]);const T=new O["a"].Store({});let M=class extends I["d"]{constructor(){super(...arguments),this.root=-1,this.files=[],this.folders=[],this.idMap=new Map,this.selected=[]}clear(){this.folders=[],this.files=[]}clearSelected(){console.log("Cleared"),this.selected=[]}setRoot(e){this.root=e}};v["a"]([I["c"]],M.prototype,"clear",null),v["a"]([I["c"]],M.prototype,"clearSelected",null),v["a"]([I["c"]],M.prototype,"setRoot",null),M=v["a"]([Object(I["b"])({dynamic:!0,store:T,name:"assets",namespaced:!0})],M);const P=Object(I["e"])(M),D=E()(location.protocol+"//"+location.host+"/pa_assetmgmt",{autoConnect:!1});D.on("connect",()=>{console.log("Connected")}),D.on("disconnect",()=>{console.log("Disconnected")}),D.on("redirect",e=>{console.log("redirecting"),window.location.href=e}),D.on("Folder.Root.Set",e=>{P.setRoot(e)}),D.on("Folder.Set",e=>{if(P.clear(),e.children)for(const t of e.children)P.idMap.set(t.id,t),t.file_hash?P.files.push(t.id):P.folders.push(t.id)}),D.on("Folder.Create",e=>{P.folders.push(e.id),P.idMap.set(e.id,e)}),D.on("Asset.Upload.Finish",e=>{P.idMap.set(e.id,e),P.files.push(e.id)});let N=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.left=0,this.top=0}open(e,t){P.selected.includes(t)||this.parent.select(e,t),this.visible=!0,this.left=e.pageX,this.top=e.pageY,this.$nextTick(()=>{this.$children[0].$el.focus()})}close(){this.visible=!1}get parent(){return this.$parent}rename(){if(1!==P.selected.length)return;const e=P.idMap.get(P.selected[0]);this.parent.$refs.prompt.prompt("New name:",`Renaming ${e.name}`).then(t=>{D.emit("Asset.Rename",{asset:e.id,name:t}),e.name=t,this.parent.$forceUpdate()},()=>{}),this.close()}remove(){0!==P.selected.length&&(this.parent.$refs.confirm.open("Are you sure you wish to remove this?").then(e=>{if(e){for(const e of P.selected)D.emit("Asset.Remove",e),P.files.includes(e)?P.files.splice(P.files.indexOf(e),1):P.folders.splice(P.folders.indexOf(e),1);P.clearSelected()}},()=>{}),this.close())}};N=v["a"]([Object(g["b"])({components:{ContextMenu:k}})],N);var A=N,R=A,V=Object(r["a"])(R,m,b,!1,null,null,null),$=V.exports,U=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("modal",{attrs:{visible:e.visible},on:{close:e.close},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[e._v("\n        "+e._s(e.title)+"\n    ")])}}])},[i("div",{staticClass:"modal-body"},[i("button",{ref:"confirm",on:{click:e.confirm}},[e._v(e._s(e.yes))]),e.no?i("button",{on:{click:e.deny}},[e._v(e._s(e.no))]):e._e()])])},F=[],z=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("transition",{attrs:{name:"modal"}},[i("div",{directives:[{name:"show",rawName:"v-show",value:e.visible,expression:"visible"}],staticClass:"mask",class:{"modal-mask":e.mask,"dialog-mask":!e.mask},on:{click:e.close,dragover:function(t){return t.preventDefault(),e.dragOver(t)}}},[i("div",{ref:"container",staticClass:"modal-container",style:{"background-color":e.colour},on:{click:function(e){e.stopPropagation()}}},[e._t("header",null,{dragStart:e.dragStart,dragEnd:e.dragEnd}),e._t("default")],2)])])},B=[],H=i("60a3");let G=class extends s["default"]{constructor(){super(...arguments),this.positioned=!1,this.offsetX=0,this.offsetY=0,this.screenX=0,this.screenY=0,this.dragging=!1}mounted(){this.updatePosition()}updated(){this.updatePosition()}close(e){this.$emit("close")}updatePosition(){if(!this.positioned){const e=this.$refs.container;if(0===e.offsetWidth&&0===e.offsetHeight)return;this.$refs.container.style.left=(window.innerWidth-e.offsetWidth)/2+"px",this.$refs.container.style.top=(window.innerHeight-e.offsetHeight)/2+"px",this.positioned=!0}}dragStart(e){null!==e&&null!==e.dataTransfer&&(e.dataTransfer.setData("Hack",""),e.dataTransfer.setDragImage(this.$refs.container,e.offsetX,e.offsetY),this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.screenX=e.screenX,this.screenY=e.screenY,this.dragging=!0)}dragEnd(e){this.dragging=!1;let t=e.clientX-this.offsetX,i=e.clientY-this.offsetY;0===e.clientX&&0===e.clientY&&0===e.pageX&&0===e.pageY&&(t=parseInt(this.$refs.container.style.left,10)-(this.screenX-e.screenX),i=parseInt(this.$refs.container.style.top,10)-(this.screenY-e.screenY)),t<0&&(t=0),t>window.innerWidth-100&&(t=window.innerWidth-100),i<0&&(i=0),i>window.innerHeight-100&&(i=window.innerHeight-100),this.$refs.container.style.left=t+"px",this.$refs.container.style.top=i+"px",this.$refs.container.style.display="block"}dragOver(e){this.dragging&&(this.$refs.container.style.display="none")}};v["a"]([Object(H["a"])(Boolean)],G.prototype,"visible",void 0),v["a"]([Object(H["a"])({type:Boolean,default:!0})],G.prototype,"mask",void 0),v["a"]([Object(H["a"])({type:String,default:"white"})],G.prototype,"colour",void 0),G=v["a"]([g["b"]],G);var j=G,W=j,X=(i("618e"),Object(r["a"])(W,z,B,!1,null,"2098e4f8",null)),Y=X.exports;let K=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.yes="Yes",this.no="No",this.title="",this.resolve=e=>{},this.reject=()=>{}}confirm(){this.resolve(!0),this.close()}deny(){this.resolve(!1),this.close()}close(){this.reject(),this.visible=!1,this.title=""}open(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yes",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"no";return this.yes=t,this.no=i,this.title=e,this.visible=!0,this.$nextTick(()=>{this.$refs.confirm.focus()}),new Promise((e,t)=>{this.resolve=e,this.reject=t})}};K=v["a"]([Object(g["b"])({components:{Modal:Y}})],K);var q=K,Q=q,Z=(i("fb5d"),Object(r["a"])(Q,U,F,!1,null,"46dc898b",null)),J=Z.exports,ee=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("Modal",{attrs:{visible:e.visible},on:{close:e.close},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[e._v("\n        "+e._s(e.title)+"\n    ")])}}])},[i("div",{staticClass:"modal-body"},[e._v("\n        "+e._s(e.question)+"\n        "),i("input",{directives:[{name:"model",rawName:"v-model",value:e.answer,expression:"answer"}],ref:"answer",attrs:{type:"text"},domProps:{value:e.answer},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.submit(t)},input:function(t){t.target.composing||(e.answer=t.target.value)}}})]),i("div",{staticClass:"modal-footer"},[i("button",{on:{click:e.submit}},[e._v("Submit")])])])},te=[];let ie=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.question="",this.answer="",this.title="",this.resolve=e=>{},this.reject=()=>{}}submit(){this.resolve(this.answer),this.close()}close(){this.reject(),this.visible=!1,this.question="",this.answer="",this.title=""}prompt(e,t){return this.question=e,this.title=t,this.visible=!0,this.$nextTick(()=>{this.$refs.answer.focus()}),new Promise((e,t)=>{this.resolve=e,this.reject=t})}};ie=v["a"]([Object(g["b"])({components:{Modal:Y}})],ie);var se=ie,ne=se,oe=(i("1133"),Object(r["a"])(ne,ee,te,!1,null,"391b52fc",null)),re=oe.exports;i("28a5"),i("6b54"),i("a481");function ae(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0,i="x"===e?t:3&t|8;return i.toString(16)})}function le(e,t){return e.toLowerCase()<t.toLowerCase()?-1:1}function ce(e,t){const i=[[],[]];return e.forEach(e=>t(e)?i[1].push(e):i[0].push(e)),i}function he(e,t,i,s){const n=.2*Number(e.font.split("px")[0]),o=e.measureText(t).width;return Math.min(i/o,s/n)}let ue=class extends s["default"]{constructor(){super(...arguments),this.path=[],this.draggingSelection=!1}get folders(){return P.folders}get files(){return P.files}get selected(){return P.selected}get idMap(){return P.idMap}get currentFolder(){return this.path.length?this.path[this.path.length-1]:P.root}get parentFolder(){let e=this.path[this.path.length-2];return void 0===e&&(e=P.root),e}get firstSelectedFile(){for(const e of P.selected)if(P.idMap.get(e).file_hash)return P.idMap.get(e);return null}changeDirectory(e){e<0?this.path.pop():this.path.push(e),P.clearSelected(),D.emit("Folder.Get",this.currentFolder)}createDirectory(){const e=window.prompt("New folder name");null!==e&&D.emit("Folder.Create",{name:e,parent:this.currentFolder})}moveInode(e,t){P.files.includes(e)?P.files.splice(P.files.indexOf(e),1):P.folders.splice(P.folders.indexOf(e),1),P.idMap.delete(e),D.emit("Inode.Move",{inode:e,target:t})}select(e,t){if(e.shiftKey&&P.selected.length>0){const e=[...P.files,...P.folders],i=e.indexOf(P.selected[P.selected.length-1]),s=e.indexOf(t);for(let t=i;t!==s;i<s?t++:t--)t!==i&&P.selected.push(e[t]);P.selected.push(e[s])}else e.ctrlKey||P.clearSelected(),P.selected.push(t)}startDrag(e,t){null!==e.dataTransfer&&(e.dataTransfer.setData("Hack","ittyHack"),e.dataTransfer.dropEffect="move",P.selected.includes(t)||P.selected.push(t),this.draggingSelection=!0)}moveDrag(e){e.target.classList.contains("folder")&&e.target.classList.add("inode-selected")}leaveDrag(e){e.target.classList.contains("folder")&&e.target.classList.remove("inode-selected")}stopDrag(e,t){if(e.target.classList.remove("inode-selected"),this.draggingSelection){if((t===P.root||P.folders.includes(t))&&!P.selected.includes(t))for(const e of P.selected)this.moveInode(e,t);P.clearSelected()}else e.dataTransfer&&e.dataTransfer.files.length>0&&this.upload(e.dataTransfer.files,t);this.draggingSelection=!1}prepareUpload(){document.getElementById("files").click()}upload(e,t){const i=document.getElementById("files").files;if(void 0===e){if(!i)return;e=i}void 0===t&&(t=this.currentFolder);const s=1e5;for(const n of e){const e=ae(),i=Math.ceil(n.size/s);for(let o=0;o<i;o++){const r=new FileReader;r.readAsArrayBuffer(n.slice(o*s,o*s+Math.min(s,n.size-o*s))),r.onload=s=>{D.emit("Asset.Upload",{name:n.name,directory:t,data:r.result,slice:o,totalSlices:i,uuid:e})}}}}};ue=v["a"]([Object(g["b"])({components:{Prompt:re,ConfirmDialog:J,AssetContextMenu:$},beforeRouteEnter(e,t,i){D.connect(),i()},beforeRouteLeave(e,t,i){D.disconnect(),i()}})],ue);var de=ue,pe=de,fe=(i("78c7"),Object(r["a"])(pe,p,f,!1,null,null,null)),ve=fe.exports,ge=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("form",{on:{focusin:e.focusin,focusout:e.focusout,submit:function(t){return t.preventDefault(),e.login(t)}}},[i("fieldset",[i("legend",{staticClass:"legend"},[e._v("PlanarAlly")]),i("div",{staticClass:"input"},[i("input",{directives:[{name:"model",rawName:"v-model",value:e.username,expression:"username"}],attrs:{type:"text",name:"username",placeholder:"Username",autocomplete:"username",required:""},domProps:{value:e.username},on:{input:function(t){t.target.composing||(e.username=t.target.value)}}}),e._m(0)]),i("div",{staticClass:"input"},[i("input",{directives:[{name:"model",rawName:"v-model",value:e.password,expression:"password"}],attrs:{type:"password",name:"password",placeholder:"Password",autocomplete:"current-password",required:""},domProps:{value:e.password},on:{input:function(t){t.target.composing||(e.password=t.target.value)}}}),e._m(1)]),i("div",{staticStyle:{display:"flex"}},[i("button",{staticStyle:{visibility:"hidden",display:"none"},attrs:{type:"submit",name:"login"}}),i("button",{staticClass:"submit",attrs:{type:"button",name:"register",title:"Register"},on:{click:e.register}},[i("i",{staticClass:"fas fa-plus"})]),e._m(2)])]),e.error?i("div",{staticClass:"feedback"},[i("p",{staticClass:"error"},[i("strong",[e._v("Error:")]),e._v("\n            "+e._s(e.error)+"\n        ")])]):e._e()])},me=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",[i("i",{staticClass:"fas fa-user-circle"})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",[i("i",{staticClass:"fas fa-lock"})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("button",{staticClass:"submit",attrs:{type:"submit",name:"login",title:"Login"}},[i("i",{staticClass:"fas fa-arrow-right"})])}];let be=class extends I["d"]{constructor(){super(...arguments),this.authenticated=!1,this.initialized=!1,this.username=""}setAuthenticated(e){this.authenticated=e}setInitialized(e){this.initialized=e}setUsername(e){this.username=e}};v["a"]([I["c"]],be.prototype,"setAuthenticated",null),v["a"]([I["c"]],be.prototype,"setInitialized",null),v["a"]([I["c"]],be.prototype,"setUsername",null),be=v["a"]([Object(I["b"])({dynamic:!0,store:T,name:"core"})],be);const ye=Object(I["e"])(be);let we=class extends s["default"]{constructor(){super(...arguments),this.username="",this.password="",this.error=""}login(){u.a.post("/api/login",{username:this.username,password:this.password}).then(e=>{ye.setUsername(this.username),ye.setAuthenticated(!0),this.$router.push(this.$route.query.redirect||"/")}).catch(e=>{e.response?this.error=e.response.statusText:this.error="Unknown error occured"})}register(){u.a.post("/api/register",{username:this.username,password:this.password}).then(e=>{ye.setUsername(this.username),ye.setAuthenticated(!0),this.$router.push(this.$route.query.redirect||"/")}).catch(e=>{e.response?this.error=e.response.statusText:this.error="Unknown error occured"})}focusin(e){if(e.target&&e.target.nextElementSibling){const t=e.target.nextElementSibling;t.style.opacity="0"}}focusout(e){if(e.target&&e.target.nextElementSibling){const t=e.target.nextElementSibling;t.style.opacity="1"}}};we=v["a"]([g["b"]],we);var xe=we,Ce=xe,_e=(i("c947"),Object(r["a"])(Ce,ge,me,!1,null,"6062c8f4",null)),Se=_e.exports;g["b"].registerHooks(["beforeRouteEnter"]);let ke=class extends s["default"]{beforeRouteEnter(e,t,i){u.a.post("/api/logout").then(()=>{ye.setAuthenticated(!1),ye.setUsername(""),i({path:"/auth/login"})})}};ke=v["a"]([Object(g["b"])({})],ke);var Le=ke,Ee=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[e._v(e._s(e.message))])},Ie=[];let Oe=class extends s["default"]{constructor(){super(...arguments),this.message="Loading..."}};Oe=v["a"]([g["b"]],Oe);var Te=Oe,Me=Te,Pe=Object(r["a"])(Me,Ee,Ie,!1,null,null,null),De=Pe.exports,Ne=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"formcontainer"}},[e.owned||e.joined?i("form",[i("fieldset",[i("legend",{staticClass:"legend"},[e._v("Your sessions")]),i("div",{staticClass:"input"},[e._l(e.owned,function(t,s){return i("router-link",{key:"o-"+s,attrs:{to:"/game/"+encodeURIComponent(t[1])+"/"+encodeURIComponent(t[0])}},[e._v("\n                    "+e._s(t[0])+"\n                ")])}),e._l(e.joined,function(t,s){return i("router-link",{key:"j-"+s,attrs:{to:"/game/"+encodeURIComponent(t[1])+"/"+encodeURIComponent(t[0])}},[e._v("\n                    "+e._s(t[1])+"/"+e._s(t[0])+"\n                ")])})],2),0===e.owned.length?i("div",{staticClass:"input"},[e._v("No active sessions")]):e._e()])]):e._e(),e._m(0),i("form",{on:{submit:function(t){return t.preventDefault(),e.createRoom(t)}}},[i("fieldset",[e.owned||e.joined?i("div",{staticClass:"input"},[e._v("Create a new session")]):i("legend",{staticClass:"legend"},[e._v("Create a session")]),i("div",{staticClass:"input"},[i("input",{directives:[{name:"model",rawName:"v-model",value:e.newSessionName,expression:"newSessionName"}],attrs:{type:"text",name:"room_name",placeholder:"Session Name"},domProps:{value:e.newSessionName},on:{input:function(t){t.target.composing||(e.newSessionName=t.target.value)}}}),e._m(1)]),e._m(2)])]),i("div",{attrs:{id:"account-options"}},[i("form",{on:{submit:function(e){e.preventDefault()}}},[i("router-link",{staticClass:"submit",attrs:{tag:"button",title:"Account Settings",to:"/account"}},[i("i",{staticClass:"fas fa-cog"})])],1),i("form",{on:{submit:function(e){e.preventDefault()}}},[i("router-link",{staticClass:"submit",attrs:{tag:"button",title:"Logout",to:"/auth/logout"}},[i("i",{staticClass:"fas fa-sign-out-alt"})])],1)])])},Ae=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("h4",[i("span",[e._v("OR")])])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",[i("i",{staticClass:"fab fa-d-and-d"})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("button",{staticClass:"submit",attrs:{type:"submit",title:"Create"}},[i("i",{staticClass:"fas fa-arrow-right"})])}];g["b"].registerHooks(["beforeRouteEnter"]);let Re=class extends s["default"]{constructor(){super(...arguments),this.owned=[],this.joined=[],this.error="",this.newSessionName=""}beforeRouteEnter(e,t,i){u.a.get("/api/rooms").then(e=>{i(t=>{t.owned=e.data.owned,t.joined=e.data.joined})}).catch(e=>{i(t=>{t.error=e.message})})}createRoom(e){u.a.post("/api/rooms",{name:this.newSessionName}).then(e=>{this.$router.push(`/game/${encodeURIComponent(ye.username)}/${encodeURIComponent(this.newSessionName)}`)}).catch(e=>{this.error=e.message})}};Re=v["a"]([g["b"]],Re);var Ve=Re,$e=Ve,Ue=(i("d9e0"),Object(r["a"])($e,Ne,Ae,!1,null,"f34c77ee",null)),Fe=Ue.exports,ze=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"main"},on:{mouseleave:e.mouseleave,wheel:e.zoom}},[e.showUI?i("menu-bar"):e._e(),i("div",{attrs:{id:"board"}},[e.ready.manager?[i("tool-bar",{directives:[{name:"show",rawName:"v-show",value:e.showUI,expression:"showUI"}],ref:"tools"})]:e._e(),i("div",{attrs:{id:"layers"},on:{mousedown:e.mousedown,mouseup:e.mouseup,mousemove:e.mousemove,contextmenu:function(t){return t.preventDefault(),t.stopPropagation(),e.contextmenu(t)},dragover:function(e){e.preventDefault()},drop:function(t){return t.preventDefault(),t.stopPropagation(),e.drop(t)}}}),i("div",{directives:[{name:"show",rawName:"v-show",value:e.showUI&&e.layers.length>1,expression:"showUI && layers.length > 1"}],attrs:{id:"layerselect"}},[i("ul",e._l(e.layers,function(t){return i("li",{key:t.name,class:{"layer-selected":t===e.selectedLayer},on:{mousedown:function(i){return e.selectLayer(t)}}},[i("a",{attrs:{href:"#"}},[e._v(e._s(t))])])}),0)])],2),i("selection-info",{directives:[{name:"show",rawName:"v-show",value:e.showUI,expression:"showUI"}],ref:"selectionInfo"}),i("initiative-dialog",{ref:"initiative",attrs:{id:"initiativedialog"}}),i("note-dialog",{ref:"note"}),i("label-dialog",{ref:"labels"}),e.IS_DM||e.FAKE_PLAYER?i("dm-settings",{ref:"dmsettings"}):e._e(),i("div",{attrs:{id:"zoomer"}},[i("zoom-slider",{directives:[{name:"show",rawName:"v-show",value:e.showUI,expression:"showUI"}],attrs:{id:"zoomer",height:6,width:200,min:0,max:1,interval:.1,"dot-size":[8,20],"dot-options":{style:{"border-radius":"15%","z-index":11}},"tooltip-placement":"bottom",tooltip:"focus","tooltip-formatter":e.zoomDisplay.toFixed(1),"rail-style":{"background-color":"#fff","box-shadow":"0.5px 0.5px 3px 1px rgba(0, 0, 0, .36)"},"process-style":{"background-color":"#fff"}},model:{value:e.zoomDisplay,callback:function(t){e.zoomDisplay=t},expression:"zoomDisplay"}})],1),i("prompt-dialog",{ref:"prompt"}),i("confirm-dialog",{ref:"confirm"})],1)},Be=[],He=i("0f32"),Ge=i.n(He),je=i("4971"),We=i.n(je);i("24df");const Xe=E()(location.protocol+"//"+location.host+"/planarally",{autoConnect:!1});function Ye(e){Xe.io.opts.query=`user=${decodeURIComponent(e.params.creator)}&room=${decodeURIComponent(e.params.room)}`,Xe.connect()}const Ke=new s["default"];class qe{constructor(e,t){this.x=e,this.y=t}static fromArray(e){return new qe(e[0],e[1])}add(e){return new qe(this.x+e.x,this.y+e.y)}subtract(e){return new Je(this.x-e.x,this.y-e.y)}clone(){return new qe(this.x,this.y)}get(e){return 0===e?this.x:this.y}asArray(){return[this.x,this.y]}}class Qe extends qe{add(e){return super.add(e)}subtract(e){return super.subtract(e)}clone(){return super.clone()}static fromArray(e){return new Qe(e[0],e[1])}}class Ze extends qe{add(e){return super.add(e)}subtract(e){return super.subtract(e)}clone(){return super.clone()}}class Je{constructor(e,t){this.x=e,this.y=t}dot(e){return this.x*e.x+this.y*e.y}inverse(){return new Je(0===this.x?0:1/this.x,0===this.y?0:1/this.y)}length(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}normalize(){const e=this.length();return new Je(this.x/e,this.y/e)}reverse(){return new Je(-this.x,-this.y)}multiply(e){return new Je(this.x*e,this.y*e)}angle(){return 180*Math.atan2(this.y,this.x)/Math.PI}}class et{constructor(e,t,i){this.direction=t,this.origin=e,void 0===i&&(i=1/0),this.tMax=i}static fromPoints(e,t){const i=new Je(t.x-e.x,t.y-e.y);let s;return s=Math.abs(i.x)>.01?(t.x-e.x)/i.x:(t.y-e.y)/i.y,new et(e,i,s)}get(e){return new qe(this.origin.x+e*this.direction.x,this.origin.y+e*this.direction.y)}getDistance(e,t){return Math.sqrt(Math.pow(t-e,2)*(Math.pow(this.direction.x,2)+Math.pow(this.direction.y,2)))}getT(e,t){return e+Math.sqrt(Math.pow(t,2)/(Math.pow(this.direction.x,2)+Math.pow(this.direction.y,2)))}}var tt=i("66cb"),it=i.n(tt);function st(e){Xe.emit("Client.Options.Set",{locationOptions:e})}function nt(e){const t=yt.zoomFactor,i=yt.panX,s=yt.panY;return new Ze((e.x+i)*t,(e.y+s)*t)}function ot(e){return nt(new Qe(e,0)).x}function rt(e){return nt(new Qe(0,e)).y}function at(e){return e*yt.zoomFactor}function lt(e){return e/yt.unitSize*yt.gridSize}function ct(e){return at(lt(e))}function ht(e){const t=yt.zoomFactor,i=yt.panX,s=yt.panY;return e instanceof Ze?new Qe(e.x/t-i,e.y/t-s):new et(ht(e.origin),e.direction.multiply(1/t),e.tMax)}function ut(e){return ht(new Ze(e,0)).x}function dt(e){return ht(new Ze(0,e)).y}function pt(e){return e/yt.zoomFactor}function ft(e){return new Ze(e.pageX,e.pageY)}function vt(e){return 1/(-5/3+28/15*Math.exp(1.83*e))}function gt(e){return Math.log(15/28*(1/e+5/3))/1.83}function mt(e,t){return e[0]===t[0]&&e[1]===t[1]}window.g2lx=ot,window.g2ly=rt;let bt=class extends I["d"]{constructor(){super(...arguments),this.layers=[],this.selectedLayerIndex=-1,this.boardInitialized=!1,this.locations=[],this.assets={},this.notes=[],this.IS_DM=!1,this.FAKE_PLAYER=!1,this.isLocked=!1,this.gridSize=50,this.username="",this.roomName="",this.roomCreator="",this.invitationCode="",this.players=[],this.gridColour="rgba(0, 0, 0, 1)",this.fowColour="rgba(0, 0, 0, 1)",this.rulerColour="rgba(255, 0, 0, 1)",this.panX=0,this.panY=0,this.zoomDisplay=.5,this.unitSize=5,this.useGrid=!0,this.fullFOW=!1,this.fowOpacity=.3,this.fowLOS=!1,this.locationName="",this.visionSources=[],this.annotations=[],this.movementblockers=[],this.ownedtokens=[],this._activeTokens=[],this.drawTEContour=!1,this.visionRangeMin=1640,this.visionRangeMax=3281,this.clipboard=[],this.labels={},this.filterNoLabel=!1,this.labelFilters=[],this.showUI=!0,this.selectionHelperID=null}get selectedLayer(){return this.layers[this.selectedLayerIndex]}get zoomFactor(){return vt(this.zoomDisplay)}get locationOptions(){return{panX:yt.panX,panY:yt.panY,zoomFactor:yt.zoomFactor}}getFogColour(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=it()(yt.fowColour);return yt.IS_DM?t.setAlpha(e?1:yt.fowOpacity):t.setAlpha(1),t.toRgbString()}get activeTokens(){return 0===this._activeTokens.length?this.ownedtokens:this._activeTokens}setSelectionHelperId(e){this.selectionHelperID=e}setFakePlayer(e){this.FAKE_PLAYER=e,this.IS_DM=!e,xt.invalidate()}setZoomDisplay(e){e!==this.zoomDisplay&&(e<0&&(e=0),e>1&&(e=1),this.zoomDisplay=e,xt.invalidate())}setBoardInitialized(e){this.boardInitialized=e}toggleUnlabeledFilter(){this.filterNoLabel=!this.filterNoLabel}addLabel(e){s["default"].set(this.labels,e.uuid,e)}setLabelFilters(e){this.labelFilters=e}setLabelVisibility(e){e.uuid in this.labels&&(this.labels[e.uuid].visible=e.visible)}deleteLabel(e){if(!(e.uuid in this.labels))return;const t=this.labels[e.uuid],i=new Set;for(const s of xt.UUIDMap.values()){const e=s.labels.indexOf(t);e>=0&&(s.labels.splice(e,1),i.add(s.layer))}for(const s of i)xt.getLayer(s).invalidate(!1);s["default"].delete(this.labels,e.uuid)}setDM(e){this.IS_DM=e}setUsername(e){this.username=e}setRoomName(e){this.roomName=e}setRoomCreator(e){this.roomCreator=e}setInvitationCode(e){this.invitationCode=e}addLayer(e){this.layers.push(e),-1===this.selectedLayerIndex&&(this.selectedLayerIndex=this.layers.indexOf(e))}selectLayer(e){const t=this.layers.indexOf(e.name);t>=0&&(this.selectedLayerIndex=t),e.sync&&Xe.emit("Client.ActiveLayer.Set",e.name)}newNote(e){this.notes.push(e.note),e.sync&&Xe.emit("Note.New",e.note)}setAssets(e){this.assets=e}setLocations(e){this.locations=e}resetLayerInfo(){this.layers=[],this.selectedLayerIndex=-1}updateZoom(e){if(e.newZoomDisplay===this.zoomDisplay)return;e.newZoomDisplay<0&&(e.newZoomDisplay=0),e.newZoomDisplay>1&&(e.newZoomDisplay=1);const t=nt(e.zoomLocation);this.zoomDisplay=e.newZoomDisplay;const i=ht(t),s=i.subtract(e.zoomLocation);this.panX+=s.x,this.panY+=s.y,xt.invalidate(),st(this.locationOptions)}setGridColour(e){this.gridColour=e.colour,xt.getGridLayer().drawGrid(),e.sync&&Xe.emit("Client.Options.Set",{gridColour:e.colour})}setFOWColour(e){this.fowColour=e.colour,xt.invalidate(),e.sync&&Xe.emit("Client.Options.Set",{fowColour:e.colour})}setRulerColour(e){this.rulerColour=e.colour,e.sync&&Xe.emit("Client.Options.Set",{rulerColour:e.colour})}setPanX(e){this.panX=e}setPanY(e){this.panY=e}increasePanX(e){this.panX+=e}increasePanY(e){this.panY+=e}setUnitSize(e){this.unitSize!==e.unitSize&&e.unitSize>0&&e.unitSize<1/0&&(this.unitSize=e.unitSize,xt.invalidate(),e.sync&&Xe.emit("Location.Options.Set",{unit_size:e.unitSize}))}setUseGrid(e){if(this.useGrid!==e.useGrid){this.useGrid=e.useGrid;const t=xt.getGridLayer();e.useGrid?t.canvas.style.display="block":t.canvas.style.display="none",e.sync&&Xe.emit("Location.Options.Set",{use_grid:e.useGrid})}}setGridSize(e){if(this.gridSize!==e.gridSize&&e.gridSize>0){this.gridSize=e.gridSize;const t=xt.getGridLayer();void 0!==t&&t.drawGrid(),e.sync&&Xe.emit("Gridsize.Set",e.gridSize)}}setVisionRangeMin(e){this.visionRangeMin=e.value,xt.invalidateLight(),e.sync&&Xe.emit("Location.Options.Set",{vision_min_range:e.value})}setVisionRangeMax(e){this.visionRangeMax=Math.max(e.value,this.visionRangeMin),xt.invalidateLight(),e.sync&&Xe.emit("Location.Options.Set",{vision_max_range:this.visionRangeMax})}setFullFOW(e){this.fullFOW!==e.fullFOW&&(this.fullFOW=e.fullFOW,xt.invalidateLight(),e.sync&&Xe.emit("Location.Options.Set",{full_fow:e.fullFOW}))}setFOWOpacity(e){this.fowOpacity=e.fowOpacity,xt.invalidateLight(),e.sync&&Xe.emit("Location.Options.Set",{fow_opacity:e.fowOpacity})}setLineOfSight(e){this.fowLOS!==e.fowLOS&&(this.fowLOS=e.fowLOS,xt.invalidate(),e.sync&&Xe.emit("Location.Options.Set",{fow_los:e.fowLOS}))}setLocationName(e){this.locationName=e}updateNote(e){const t=this.notes.find(t=>t.uuid===e.note.uuid);void 0!==t&&(t.title=e.note.title,t.text=e.note.text,e.sync&&Xe.emit("Note.Update",t))}removeNote(e){this.notes=this.notes.filter(t=>t.uuid!==e.note.uuid),e.sync&&Xe.emit("Note.Remove",e.note.uuid)}toggleUI(){this.showUI=!this.showUI}setClipboard(e){this.clipboard=e}setActiveTokens(e){this._activeTokens=e,xt.invalidateLight()}addActiveToken(e){this._activeTokens.push(e),xt.invalidateLight()}removeActiveToken(e){0===this._activeTokens.length&&(this._activeTokens=[...this.ownedtokens]),this._activeTokens.splice(this._activeTokens.indexOf(e),1),xt.invalidateLight()}setPlayers(e){this.players=e}addPlayer(e){this.players.push(e)}kickPlayer(e){this.players=this.players.filter(t=>t.id!==e)}setIsLocked(e){this.isLocked=e.isLocked,e.sync&&Xe.emit("Room.Info.Set.Locked",this.isLocked)}clear(){this.context.state.visionSources=[],this.context.state.ownedtokens=[],this.context.state.annotations=[],this.context.state.movementblockers=[],this.context.state.notes=[]}};v["a"]([I["c"]],bt.prototype,"setSelectionHelperId",null),v["a"]([I["c"]],bt.prototype,"setFakePlayer",null),v["a"]([I["c"]],bt.prototype,"setZoomDisplay",null),v["a"]([I["c"]],bt.prototype,"setBoardInitialized",null),v["a"]([I["c"]],bt.prototype,"toggleUnlabeledFilter",null),v["a"]([I["c"]],bt.prototype,"addLabel",null),v["a"]([I["c"]],bt.prototype,"setLabelFilters",null),v["a"]([I["c"]],bt.prototype,"setLabelVisibility",null),v["a"]([I["c"]],bt.prototype,"deleteLabel",null),v["a"]([I["c"]],bt.prototype,"setDM",null),v["a"]([I["c"]],bt.prototype,"setUsername",null),v["a"]([I["c"]],bt.prototype,"setRoomName",null),v["a"]([I["c"]],bt.prototype,"setRoomCreator",null),v["a"]([I["c"]],bt.prototype,"setInvitationCode",null),v["a"]([I["c"]],bt.prototype,"addLayer",null),v["a"]([I["c"]],bt.prototype,"selectLayer",null),v["a"]([I["c"]],bt.prototype,"newNote",null),v["a"]([I["c"]],bt.prototype,"setAssets",null),v["a"]([I["c"]],bt.prototype,"setLocations",null),v["a"]([I["c"]],bt.prototype,"resetLayerInfo",null),v["a"]([I["c"]],bt.prototype,"updateZoom",null),v["a"]([I["c"]],bt.prototype,"setGridColour",null),v["a"]([I["c"]],bt.prototype,"setFOWColour",null),v["a"]([I["c"]],bt.prototype,"setRulerColour",null),v["a"]([I["c"]],bt.prototype,"setPanX",null),v["a"]([I["c"]],bt.prototype,"setPanY",null),v["a"]([I["c"]],bt.prototype,"increasePanX",null),v["a"]([I["c"]],bt.prototype,"increasePanY",null),v["a"]([I["c"]],bt.prototype,"setUnitSize",null),v["a"]([I["c"]],bt.prototype,"setUseGrid",null),v["a"]([I["c"]],bt.prototype,"setGridSize",null),v["a"]([I["c"]],bt.prototype,"setVisionRangeMin",null),v["a"]([I["c"]],bt.prototype,"setVisionRangeMax",null),v["a"]([I["c"]],bt.prototype,"setFullFOW",null),v["a"]([I["c"]],bt.prototype,"setFOWOpacity",null),v["a"]([I["c"]],bt.prototype,"setLineOfSight",null),v["a"]([I["c"]],bt.prototype,"setLocationName",null),v["a"]([I["c"]],bt.prototype,"updateNote",null),v["a"]([I["c"]],bt.prototype,"removeNote",null),v["a"]([I["c"]],bt.prototype,"toggleUI",null),v["a"]([I["c"]],bt.prototype,"setClipboard",null),v["a"]([I["c"]],bt.prototype,"setActiveTokens",null),v["a"]([I["c"]],bt.prototype,"addActiveToken",null),v["a"]([I["c"]],bt.prototype,"removeActiveToken",null),v["a"]([I["c"]],bt.prototype,"setPlayers",null),v["a"]([I["c"]],bt.prototype,"addPlayer",null),v["a"]([I["c"]],bt.prototype,"kickPlayer",null),v["a"]([I["c"]],bt.prototype,"setIsLocked",null),v["a"]([I["a"]],bt.prototype,"clear",null),bt=v["a"]([Object(I["b"])({dynamic:!0,store:T,name:"game",namespaced:!0})],bt);const yt=Object(I["e"])(bt);class wt{constructor(){this.layers=[],this.width=window.innerWidth,this.height=window.innerHeight,this.UUIDMap=new Map,this.interval=30,this.drawLoop=()=>{for(let e=this.layers.length-1;e>=0;e--)this.layers[e].draw();requestAnimationFrame(this.drawLoop)},requestAnimationFrame(this.drawLoop)}reset(){this.layers=[],this.UUIDMap=new Map}setWidth(e){this.width=e;for(const t of this.layers)t.canvas.width=e,t.width=e}setHeight(e){this.height=e;for(const t of this.layers)t.canvas.height=e,t.height=e}addLayer(e){this.layers.push(e),(yt.IS_DM||e.playerEditable)&&e.selectable&&yt.addLayer(e.name)}hasLayer(e){return this.layers.some(t=>t.name===e)}getLayer(e){e=void 0===e?yt.selectedLayer:e;for(const t of this.layers)if(t.name===e)return t}selectLayer(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!1;for(const s of this.layers)s.selectable&&(i&&"fow"!==s.name?s.ctx.globalAlpha=.3:s.ctx.globalAlpha=1,e===s.name&&(yt.selectLayer({name:e,sync:t}),i=!0),s.clearSelection(),s.invalidate(!0))}getGridLayer(){return this.getLayer("grid")}hasSelection(){const e=this.getSelection();return void 0!==e&&e.length>0}getSelection(){const e=this.getLayer();if(void 0!==e)return e.selection}invalidate(){for(let e=this.layers.length-1;e>=0;e--)this.layers[e].invalidate(!0)}invalidateLight(){for(let e=this.layers.length-1;e>=0;e--)this.layers[e].isVisionLayer&&this.layers[e].invalidate(!0)}}const xt=new wt;window.lm=xt;class Ct{constructor(e,t,i){this.w=t,this.h=i,this.topLeft=e,this.topRight=new Qe(e.x+t,e.y),this.botRight=new Qe(e.x+t,e.y+i),this.botLeft=new Qe(e.x,e.y+i)}contains(e){return this.topLeft.x<=e.x&&this.topRight.x>=e.x&&this.topLeft.y<=e.y&&this.botLeft.y>=e.y}get points(){return 0===this.w||0===this.h?[[this.topLeft.x,this.topLeft.y]]:[[this.topLeft.x,this.topLeft.y],[this.botLeft.x,this.botLeft.y],[this.botRight.x,this.botRight.y],[this.topRight.x,this.topRight.y]]}offset(e){return new Ct(this.topLeft.add(e),this.w,this.h)}union(e){const t=Math.min(this.topLeft.x,e.topLeft.x),i=Math.max(this.topRight.x,e.topRight.x),s=Math.min(this.topLeft.y,e.topLeft.y),n=Math.max(this.botLeft.y,e.botLeft.y);return new Ct(new Qe(t,s),i-t,n-s)}getDiagCorner(e){return e?this.botRight:this.topLeft}intersectsWith(e){return!(e.topLeft.x>this.topRight.x||e.topRight.x<this.topLeft.x||e.topLeft.y>this.botLeft.y||e.botLeft.y<this.topLeft.y)}intersectsWithInner(e){return!(e.topLeft.x>=this.topRight.x||e.topRight.x<=this.topLeft.x||e.topLeft.y>=this.botLeft.y||e.botLeft.y<=this.topLeft.y)}intersectP(e,t,i){let s=t.x*(this.getDiagCorner(i[0]).x-e.origin.x),n=t.x*(this.getDiagCorner(!i[0]).x-e.origin.x);const o=t.y*(this.getDiagCorner(i[1]).y-e.origin.y),r=t.y*(this.getDiagCorner(!i[1]).y-e.origin.y);return s>r||o>n?{hit:!1,min:s,max:n}:(o>s&&(s=o),r<n&&(n=r),{hit:s<e.tMax&&n>0,min:s,max:n})}center(){return this.topLeft.add(new Je(this.w/2,this.h/2))}getMaxExtent(){return this.w>this.h?0:1}visibleInCanvas(e){const t=!(ot(this.topLeft.x)>e.width||rt(this.topLeft.y)>e.height||ot(this.topRight.x)<0||rt(this.botRight.y)<0);return!!t}}var _t=i("3835");const St=e=>{const t=[];for(const i of e)t.push({uuid:i.uuid,visionSource:i.vision_source,visible:i.visible,name:i.name,value:i.value,dim:i.dim,colour:i.colour});return t},kt=e=>{const t=[];for(const i of e)t.push({uuid:i.uuid,vision_source:i.visionSource,visible:i.visible,name:i.name,value:i.value,dim:i.dim,colour:i.colour});return t};var Lt;i("55dd");function Et(e){return(e+2)%3}function It(e){return(e+1)%3}function Ot(e,t){const i=new ni(e,null);if(i.valid)do{const s=3-i.t.indexV(e)-i.ri,n=i.t.vertices[s];if(!n.infinite){if(n===t)return{includes:!0,vi:t,fr:i.t,i:i.ri};{const s=Pt(e.point,t.point,n.point);if(s===Zt.COLLINEAR&&Tt(e.point,n.point,t.point))return{includes:!0,vi:n,fr:i.t,i:i.ri}}}}while(i.next());return{includes:!1}}function Tt(e,t,i){let s,n;return Mt(0,e,i)===Zt.EQUAL?(s=Mt(1,e,t),n=Mt(1,t,i)):(s=Mt(0,e,t),n=Mt(0,t,i)),s===Zt.SMALLER&&n===Zt.SMALLER||s===Zt.LARGER&&n===Zt.LARGER}function Mt(e,t,i){return t[e]<i[e]?Zt.SMALLER:t[e]>i[e]?Zt.LARGER:Zt.EQUAL}function Pt(e,t,i){const s=e[0],n=e[1],o=t[0],r=t[1],a=i[0],l=i[1],c=o-s,h=r-n,u=a-s,d=l-n,p=Dt(c,h,u,d);let f=Math.abs(c),v=Math.abs(h);const g=Math.abs(u),m=Math.abs(d);if(f<g&&(f=g),v<m&&(v=m),f>v){var b=[v,f];f=b[0],v=b[1]}if(f<2e-162&&0===f)return Zt.ZERO;if(v<1e153){const e=Number.EPSILON*f*v;if(p>e)return Zt.POSITIVE;if(p<-e)return Zt.NEGATIVE}return Zt.ZERO}function Dt(e,t,i,s){return e*s-t*i}function Nt(e,t,i){return Dt(t[0]-e[0],t[1]-e[1],i[0]-e[0],i[1]-e[1])<0}function At(e,t,i){if(!e.isInfinite())return Rt(e.vertices[0].point,e.vertices[1].point,e.vertices[2].point,t,i);throw new Error("SSS")}function Rt(e,t,i,s,n){const o=Ft(e,t,i,s);if(o!==Zt.ON_ORIENTED_BOUNDARY||!n)return o;const r=[e,t,i,s];r.sort((e,t)=>e[0]-t[0]||e[1]-t[1]);for(const a of r.reverse()){if(a===s)return Zt.ON_NEGATIVE_SIDE;let n=Pt(e,t,s);if(a===i&&n!==Zt.COLLINEAR)return n;if(n=Pt(e,s,i),a===t&&n!==Zt.COLLINEAR)return n;if(n=Pt(s,t,i),a===e&&n!==Zt.COLLINEAR)return n}return Zt.ON_NEGATIVE_SIDE}function Vt(e,t){return e[0]===t[0]&&e[1]===t[1]}function $t(e,t){return e[0]<t[0]||e[0]===t[0]&&e[1]<t[1]}function Ut(e,t){return $t(e,t)?Zt.SMALLER:Vt(e,t)?Zt.EQUAL:Zt.LARGER}function Ft(e,t,i,s){const n=t[0]-e[0],o=t[1]-e[1],r=i[0]-e[0],a=i[1]-e[1],l=s[0]-e[0],c=s[1]-e[1],h=s[0]-t[0],u=s[1]-t[1],d=i[0]-t[0],p=i[1]-t[1],f=Dt(n*c-o*l,l*h+c*u,n*a-o*r,r*d+a*p);let v=Math.abs(n),g=Math.abs(o);const m=Math.abs(r),b=Math.abs(a),y=Math.abs(h),w=Math.abs(u),x=Math.abs(l),C=Math.abs(c),_=Math.abs(d),S=Math.abs(p);if(v<m&&(v=m),v<x&&(v=x),v<y&&(v=y),v<_&&(v=_),g<b&&(g=b),g<C&&(g=C),g<w&&(g=w),g<S&&(g=S),v>g){var k=[g,v];v=k[0],g=k[1]}if(v<1e-73&&0===v)return Zt.ON_ORIENTED_BOUNDARY;if(g<1e76){const e=Number.EPSILON*v*g*(g*g);if(f>e)return Zt.ON_POSITIVE_SIDE;if(f<-e)return Zt.ON_NEGATIVE_SIDE}return Zt.ZERO}function zt(e,t,i,s){switch(Pt(e,t,i)){case Zt.LEFT_TURN:return Pt(i,s,t)!==Zt.RIGHT_TURN;case Zt.RIGHT_TURN:return Pt(i,s,t)!==Zt.LEFT_TURN;case Zt.COLLINEAR:return!0}}function Bt(e,t,i,s){switch(Pt(e,t,i)){case Zt.LEFT_TURN:return Pt(e,t,s)!==Zt.LEFT_TURN;case Zt.RIGHT_TURN:return Pt(e,t,s)!==Zt.RIGHT_TURN;case Zt.COLLINEAR:return!0}}function Ht(e,t,i,s){const n=jt(e,t,i,s);switch(n.intersectionType){case Lt.POINT:return n.point;case Lt.NO_INTERSECTION:return null}throw new Error("sdfgighowen")}function Gt(e,t){if(e[0]===t[0])return[1,0,-e[0]];if(e[1]===t[1])return[0,1,-e[1]];const i=t[0]-e[0],s=t[1]-e[1];return[-s,i,-i*e[1]+s*e[0]]}function jt(e,t,i,s){if(!Xt(e,t,i,s))return{intersectionType:Lt.NO_INTERSECTION,point:null};const n=Gt(e,t),o=Gt(i,s),r=Wt(n,o);switch(r.intersectionType){case Lt.POINT:return r}throw new Error("gzseuihgpib")}function Wt(e,t){const i=e[0]*t[1]-t[0]*e[1],s=e[1]*t[2]-t[1]*e[2],n=t[0]*e[2]-e[0]*t[2];return{intersectionType:Lt.POINT,point:[s/i,n/i]}}function Xt(e,t,i,s){if($t(e,t)){if($t(i,s)){if($t(t,i)||$t(s,e))return!1}else if($t(t,s)||$t(i,e))return!1}else if($t(i,s)){if($t(e,i)||$t(s,t))return!1}else if($t(e,s)||$t(i,t))return!1;if($t(e,t))if($t(i,s))switch(Ut(e,i)){case Zt.SMALLER:switch(Ut(t,i)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(t,s)){case Zt.SMALLER:return zt(e,t,i,s);case Zt.EQUAL:return!0;default:return Bt(e,t,i,s)}}case Zt.EQUAL:return!0;default:switch(Ut(s,e)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(s,t)){case Zt.SMALLER:return zt(i,s,e,t);case Zt.EQUAL:return!0;default:return Bt(i,s,e,t)}}}else switch(Ut(e,s)){case Zt.SMALLER:switch(Ut(t,s)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(t,i)){case Zt.SMALLER:return zt(e,t,s,i);case Zt.EQUAL:return!0;default:return Bt(e,t,s,i)}}case Zt.EQUAL:return!0;default:switch(Ut(i,e)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(i,t)){case Zt.SMALLER:return zt(s,i,e,t);case Zt.EQUAL:return!0;default:return Bt(s,i,e,t)}}}else if($t(i,s))switch(Ut(t,i)){case Zt.SMALLER:switch(Ut(e,i)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(e,s)){case Zt.SMALLER:return zt(t,e,i,s);case Zt.EQUAL:return!0;default:return Bt(t,e,i,s)}}case Zt.EQUAL:return!0;default:switch(Ut(s,t)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(s,e)){case Zt.SMALLER:return zt(i,s,t,e);case Zt.EQUAL:return!0;default:return Bt(i,s,t,e)}}}else switch(Ut(t,s)){case Zt.SMALLER:switch(Ut(e,s)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(e,i)){case Zt.SMALLER:return zt(t,e,s,i);case Zt.EQUAL:return!0;default:return Bt(t,e,s,i)}}case Zt.EQUAL:return!0;default:switch(Ut(i,t)){case Zt.SMALLER:return!1;case Zt.EQUAL:return!0;default:switch(Ut(i,e)){case Zt.SMALLER:return zt(s,i,t,e);case Zt.EQUAL:return!0;default:return Bt(s,i,t,e)}}}}function Yt(e){if(e!==e)return e;if(e===-1/0)return-Number.MAX_VALUE;if(e===1/0)return 1/0;if(e===+Number.MAX_VALUE)return 1/0;let t=e*(e<0?1-Number.EPSILON/2:1+Number.EPSILON);t===e&&(t=Number.MIN_VALUE*Number.EPSILON>0?e+Number.MIN_VALUE*Number.EPSILON:e+Number.MIN_VALUE),t===1/0&&(t=+Number.MAX_VALUE);const i=e+(t-e)/2;e<i&&i<t&&(t=i);const s=(t+e)/2;return e<s&&s<t&&(t=s),0===t?-0:t}function Kt(e){return e<0?Yt(e)-e:e+Yt(-e)}(function(e){e[e["NO_INTERSECTION"]=0]="NO_INTERSECTION",e[e["POINT"]=1]="POINT",e[e["SEGMENT"]=2]="SEGMENT"})(Lt||(Lt={}));const qt=-Infinity;let Qt;var Zt,Jt,ei;function ti(){return[qt,qt]}(function(e){e[e["NEGATIVE"]=-1]="NEGATIVE",e[e["ZERO"]=0]="ZERO",e[e["POSITIVE"]=1]="POSITIVE",e[e["RIGHT_TURN"]=-1]="RIGHT_TURN",e[e["LEFT_TURN"]=1]="LEFT_TURN",e[e["SMALLER"]=-1]="SMALLER",e[e["EQUAL"]=0]="EQUAL",e[e["LARGER"]=1]="LARGER",e[e["CLOCKWISE"]=-1]="CLOCKWISE",e[e["COUNTERCLOCKWISE"]=1]="COUNTERCLOCKWISE",e[e["COLLINEAR"]=0]="COLLINEAR",e[e["COPLANAR"]=0]="COPLANAR",e[e["DEGENERATE"]=0]="DEGENERATE",e[e["ON_NEGATIVE_SIDE"]=-1]="ON_NEGATIVE_SIDE",e[e["ON_ORIENTED_BOUNDARY"]=0]="ON_ORIENTED_BOUNDARY",e[e["ON_POSITIVE_SIDE"]=1]="ON_POSITIVE_SIDE"})(Zt||(Zt={})),function(e){e[e["UNDEFINED"]=-1]="UNDEFINED",e[e["VERTEX_VERTEX"]=0]="VERTEX_VERTEX",e[e["VERTEX_EDGE"]=1]="VERTEX_EDGE",e[e["EDGE_VERTEX"]=2]="EDGE_VERTEX",e[e["EDGE_EDGE"]=3]="EDGE_EDGE"}(Jt||(Jt={}));class ii{constructor(){this.vertices=[],this.neighbours=[null,null,null],this.constraints=[!1,!1,!1],this.uid=ii._counter++;for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.vertices=t}from(e){return this.vertices=e.vertices.slice(0,e.vertices.length),this.neighbours=e.neighbours.slice(0,e.neighbours.length),this.constraints=e.constraints.slice(0,e.constraints.length),this}get center(){return[(this.vertices[0].point[0]+this.vertices[1].point[0]+this.vertices[2].point[0])/3,(this.vertices[0].point[1]+this.vertices[1].point[1]+this.vertices[2].point[1])/3]}get dimension(){return this.vertices.length-1}addVertex(e){void 0===e&&console.log("UNDEFINED HIERE"),this.vertices.push(e),e.triangle=this}isConstrained(e){return this.constraints[e]}reorient(){this.vertices=[this.vertices[1],this.vertices[0],this.vertices[2]].slice(0,this.vertices.length),this.neighbours=[this.neighbours[1],this.neighbours[0],this.neighbours[2]],this.constraints=[this.constraints[1],this.constraints[0],this.constraints[2]]}hasVertex(e){return this.vertices.includes(e)}indexV(e){return this.vertices.indexOf(e)}indexT(e){return this.neighbours.indexOf(e)}isInfinite(e){return void 0===e?this.vertices.some(e=>e.infinite):this.vertices[It(e)].infinite||this.vertices[Et(e)].infinite}contains(e){const t=-this.vertices[1].point[1]*this.vertices[2].point[0]+this.vertices[0].point[1]*(-this.vertices[1].point[0]+this.vertices[2].point[0])+this.vertices[0].point[0]*(this.vertices[1].point[1]-this.vertices[2].point[1])+this.vertices[1].point[0]*this.vertices[2].point[1],i=t<0?-1:1,s=(this.vertices[0].point[1]*this.vertices[2].point[0]-this.vertices[0].point[0]*this.vertices[2].point[1]+(this.vertices[2].point[1]-this.vertices[0].point[1])*e[0]+(this.vertices[0].point[0]-this.vertices[2].point[0])*e[1])*i;if(s<0)return!1;const n=(this.vertices[0].point[0]*this.vertices[1].point[1]-this.vertices[0].point[1]*this.vertices[1].point[0]+(this.vertices[0].point[1]-this.vertices[1].point[1])*e[0]+(this.vertices[1].point[0]-this.vertices[0].point[0])*e[1])*i;return n>0&&s+n<t*i}cwPermute(){this.vertices.push(this.vertices.shift()),this.neighbours.push(this.neighbours.shift()),this.constraints.push(this.constraints.shift())}ccwPermute(){this.vertices.unshift(this.vertices.pop()),this.neighbours.unshift(this.neighbours.pop()),this.constraints.unshift(this.constraints.pop())}}ii._counter=0;class si{constructor(e){this.infinite=!1,this.shapes=new Set,this._point=e}get point(){return this._point}set point(e){this._point=e,this.infinite=!1}getIncidentFaces(){const e=[],t=new ri(this,null);do{e.push(t.t)}while(t.next());return e}*getIncidentEdges(){const e=new ni(this,null);do{yield new li(e.t,e.ri)}while(e.valid&&e.next())}}class ni{constructor(e,t){if(this.v=e,this.t=t,null===e?this.t=null:null===t&&(this.t=e.triangle),null==this.t||this.t.dimension<1)this.ri=0,this.v=null,this.t=null;else{const t=this.t.indexV(e);2===this.t.dimension?this.ri=It(t):this.ri=2}this._ri=this.ri,this._v=this.v,this._t=this.t}get valid(){return null!==this.t&&null!==this.v}next(){let e=this.t.indexV(this.v);return 1===this.t.dimension?this.t=this.t.neighbours[0===e?1:0]:(this.t=this.t.neighbours[It(e)],e=this.t.indexV(this.v),this.ri=It(e)),this.ri!==this._ri||this.v!==this._v||this.t!==this._t}}class oi{constructor(e){if(this.i=0,this.edge=new li,this._es=0,this.tds=e,this.edge.second=0,e.dimension<=0)this.pos=null;else{this.pos=e.triangles[0],1===e.dimension&&(this.edge.second=2);while(null!==this.pos&&!this.associatedEdge())throw new Error("[poi");1===e.dimension&&(this._es=2)}}get valid(){return(null!==this.pos||this._es!==this.edge.second)&&this.pos.isInfinite(this.edge.second)}next(){do{this.increment()}while(null!==this.pos&&!this.associatedEdge())}collect(){return this.edge.first=this.pos,this.edge}associatedEdge(){return 1===this.tds.dimension||this.tds.triangles.indexOf(this.pos)<this.tds.triangles.indexOf(this.pos.neighbours[this.edge.second])}increment(){1===this.tds.dimension?(this.i++,this.tds.triangles.length<=this.i?this.pos=null:this.pos=this.tds.triangles[this.i]):2===this.edge.second?(this.edge.second=0,this.i++,this.tds.triangles.length<=this.i?this.pos=null:this.pos=this.tds.triangles[this.i]):this.edge.second++}}class ri{constructor(e,t){this.v=e,this.t=t,null===e?this.t=null:null===t&&(this.t=e.triangle),(null==this.t||this.t.dimension<2)&&(this.v=null,this.t=null),this._v=this.v,this._t=this.t}get valid(){return null!==this.t&&null!==this.v}get done(){return this.v===this._v&&this.t===this._t}setDone(){this._v=this.v,this._t=this.t}prev(){const e=this.t.indexV(this.v);this.t=this.t.neighbours[Et(e)]}next(){const e=this.t.indexV(this.v);return this.t=this.t.neighbours[It(e)],!this.done}}class ai{constructor(e,t,i){this.i=0,this.pos=null,this.s=Jt.UNDEFINED,this._tr=t,this.p=e.point,this.q=i;const s=new ri(e,null);let n=s.t.indexV(e),o=s.t.vertices[Et(n)];while(e===Qt||Pt(this.p,this.q,o.point)!==Zt.LEFT_TURN)if(s.next(),n=s.t.indexV(e),o=s.t.vertices[Et(n)],!s.valid)return;let r=s.t.vertices[It(n)],a=Zt.RIGHT_TURN;while(r!==Qt&&(a=Pt(this.p,this.q,r.point))===Zt.LEFT_TURN)s.prev(),n=s.t.indexV(e),r=s.t.vertices[It(n)];if(n=s.t.indexV(e),o=s.t.vertices[Et(n)],r===Qt)switch(s.prev(),n=s.t.indexV(e),r=s.t.vertices[It(n)],a=Pt(this.p,this.q,r.point),a){case Zt.RIGHT_TURN:case Zt.COLLINEAR:s.next(),n=s.t.indexV(Qt),this.pos=s.t,this.s=Jt.VERTEX_VERTEX,this.i=n;break;case Zt.LEFT_TURN:break}else a===Zt.COLLINEAR?(this.pos=s.t,this.s=Jt.VERTEX_VERTEX,this.i=It(n)):(this.pos=s.t,this.s=Jt.VERTEX_EDGE,this.i=n)}next(){this.increment()}increment(){let e;if(this.s===Jt.VERTEX_VERTEX||this.s===Jt.EDGE_VERTEX){do{const t=this.pos.neighbours[Et(this.i)];if(this.i=t.indexT(this.pos),this.pos=t,this.pos.vertices[this.i]===Qt){e=Zt.COLLINEAR,this.i=Et(this.i);break}e=Pt(this.p,this.q,this.pos.vertices[this.i].point),this.i=Et(this.i)}while(e===Zt.LEFT_TURN);e===Zt.COLLINEAR?(this.s=Jt.VERTEX_VERTEX,this.i=It(this.i)):this.s=Jt.VERTEX_EDGE}else{const t=this.pos.neighbours[this.i],i=t.indexT(this.pos);switch(this.pos=t,e=this.pos.vertices[i]===Qt?Zt.COLLINEAR:Pt(this.p,this.q,this.pos.vertices[i].point),e){case Zt.LEFT_TURN:this.s=Jt.EDGE_EDGE,this.i=It(i);break;case Zt.RIGHT_TURN:this.s=Jt.EDGE_EDGE,this.i=Et(i);break;default:this.s=Jt.EDGE_VERTEX,this.i=i}}}}class li{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.first=null,this.second=0,this.first=e,this.second=t}toString(){return`${this.first.vertices[1===this.second?0:1].point} - ${this.first.vertices[1===this.second?2:1].point}`}}(function(e){e[e["VERTEX"]=0]="VERTEX",e[e["EDGE"]=1]="EDGE",e[e["FACE"]=2]="FACE",e[e["OUTSIDE_CONVEX_HULL"]=3]="OUTSIDE_CONVEX_HULL",e[e["OUTSIDE_AFFINE_HULL"]=4]="OUTSIDE_AFFINE_HULL"})(ei||(ei={}));class ci{constructor(){this.dimension=-1,this.vertices=[],this.triangles=[],this._infinite=this.createVertex(),Qt=this._infinite;const e=new ii;e.addVertex(this._infinite),this.triangles.push(e)}createVertex(){const e=new si(ti());return e.infinite=!0,this.vertices.push(e),e}deleteVertex(e){this.vertices=this.vertices.filter(t=>t!==e)}createTriangle(e,t,i,s,n,o){const r=new ii(e,t,i);return r.neighbours[0]=s,r.neighbours[1]=n,r.neighbours[2]=o,this.triangles.push(r),r}createTriangle2(e,t,i,s){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const r=null===n||null===o?i.vertices[It(s)]:n.vertices[Et(o)],a=new ii(e.vertices[Et(t)],i.vertices[Et(s)],r);return e.neighbours[t]=a,i.neighbours[s]=a,null!==n&&null!==o&&(n.neighbours[o]=a),a.neighbours[0]=i,null!==n&&(a.neighbours[1]=n),a.neighbours[2]=e,this.triangles.push(a),a}createTriangle3(e,t,i){const s=new ii(e.vertices[Et(t)],e.vertices[It(t)],i);return s.neighbours[2]=e,e.neighbours[t]=s,this.triangles.push(s),s}deleteTriangle(e){this.triangles=this.triangles.filter(t=>t!==e)}setAdjacency(e,t,i,s){e.neighbours[t]=i,i.neighbours[s]=e}get finiteVertex(){return this.vertices[1]}get finiteEdge(){if(this.dimension<1)throw new Error("aspo");const e=new oi(this);while(e.valid)e.next();return e.collect()}numberOfEdges(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=0,i=0;const s=new oi(this);while(s.valid)s.next(),s.collect();s.collect();do{i++,s.edge.first.constraints[s.edge.second]&&t++;do{s.next(),s.collect()}while(s.valid)}while(null!==s.pos);return e?t:i}numberOfVertices(e){return this.vertices.length-(e?0:1)}insertDimUp(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new si,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.createVertex();let s,n;switch(this.dimension++,this.dimension){case 0:s=this.triangles[0],n=new ii(i),this.triangles.push(n),this.setAdjacency(s,0,n,0),i.triangle=n;break;case 1:case 2:{const o=[],r=this.triangles.slice(0,this.triangles.length);for(const t of r){const s=(new ii).from(t);this.triangles.push(s),t.vertices[this.dimension]=i,s.vertices[this.dimension]=e,this.setAdjacency(t,this.dimension,s,this.dimension),t.vertices.includes(e)&&o.push(s)}for(const e of r){const t=e.neighbours[this.dimension];for(let i=0;i<this.dimension;++i)t.neighbours[i]=e.neighbours[i].neighbours[this.dimension]}let a=0;if(1===this.dimension)t?(r[a].reorient(),a++,r[a].neighbours[1].reorient()):(r[a].neighbours[1].reorient(),a++,r[a].reorient());else for(const e of r)t?e.neighbours[2].reorient():e.reorient();for(const t of o){let i=1;t.vertices[0]===e&&(i=0),s=t.neighbours[this.dimension];const o=this.mirrorIndex(t,this.dimension);n=t.neighbours[i];const r=this.mirrorIndex(t,i);this.setAdjacency(s,o,n,r),this.deleteTriangle(t)}i.triangle=r[0];break}default:throw new Error("Dimension unknown")}return i}mirrorIndex(e,t){if(1===e.dimension){const i=e.neighbours[t].indexV(e.vertices[0===t?1:0]);return 0===i?1:0}return It(e.neighbours[t].indexV(e.vertices[It(t)]))}insertInFace(e){const t=this.createVertex(),i=e.vertices[0],s=e.vertices[1],n=e.vertices[2],o=e.neighbours[1],r=e.neighbours[2],a=this.createTriangle(i,t,n,e,o,null),l=this.createTriangle(i,s,t,e,null,r);if(this.setAdjacency(a,2,l,1),null!==o){const t=this.mirrorIndex(e,1);o.neighbours[t]=a}if(null!==r){const t=this.mirrorIndex(e,2);r.neighbours[t]=l}return e.vertices[0]=t,e.neighbours[1]=a,e.neighbours[2]=l,i.triangle===e&&(i.triangle=l),t.triangle=e,t}flip(e,t){const i=e.neighbours[t],s=this.mirrorIndex(e,t),n=e.vertices[Et(t)],o=e.vertices[It(t)],r=e.neighbours[It(t)],a=this.mirrorIndex(e,It(t)),l=i.neighbours[It(s)],c=this.mirrorIndex(i,It(s));e.vertices[Et(t)]=i.vertices[s],i.vertices[Et(s)]=e.vertices[t],this.setAdjacency(e,t,l,c),this.setAdjacency(e,It(t),i,It(s)),this.setAdjacency(i,s,r,a),n.triangle===e&&(n.triangle=i),o.triangle===i&&(o.triangle=e)}insertInEdge(e,t){let i;if(1===this.dimension){i=this.createVertex();const t=e.neighbours[0],s=e.vertices[1],n=this.createTriangle(i,s,null,t,e,null);e.vertices[1]=i,e.neighbours[0]=n,t.neighbours[1]=n,i.triangle=n,s.triangle=t}else{const s=e.neighbours[t],n=this.mirrorIndex(e,t);i=this.insertInFace(e),this.flip(s,n)}return i}makeHole(e,t){const i=[];let s,n,o,r,a;const l=new ri(e,null);do{s=l.t,l.next(),o=s.indexV(e),n=s.neighbours[o],r=n.indexT(s),a=s.vertices[Et(o)],a.triangle=n,a=s.vertices[It(o)],a.triangle=n,n.neighbours[r]=null,t.push([n,r]),i.push(s)}while(!l.done);for(const c of i)this.deleteTriangle(c)}fillHoleDelaunay(e){let t,i,s,n,o,r;const a=[];a.push(e);while(a.length>0){const e=a[0];let l;if(3===e.length){l=0,t=e[l][0],n=e[l][1],i=e[++l][0],o=e[l][1],s=e[++l][0],r=e[l][1],this.createTriangle2(t,n,i,o,s,r),a.shift();continue}let c=!1;while(!c)i=e[0][0],o=e[0][1],i.vertices[Et(o)].infinite||i.vertices[It(o)].infinite?e.push(e.shift()):c=!0;i=e[0][0],o=e[0][1],e.shift();const h=i.vertices[Et(o)],u=i.vertices[It(o)];let d,p=this._infinite;const f=h.point,v=u.point;l=0;let g,m=0;while(l!==e.length-1){s=e[l][0],r=e[l][1];const t=s.vertices[It(r)];if(t.infinite&&p.infinite)m=l;else{const e=t.point;Pt(f,v,e)===Zt.COUNTERCLOCKWISE&&(p.infinite?(p=t,d=t,m=l):Rt(f,v,d.point,e,!0)===Zt.ON_POSITIVE_SIDE&&(p=t,d=t,m=l))}l++}if(s=e[0][0],r=e[0][1],s.vertices[It(r)]===p)g=this.createTriangle2(i,o,s,r),e.shift(),e.unshift([g,1]);else{s=e[e.length-1][0],r=e[e.length-1][1];const t=s.indexV(p);if(t>=0&&t===Et(r))g=this.createTriangle2(s,r,i,o),e.pop(),e.push([g,1]);else{g=this.createTriangle3(i,o,p);const t=[];++m;while(e[0]!==e[m--])t.push(e.shift());e.unshift([g,1]),t.unshift([g,0]),a.unshift(t)}}}}removeDimDown(e){let t;switch(this.dimension){case-1:this.deleteTriangle(e.triangle);break;case 0:t=e.triangle,t.neighbours[0].neighbours[0]=null,this.deleteTriangle(e.triangle);break;case 1:case 2:{const t=[],i=[];for(const s of this.triangles)s.hasVertex(e)?i.push(s):t.push(s);for(const s of i){const t=s.indexV(e);1===this.dimension?(0===t&&s.reorient(),s.vertices[1]=null,s.neighbours[1]=null):(0===t?s.cwPermute():1===t&&s.ccwPermute(),s.vertices[2]=null,s.neighbours[2]=null),s.vertices[0].triangle=s}for(const e of t)this.deleteTriangle(e)}}this.deleteVertex(e),this.dimension--}}class hi{constructor(e){this.x1=e[0],this.y1=e[1],this.x2=e[0],this.y2=e[1]}dilate(e){this.x1-=e*Kt(this.x1),this.y1-=e*Kt(this.y1),this.x2+=e*Kt(this.x2),this.y2+=e*Kt(this.y2)}overlaps(e){return!(this.x2<e.x1||e.x2<this.x1)&&!(this.y2<e.y1||e.y2<this.y1)}}class ui{constructor(){this.tds=new ci}insertConstraint(e,t){const i=this.insert(e),s=this.insert(t);return i!==s&&this.insertConstraintV(i,s),{va:i,vb:s}}insertConstraintV(e,t){const i=[[e,t]];while(i.length>0){const e=i.pop(),t=Ot(e[0],e[1]);if(t.includes){this.markConstraint(t.fr,t.i),t.vi!==e[1]&&i.push([t.vi,e[1]]);continue}const s=this.findIntersectedFaces(e[0],e[1]);s.found?s.vi!==e[0]&&s.vi!==e[1]?(i.push([e[0],s.vi]),i.push([s.vi,e[1]])):i.push(e):(this.triangulateHole(s.intersectedFaces,s.listAB,s.listBA),s.vi!==e[1]&&i.push([s.vi,e[1]]))}}triangulateHole(e,t,i){const s=[];this.triangulateHole2(e,t,i,s),this.propagatingFlipE(s)}triangulateHole2(e,t,i,s){if(t.length>0){this.triangulateHalfHole(t,s),this.triangulateHalfHole(i,s);const n=t[0][0],o=i[0][0];n.neighbours[2]=o,o.neighbours[2]=n,n.constraints[2]=!0,o.constraints[2]=!0;while(e.length>0)this.tds.deleteTriangle(e.shift())}}triangulateHalfHole(e,t){let i,s,n=0;const o=()=>e[n],r=()=>e[i],a=o()[0].vertices[It(o()[1])];let l,c,h,u,d,p;i=n,++i;do{c=o()[0],d=o()[1],null!==c.neighbours[d]&&(l=c.neighbours[d],u=Et(l.indexV(c.vertices[Et(d)])),c=l.neighbours[u],d=this.tds.mirrorIndex(l,u)),h=r()[0],p=r()[1],null!==h.neighbours[p]&&(l=h.neighbours[p],u=Et(l.indexV(h.vertices[Et(p)])),h=l.neighbours[u],p=this.tds.mirrorIndex(l,u));const f=c.vertices[It(d)],v=c.vertices[Et(d)],g=h.vertices[Et(p)],m=Pt(f.point,v.point,g.point);switch(m){case Zt.RIGHT_TURN:{const o=this.tds.createTriangle(f,g,v,null,null,null);t.push([o,2]),o.neighbours[1]=c,o.neighbours[0]=h,c.neighbours[d]=o,h.neighbours[p]=o,c.isConstrained(d)&&(o.constraints[1]=!0),h.isConstrained(p)&&(o.constraints[0]=!0),f.triangle=o,v.triangle=o,g.triangle=o,s=n+1,e.splice(n,0,[o,2]),e.splice(Math.max(s,i),1),e.splice(Math.min(s,i),1),i=n,f!==a?--n:++i;break}case Zt.LEFT_TURN:case Zt.COLLINEAR:++n,++i;break}}while(i<e.length)}findIntersectedFaces(e,t){const i=e.point,s=t.point,n=[],o=[],r=[],a=new ai(e,this,s);let l,c=a.pos.indexV(e);if(a.pos.isConstrained(c))return l=this.intersect(a.pos,c,e,t),{found:!0,vi:l,listAB:n,listBA:o,intersectedFaces:r};let h=a.pos.neighbours[It(c)],u=a.pos.neighbours[Et(c)];n.push([h,h.indexT(a.pos)]),o.unshift([u,u.indexT(a.pos)]),r.unshift(a.pos);let d=a.pos;a.next(),c=a.pos.indexT(d);let p=a.pos.vertices[c],f=!1;while(p!==t&&!f){let u,v;const g=Pt(i,s,p.point);switch(g){case Zt.COLLINEAR:f=!0;break;case Zt.LEFT_TURN:case Zt.RIGHT_TURN:if(g===Zt.LEFT_TURN?(u=It(c),v=Et(c)):(u=Et(c),v=It(c)),a.pos.isConstrained(u))return l=this.intersect(a.pos,u,e,t),{found:!0,vi:l,listAB:n,listBA:o,intersectedFaces:r};h=a.pos.neighbours[v],r.unshift(a.pos),g===Zt.LEFT_TURN?n.push([h,h.indexT(a.pos)]):o.unshift([h,h.indexT(a.pos)]),d=a.pos,a.next(),c=a.pos.indexT(d),p=a.pos.vertices[c];break}}return l=p,r.unshift(a.pos),h=a.pos.neighbours[Et(c)],n.push([h,h.indexT(a.pos)]),u=a.pos.neighbours[It(c)],o.unshift([u,u.indexT(a.pos)]),{found:!1,vi:l,listAB:n,listBA:o,intersectedFaces:r}}intersect(e,t,i,s){const n=e.vertices[Et(t)],o=e.vertices[It(t)],r=i.point,a=s.point,l=n.point,c=o.point;let h,u=Ht(r,a,l,c);if(u!==r&&u!==a&&u!==l&&u!==c){const e=new hi(u);e.dilate(4),e.overlaps(new hi(r))&&(u=r),e.overlaps(new hi(a))&&(u=a),e.overlaps(new hi(l))&&(u=l),e.overlaps(new hi(c))&&(u=c)}if(null===u)throw new Error("what");return this.removeConstrainedEdge(e,t),h=this.insert(u,e),h!==n&&h!==o?(this.insertConstraintV(n,h),this.insertConstraintV(h,o)):this.insertConstraintV(n,o),h}removeVertex(e){this.tds.dimension<=1?this.removeConstrainedVertex(e):this.remove2D(e)}removeConstrainedVertex(e){const t=this.tds.numberOfVertices(!1);1===t||2===t?this.tds.removeDimDown(e):1===this.tds.dimension?console.warn("NOT IMPLEMENTED."):this.remove2D(e)}remove2D(e){if(this.testDimDown(e))this.tds.removeDimDown(e);else{const t=[];this.tds.makeHole(e,t);const i=[...t];this.tds.fillHoleDelaunay(t),this.updateConstraints(i),this.tds.deleteVertex(e)}}testDimDown(e){let t=!0;for(const a of this.tds.triangles)if(!a.isInfinite()&&!a.hasVertex(e)){t=!1;break}const i=new ri(e,null);while(i.t.isInfinite())i.next();i.setDone();const s=i.t;let n=s.indexV(e);const o=s.vertices[Et(n)].point,r=s.vertices[It(n)].point;while(t&&i.next())n=i.t.indexV(e),i.t.vertices[It(n)]!==this.tds._infinite&&(t=t&&Pt(o,r,i.t.vertices[It(n)].point)===Zt.COLLINEAR);return t}updateConstraints(e){let t,i;for(const s of e)t=s[0],i=s[1],t.neighbours[i].constraints[this.tds.mirrorIndex(t,i)]=t.isConstrained(i)}removeConstrainedEdge(e,t){e.constraints[t]=!1,2===this.tds.dimension&&(e.neighbours[t].constraints[this.tds.mirrorIndex(e,t)]=!1)}removeConstrainedEdgeDelaunay(e,t){if(this.removeConstrainedEdge(e,t),2===this.tds.dimension){const i=[[e,t]];this.propagatingFlipE(i)}}updateConstraintsOpposite(e){let t=e.triangle;const i=t;let s;do{s=t.indexV(e),t.neighbours[s].constraints[this.tds.mirrorIndex(t,s)]?t.constraints[s]=!0:t.constraints[s]=!1,t=t.neighbours[It(s)]}while(t!==i)}markConstraint(e,t){1===this.tds.dimension?e.constraints[2]=!0:(e.constraints[t]=!0,e.neighbours[t].constraints[this.tds.mirrorIndex(e,t)]=!0)}insert(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=this.locate(e,this.iLocate(e,t)),s=this.insertb(e,i.loc,i.lt,i.li);return this.flipAround(s),s}flipAround(e){if(this.tds.dimension<=1)return;let t,i,s=e.triangle;const n=s;do{t=s.indexV(e),i=s.neighbours[It(t)],this.propagatingFlip(s,t),s=i}while(i!==n)}propagatingFlip(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!this.isFlipable(e,t))return;const s=100;if(i===s)throw new Error("maxde");const n=e.neighbours[t];this.flip(e,t),this.propagatingFlip(e,t,i+1),t=n.indexV(e.vertices[t]),this.propagatingFlip(n,t,i+1)}lessEdge(e,t){const i=e[1],s=t[1];return e[0].uid<t[0].uid||e[0].uid===t[0].uid&&i<s}propagatingFlipE(e){let t,i,s,n=0;const o=[];while(n<e.length)t=e[n][0],i=e[n][1],this.isFlipable(t,i)&&(s=[t.neighbours[i],this.tds.mirrorIndex(t,i)],this.lessEdge(e[n],s)?o.push(e[n]):o.push(s)),++n;let r,a,l,c;const h=[null,null,null,null];while(o.length>0){t=o[0][0],r=o[0][1],a=t.neighbours[r],l=this.tds.mirrorIndex(t,r),c=[t,r],o.splice(o.findIndex(e=>e[0]===c[0]&&e[1]===c[1]),1),h[0]=[t,Et(r)],h[1]=[t,It(r)],h[2]=[a,Et(l)],h[3]=[a,It(l)];for(const e of h){const t=e[0],i=e[1];s=[t.neighbours[i],this.tds.mirrorIndex(t,i)],this.lessEdge(e,s)?o.splice(o.findIndex(t=>t[0]===e[0]&&t[1]===e[1]),1):o.splice(o.findIndex(e=>e[0]===s[0]&&e[1]===s[1]),1)}this.flip(t,r);for(const e of h){const t=e[0],i=e[1];this.isFlipable(t,i)&&(s=[t.neighbours[i],this.tds.mirrorIndex(t,i)],this.lessEdge(e,s)?o.push(e):o.push(s))}}}flip(e,t){const i=e.neighbours[t],s=this.tds.mirrorIndex(e,t),n=e.neighbours[Et(t)],o=this.tds.mirrorIndex(e,Et(t)),r=e.neighbours[It(t)],a=this.tds.mirrorIndex(e,It(t)),l=i.neighbours[Et(s)],c=this.tds.mirrorIndex(i,Et(s)),h=i.neighbours[It(s)],u=this.tds.mirrorIndex(i,It(s));this.tds.flip(e,t),e.constraints[e.indexT(i)]=!1,i.constraints[i.indexT(e)]=!1,n.neighbours[o].constraints[this.tds.mirrorIndex(n,o)]=n.constraints[o],r.neighbours[a].constraints[this.tds.mirrorIndex(r,a)]=r.constraints[a],l.neighbours[c].constraints[this.tds.mirrorIndex(l,c)]=l.constraints[c],h.neighbours[u].constraints[this.tds.mirrorIndex(h,u)]=h.constraints[u]}isFlipable(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const s=e.neighbours[t];return!e.isInfinite()&&!s.isInfinite()&&(!e.constraints[t]&&At(s,e.vertices[t].point,i)===Zt.ON_POSITIVE_SIDE)}insertb(e,t,i,s){let n,o,r=!1;i===ei.EDGE&&t.isConstrained(s)&&(r=!0,n=t.vertices[It(s)],o=t.vertices[Et(s)]);const a=this.insertc(e,t,i,s);return r?this.updateConstraintsIncident(a,n,o):i!==ei.VERTEX&&this.clearConstraintsIncident(a),2===this.tds.dimension&&this.updateConstraintsOpposite(a),a}updateConstraintsIncident(e,t,i){if(0!==this.tds.dimension)if(1===this.tds.dimension){const t=new ni(e,null);do{t.t.constraints[2]=!0}while(t.next())}else{const s=new ri(e,null);do{const n=s.t.indexV(e),o=Et(n),r=It(n);s.t.vertices[o]===t||s.t.vertices[o]===i?(s.t.constraints[r]=!0,s.t.constraints[o]=!1):(s.t.constraints[r]=!1,s.t.constraints[o]=!0)}while(s.next())}}clearConstraintsIncident(e){const t=new ni(e,null);if(t.valid)do{const e=t.t,i=t.ri;e.constraints[i]=!1,2===this.tds.dimension&&(e.neighbours[i].constraints[this.tds.mirrorIndex(e,i)]=!1)}while(t.next())}insertc(e,t,i,s){if(1===this.tds.vertices.length)return this.insertFirst(e);if(2===this.tds.vertices.length)return i===ei.VERTEX?this.tds.finiteVertex:this.insertSecond(e);switch(i){case ei.VERTEX:return t.vertices[s];case ei.OUTSIDE_AFFINE_HULL:return this.insertOutsideAffineHull(e);case ei.OUTSIDE_CONVEX_HULL:return this.insertOutsideConvexHull(e,t);case ei.EDGE:return this.insertInEdge(e,t,s);case ei.FACE:return this.insertInFace(e,t)}throw new Error("qwe")}insertInEdge(e,t,i){const s=this.tds.insertInEdge(t,i);return s.point=e,s}insertInFace(e,t){const i=this.tds.insertInFace(t);return i.point=e,i}insertFirst(e){const t=this.tds.insertDimUp();return t.point=e,t}insertSecond(e){const t=this.tds.insertDimUp(this.tds._infinite,!0);return t.point=e,t}insertOutsideAffineHull(e){let t=!1;if(1===this.tds.dimension){const i=this.tds.finiteEdge.first,s=Pt(i.vertices[0].point,i.vertices[1].point,e);t=s===Zt.COUNTERCLOCKWISE}const i=this.tds.insertDimUp(this.tds._infinite,t);return i.point=e,i}insertOutsideConvexHull(e,t){let i;if(1===this.tds.dimension)throw new Error("sdfasdasd");return i=this.insertOutsideConvexHull2(e,t),i.point=e,i}insertOutsideConvexHull2(e,t){let i=t.indexV(this.tds._infinite);const s=[],n=[];let o=new ri(this.tds._infinite,t),r=!1;while(!r){o.prev(),i=o.t.indexV(this.tds._infinite);const t=o.t.vertices[It(i)].point,n=o.t.vertices[Et(i)].point;Pt(e,t,n)===Zt.LEFT_TURN?s.push(o.t):r=!0}o=new ri(this.tds._infinite,t),r=!1;while(!r){o.next(),i=o.t.indexV(this.tds._infinite);const t=o.t.vertices[It(i)].point,s=o.t.vertices[Et(i)].point;Pt(e,t,s)===Zt.LEFT_TURN?n.push(o.t):r=!0}const a=this.tds.insertInFace(t);let l;a.point=e;while(s.length>0)l=s[0],i=It(l.indexV(this.tds._infinite)),this.tds.flip(l,i),s.shift();while(n.length>0)l=n[0],i=Et(l.indexV(this.tds._infinite)),this.tds.flip(l,i),n.shift();o=new ri(a,null);while(!o.t.isInfinite())o.next();return this.tds._infinite.triangle=o.t,a}locate(e,t){let i=0,s=0;if(this.tds.dimension<0)return i=ei.OUTSIDE_AFFINE_HULL,s=4,{loc:null,lt:i,li:s};if(0===this.tds.dimension)return i=Vt(e,this.tds.finiteVertex.triangle.vertices[0].point)?ei.VERTEX:ei.OUTSIDE_AFFINE_HULL,s=4,{loc:null,lt:i,li:s};if(1===this.tds.dimension)return this.marchLocate1D(e);if(null===t){const e=this.tds._infinite.triangle;t=e.neighbours[e.indexV(this.tds._infinite)]}else t.isInfinite()&&(t=t.neighbours[t.indexV(this.tds._infinite)]);return this.marchLocate2D(t,e)}marchLocate1D(e){const t=this.tds._infinite.triangle,i=t.indexV(this.tds._infinite),s=t.neighbours[i],n=Pt(s.vertices[0].point,s.vertices[1].point,e);if(n===Zt.RIGHT_TURN||n===Zt.LEFT_TURN)return{loc:new ii,lt:ei.OUTSIDE_AFFINE_HULL,li:4};const o=s.indexT(t);if(Tt(e,s.vertices[1-o].point,s.vertices[o].point))return{loc:t,lt:ei.OUTSIDE_CONVEX_HULL,li:i};if(Vt(e,s.vertices[1-o].point))return{loc:s,lt:ei.VERTEX,li:1-o};throw new Error("sdfsdf")}marchLocate2D(e,t){let i,s,n=null,o=!0;while(1){if(e.isInfinite())return{loc:e,lt:ei.OUTSIDE_CONVEX_HULL,li:e.indexV(this.tds._infinite)};const r=0,a=e.vertices[0].point,l=e.vertices[1].point,c=e.vertices[2].point;let h,u,d;if(o){if(n=e,o=!1,h=Pt(a,l,t),h===Zt.NEGATIVE){e=e.neighbours[2];continue}if(u=Pt(l,c,t),u===Zt.NEGATIVE){e=e.neighbours[0];continue}if(d=Pt(c,a,t),d===Zt.NEGATIVE){e=e.neighbours[1];continue}}else if(r)if(e.neighbours[0]===n){if(n=e,h=Pt(a,l,t),h===Zt.NEGATIVE){e=e.neighbours[2];continue}if(d=Pt(c,a,t),d===Zt.NEGATIVE){e=e.neighbours[1];continue}u=Zt.POSITIVE}else if(e.neighbours[1]===n){if(n=e,u=Pt(l,c,t),u===Zt.NEGATIVE){e=e.neighbours[0];continue}if(h=Pt(a,l,t),h===Zt.NEGATIVE){e=e.neighbours[2];continue}d=Zt.POSITIVE}else{if(n=e,d=Pt(c,a,t),d===Zt.NEGATIVE){e=e.neighbours[1];continue}if(u=Pt(l,c,t),u===Zt.NEGATIVE){e=e.neighbours[0];continue}h=Zt.POSITIVE}else if(e.neighbours[0]===n){if(n=e,d=Pt(c,a,t),d===Zt.NEGATIVE){e=e.neighbours[1];continue}if(h=Pt(a,l,t),h===Zt.NEGATIVE){e=e.neighbours[2];continue}u=Zt.POSITIVE}else if(e.neighbours[1]===n){if(n=e,h=Pt(a,l,t),h===Zt.NEGATIVE){e=e.neighbours[2];continue}if(u=Pt(l,c,t),u===Zt.NEGATIVE){e=e.neighbours[0];continue}d=Zt.POSITIVE}else{if(n=e,u=Pt(l,c,t),u===Zt.NEGATIVE){e=e.neighbours[0];continue}if(d=Pt(c,a,t),d===Zt.NEGATIVE){e=e.neighbours[1];continue}h=Zt.POSITIVE}const p=(h===Zt.COLLINEAR?1:0)+(u===Zt.COLLINEAR?1:0)+(d===Zt.COLLINEAR?1:0);switch(p){case 0:i=ei.FACE,s=4;break;case 1:i=ei.EDGE,s=h===Zt.COLLINEAR?2:u===Zt.COLLINEAR?0:1;break;case 2:i=ei.VERTEX,s=h!==Zt.COLLINEAR?2:u!==Zt.COLLINEAR?0:1;break}if(void 0===i||void 0===s)throw new Error("ert");return{loc:e,lt:i,li:s}}}iLocate(e,t){if(this.tds.dimension<2)return t;if(null===t){const e=this.tds._infinite.triangle;t=e.neighbours[e.indexV(this.tds._infinite)]}else t.isInfinite()&&(t=t.neighbours[t.indexV(this.tds._infinite)]);let i=null,s=t,n=!0,o=2500;while(1){if(!o--)return s;if(s.isInfinite())return s;const t=s.vertices[0].point,r=s.vertices[1].point,a=s.vertices[2].point;if(n){if(i=s,n=!1,Nt(t,r,e)){s=s.neighbours[2];continue}if(Nt(r,a,e)){s=s.neighbours[0];continue}if(Nt(a,t,e)){s=s.neighbours[1];continue}}else if(s.neighbours[0]===i){if(i=s,Nt(t,r,e)){s=s.neighbours[2];continue}if(Nt(a,t,e)){s=s.neighbours[1];continue}}else if(s.neighbours[1]===i){if(i=s,Nt(t,r,e)){s=s.neighbours[2];continue}if(Nt(r,a,e)){s=s.neighbours[0];continue}}else{if(i=s,Nt(a,t,e)){s=s.neighbours[1];continue}if(Nt(r,a,e)){s=s.neighbours[0];continue}}break}return s}}class di{constructor(e,t){this.children=[],this.nPrimitives=e,this.bbox=t}}class pi extends di{constructor(e,t,i){super(t,i),this.firstPrimOffset=e}}class fi extends di{constructor(e,t,i){super(0,t.bbox.union(i.bbox)),this.dimension=e,this.children.push(t),this.children.push(i)}}class vi{constructor(e){if(this.totalNodes=0,this.buildData=[],this.orderedPrims=[],this.nodes=[],this.offset=0,this.shapes=e,0===this.shapes.length)return this.root=null,void(this.nodes=[]);for(let t=0;t<e.length;t++){const i=xt.UUIDMap.get(e[t]);this.buildData.push({index:t,bbox:i.getBoundingBox(),center:new Ct(i.center(),0,0)})}this.root=this.recursiveBuild(0,e.length),this.compact()}draw(){const e=xt.getLayer("draw").ctx;for(const t of this.nodes){const i=t.bbox;e.strokeRect(ot(i.topLeft.x),rt(i.topLeft.y),at(i.w),at(i.h))}}recursiveBuild(e,t){this.totalNodes++;let i=this.buildData[e].bbox;for(let n=e+1;n<t;n++)i=i.union(this.buildData[n].bbox);const s=t-e;if(1===s)return this.createLeaf(e,t,s,i);{let n=this.buildData[e].center;for(let i=e;i<t;i++)n=n.union(this.buildData[i].center);const o=n.getMaxExtent();if(n.botRight.get(o)===n.topLeft.get(o))return this.createLeaf(e,t,s,i);const r=.5*(n.topLeft.get(o)+n.botRight.get(o)),a=ce(this.buildData.slice(e,t),e=>e.center.center().get(o)<r),l=[].concat.apply([],a);0!==a[0].length&&0!==a[1].length||console.log("EMPTY"),this.buildData.splice(e,l.length,...l);const c=a[0].length+e;return new fi(o,this.recursiveBuild(e,c),this.recursiveBuild(c,t))}}intersect(e,t){if(0===this.nodes.length)return{hit:!1,intersect:e.get(0),tMin:0,tMax:e.tMax};void 0===t&&(t=!1);let i=!1,s=0,n=e.tMax,o=0,r=0;const a=[],l=e.direction.inverse(),c=[l.x<0,l.y<0];while(1){const h=this.nodes[r],u=h.bbox.intersectP(e,l,c);if(u.hit)if(h.nPrimitives>0){if(i=!0,s=e.tMax=u.min,n=u.max,0===o||t)break;r=a[--o]}else c[h.dimension]?(a[o++]=r+1,r=h.secondChildOffset):(a[o++]=h.secondChildOffset,r++);else{if(0===o)break;r=a[--o]}}return{hit:i,intersect:e.get(s),tMin:s,tMax:n}}compact(){this.offset=0,null!==this.root&&this.flatten(this.root)}flatten(e){const t=this.offset,i=this.offset++;if(0===e.nPrimitives){this.flatten(e.children[0]);const i=this.flatten(e.children[1]),s={bbox:e.bbox,dimension:e.dimension,nPrimitives:0,secondChildOffset:i};this.nodes[t]=s}else{const i={bbox:e.bbox,primitivesOffset:e.firstPrimOffset,nPrimitives:e.nPrimitives};this.nodes[t]=i}return i}createLeaf(e,t,i,s){const n=this.orderedPrims.length;for(let o=e;o<t;o++)this.orderedPrims.push(this.shapes[this.buildData[o].index]);return new pi(n,i,s)}}let gi=class extends I["d"]{constructor(){super(...arguments),this.BV=Object.freeze(new vi([])),this.visionMode="bvh",this.visionBlockers=[]}setVisionMode(e){this.visionMode=e.mode,e.sync&&Xe.emit("Location.Options.Set",{vision_mode:e.mode})}recalculateVision(){"triangle"===this.visionMode?wi(bi.VISION):this.BV=Object.freeze(new vi(this.visionBlockers))}recalculateMovement(){"triangle"===this.visionMode&&wi(bi.MOVEMENT)}deleteFromTriag(e){"triangle"===this.visionMode?Ci(e.target,e.vertices):e.standalone&&this.recalculateVision()}addToTriag(e){"triangle"===this.visionMode?_i(e.target,e.points):this.recalculateVision()}clear(){this.context.state.visionBlockers=[],this.context.commit("recalculateVision"),this.context.commit("recalculateMovement")}};v["a"]([I["c"]],gi.prototype,"setVisionMode",null),v["a"]([I["c"]],gi.prototype,"recalculateVision",null),v["a"]([I["c"]],gi.prototype,"recalculateMovement",null),v["a"]([I["c"]],gi.prototype,"deleteFromTriag",null),v["a"]([I["c"]],gi.prototype,"addToTriag",null),v["a"]([I["a"]],gi.prototype,"clear",null),gi=v["a"]([Object(I["b"])({dynamic:!0,store:T,name:"visibility",namespaced:!0})],gi);const mi=Object(I["e"])(gi);var bi;(function(e){e["VISION"]="vision",e["MOVEMENT"]="movement"})(bi||(bi={}));let yi={vision:new ui,movement:new ui};function wi(e){console.warn(`RETRIANGULATING ${e}`),console.time("TRI");const t=new ui;let i;i="vision"===e?mi.visionBlockers:yt.movementblockers;for(const s of i){const e=xt.UUIDMap.get(s);for(let i=0;i<e.points.length;i++){const s=e.points[i],n=e.points[(i+1)%e.points.length],o=t.insertConstraint(s,n),r=o.va,a=o.vb;r.shapes.add(e),a.shapes.add(e),e.addTriagVertices(r,a)}}t.insertConstraint([-1e8,-1e8],[-1e8,1e8]),t.insertConstraint([-1e8,1e8],[-1e11,1e8]),t.insertConstraint([-1e11,1e8],[-1e11,-1e8]),t.insertConstraint([-1e11,-1e8],[-1e8,-1e8]),t.insertConstraint([-1e8,-1e8],[1e8,-1e8]),t.insertConstraint([1e8,-1e8],[1e8,-1e11]),t.insertConstraint([1e8,-1e11],[-1e8,-1e11]),t.insertConstraint([-1e8,-1e11],[-1e8,-1e8]),t.insertConstraint([1e8,-1e8],[1e8,1e8]),t.insertConstraint([1e8,1e8],[1e11,1e8]),t.insertConstraint([1e11,1e8],[1e11,-1e8]),t.insertConstraint([1e11,-1e8],[1e8,-1e8]),t.insertConstraint([-1e8,1e8],[1e8,1e8]),t.insertConstraint([1e8,1e8],[1e8,1e11]),t.insertConstraint([1e8,1e11],[-1e8,1e11]),t.insertConstraint([-1e8,1e11],[-1e8,1e8]),yi[e]=t,window.CDT=yi,console.timeEnd("TRI")}function xi(e,t,i,s,n){const o=e.shapes.size>=(n?2:1);o||s.newConstraints.some(t=>t.includes(e))||s.vertices.add(e);const r=[...e.getIncidentEdges()].filter(e=>e.first.constraints[e.second]);let a=[],l=null;for(const c of r){const h=c.first.vertices[It(c.second)],u=h.point,d=h.shapes.size>(h===i?1:0);if(mt(u,i.point))d||s.edges.push(c);else{if(mt(u,t.point))continue;if(Tt(e.point,u,i.point))null!==l&&console.warn("Multiple collinear vertices found?"),d||s.edges.push(c),l=h;else if(d||3!==r.length){if((!o||!d)&&4===r.length)if(s.edges.push(c),s.vertices.has(h))for(let t=s.newConstraints.length-1;t>=0;t--){const i=Object(_t["a"])(s.newConstraints[t],2),n=i[0],o=i[1];if(n===e||o===e){const i=s.newConstraints.splice(t,1)[0];a=[...a,...i.filter(t=>t!==e)],s.vertices.add(e)}}else s.triBridge.includes(h)?a.push(s.triBridge.pop()):a.push(h)}else s.edges.push(c),0===s.triBridge.length?s.triBridge.push(n?h:e):s.newConstraints.push([s.triBridge.pop(),n?h:e])}}return 3!==r.length&&4!==r.length||1!==a.length||1!==s.triBridge.length?4===r.length&&a.length>0&&s.newConstraints.push(a):s.newConstraints.push([a.pop(),s.triBridge.pop()]),null===l?e:xi(l,e,i,s,!1)}function Ci(e,t){console.time("DS");const i=yi[e],s={vertices:new Set,edges:[],newConstraints:[],triBridge:[]},n=t.length;let o=t[n-1];for(const l of t.entries()){var r=Object(_t["a"])(l,2);const e=r[0],i=r[1],a=t[(e+1)%n];o=xi(i,o,a,s,!0)}s.triBridge.length>0&&s.newConstraints.push([s.triBridge.pop(),t[0]]);for(const l of s.edges)i.removeConstrainedEdgeDelaunay(l.first,l.second);for(const l of s.vertices)i.removeVertex(l);for(const l of s.newConstraints){var a=Object(_t["a"])(l,2);const e=a[0],t=a[1];i.insertConstraintV(e,t)}console.timeEnd("DS")}function _i(e,t){}class Si{constructor(e,t,i,s){this.fillColour="#000",this.strokeColour="rgba(0,0,0,0)",this.name="Unknown shape",this.nameVisible=!0,this.trackers=[],this.auras=[],this.labels=[],this._owners=[],this._triagVertices=[],this.visionObstruction=!1,this.movementObstruction=!1,this.isToken=!1,this.showHighlight=!1,this.annotation="",this.globalCompositeOperation="source-over",this.options=new Map,this._refPoint=e,this.uuid=s||ae(),void 0!==t&&(this.fillColour=t),void 0!==i&&(this.strokeColour=i)}get refPoint(){return this._refPoint}set refPoint(e){this._refPoint=e}visibleInCanvas(e){return!1}getPointIndex(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;for(const s of this.points.entries()){var i=Object(_t["a"])(s,2);const n=i[0],o=i[1];if(Math.abs(e.x-o[0])<=t&&Math.abs(e.y-o[1])<=t)return n}return-1}getPointOrientation(e){const t=Qe.fromArray(this.points[(this.points.length+e-1)%this.points.length]),i=Qe.fromArray(this.points[e]),s=Qe.fromArray(this.points[(e+1)%this.points.length]),n=s.subtract(t),o=t.add(n.multiply(.5));return i.subtract(o).normalize()}invalidate(e){const t=xt.getLayer(this.layer);t&&t.invalidate(e)}checkVisionSources(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=!1;const i=this,s=mi.visionBlockers.indexOf(this.uuid);this.visionObstruction&&-1===s?(mi.visionBlockers.push(this.uuid),e&&(mi.addToTriag({target:bi.VISION,points:this.points}),t=!0)):!this.visionObstruction&&s>=0&&(mi.visionBlockers.splice(s,1),e&&(mi.deleteFromTriag({target:bi.VISION,vertices:this.triagVertices,standalone:!0}),t=!0)),this.auras.forEach(e=>{const t=yt.visionSources,s=t.findIndex(t=>t.aura===e.uuid);e.visionSource&&-1===s?t.push({shape:i.uuid,aura:e.uuid}):!e.visionSource&&s>=0&&t.splice(s,1)});for(let n=yt.visionSources.length-1;n>=0;n--){const e=yt.visionSources[n];e.shape===i.uuid&&(i.auras.some(t=>t.uuid===e.aura&&t.visionSource)||yt.visionSources.splice(n,1))}return t}setMovementBlock(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.movementObstruction=e||!1;const i=yt.movementblockers.indexOf(this.uuid);let s=!1;return this.movementObstruction&&-1===i?(yt.movementblockers.push(this.uuid),t&&(mi.addToTriag({target:bi.MOVEMENT,points:this.points}),s=!0)):!this.movementObstruction&&i>=0&&(yt.movementblockers.splice(i,1),t&&(mi.deleteFromTriag({target:bi.MOVEMENT,vertices:this.triagVertices,standalone:!0}),s=!0)),s}setIsToken(e){if(this.isToken=e,this.ownedBy()){const e=yt.ownedtokens.indexOf(this.uuid);this.isToken&&-1===e?yt.ownedtokens.push(this.uuid):!this.isToken&&e>=0&&yt.ownedtokens.splice(e,1)}}getBaseDict(){return{type_:this.type,uuid:this.uuid,x:this.refPoint.x,y:this.refPoint.y,layer:this.layer,draw_operator:this.globalCompositeOperation,movement_obstruction:this.movementObstruction,vision_obstruction:this.visionObstruction,auras:kt(this.auras),trackers:this.trackers,labels:this.labels,owners:this._owners,fill_colour:this.fillColour,stroke_colour:this.strokeColour,name:this.name,name_visible:this.nameVisible,annotation:this.annotation,is_token:this.isToken,options:JSON.stringify([...this.options])}}fromDict(e){this.layer=e.layer,this.globalCompositeOperation=e.draw_operator,this.movementObstruction=e.movement_obstruction,this.visionObstruction=e.vision_obstruction,this.auras=St(e.auras),this.trackers=e.trackers,this.labels=e.labels,this._owners=e.owners,this.isToken=e.is_token,this.nameVisible=e.name_visible,e.annotation&&(this.annotation=e.annotation),e.name&&(this.name=e.name),e.options&&(this.options=new Map(JSON.parse(e.options)))}draw(e){if(void 0!==this.globalCompositeOperation?e.globalCompositeOperation=this.globalCompositeOperation:e.globalCompositeOperation="source-over",this.showHighlight){const t=this.getBoundingBox();e.strokeStyle="red",e.strokeRect(ot(t.topLeft.x)-5,rt(t.topLeft.y)-5,at(t.w)+10,at(t.h)+10)}}drawAuras(e){for(const i of this.auras){if(0===i.value&&0===i.dim)return;e.beginPath();const s=nt(this.center()),n=ct(i.value+i.dim);if(0===i.dim)e.fillStyle=i.colour;else{const t=e.createRadialGradient(s.x,s.y,ct(i.value),s.x,s.y,ct(i.value+i.dim)),n=it()(i.colour);e.fillStyle=t,t.addColorStop(0,i.colour),t.addColorStop(1,n.setAlpha(0).toRgbString())}if(i.visionSource&&void 0!==i.lastPath)try{e.fill(i.lastPath)}catch(t){e.arc(s.x,s.y,n,0,2*Math.PI),e.fill(),console.warn(t)}else e.arc(s.x,s.y,n,0,2*Math.PI),e.fill()}}getInitiativeRepr(){return{uuid:this.uuid,visible:!yt.IS_DM,group:!1,source:this.name,has_img:!1,effects:[],index:1/0}}moveLayer(e,t){const i=xt.getLayer(this.layer),s=xt.getLayer(e);void 0!==i&&void 0!==s&&(this.layer=e,i.shapes.splice(i.shapes.indexOf(this),1),s.shapes.push(this),i.invalidate(!0),s.invalidate(!1),t&&Xe.emit("Shape.Layer.Change",{uuid:this.uuid,layer:e}))}get owners(){return Object.freeze(this._owners.slice())}ownedBy(e){return void 0===e&&(e=yt.username),yt.IS_DM||this._owners.includes(e)||yt.FAKE_PLAYER&&yt.activeTokens.includes(this.uuid)}addOwner(e){this._owners.includes(e)||this._owners.push(e)}updateOwner(e,t){const i=this._owners.findIndex(t=>t===e);i>=0?this._owners.splice(i,1,t):this.addOwner(t)}removeOwner(e){const t=this._owners.findIndex(t=>t===e);this._owners.splice(t,1)}addTriagVertices(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(const s of t)this._triagVertices.includes(s)||this._triagVertices.push(s)}removeTriagVertices(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this._triagVertices=this._triagVertices.filter(e=>!t.includes(e))}get triagVertices(){return[...this._triagVertices]}}function ki(e,t,i){if(0===e.x&&0===e.y)return e;if("bvh"===mi.visionMode){void 0===i&&(i=[]);const s=t.getBoundingBox(),n=s.offset(e);let o=!1;for(const t of yt.movementblockers){if(i.includes(t))continue;const r=xt.UUIDMap.get(t),a=r.getBoundingBox();let l=a.intersectsWithInner(n);if(!l){const t=et.fromPoints(s.topLeft.add(e.normalize()),n.topLeft),i=t.direction.inverse(),o=[i.x<0,i.y<0];l=a.intersectP(t,i,o).hit}if(l){const n=a.center(),r=s.center(),l=r.subtract(n),c=new Je(1,0),h=new Je(0,1);let u=l.dot(c),d=l.dot(h);u>a.w/2&&(u=a.w/2),u<-a.w/2&&(u=-a.w/2),d>a.h/2&&(d=a.h/2),d<-a.h/2&&(d=-a.h/2);const p=n.add(c.multiply(u)).add(h.multiply(d));p.x===s.topLeft.x||p.x===s.topRight.x?e=new Je(0,e.y):p.y===s.topLeft.y||p.y===s.botLeft.y?e=new Je(e.x,0):p.x<s.topLeft.x?e=new Je(p.x-s.topLeft.x,e.y):p.x>s.topRight.x?e=new Je(p.x-s.topRight.x,e.y):p.y<s.topLeft.y?e=new Je(e.x,p.y-s.topLeft.y):p.y>s.botLeft.y&&(e=new Je(e.x,p.y-s.botLeft.y)),o=!0,i.push(t);break}}return o&&(e=ki(e,t,i)),e}{const i=yi.movement.locate(t.center().asArray(),null).loc;for(const s of t.points){const t=yi.movement.locate(s,i),n=t.loc;null!==n&&(e=Li(s,n,e))}return e}}function Li(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const n=new Qe(e[0],e[1]),o=n.add(i).asArray();if(t.contains(o))return i;s.push(t);for(let r=0;r<3;r++){if(s.includes(t.neighbours[r]))continue;const a=t.vertices[Et(r)].point,l=t.vertices[It(r)].point,c=Ht(e,o,a,l);if(null===c)continue;if(!t.isConstrained(r))return Li(e,t.neighbours[r],i,s);if(c[0]===n.x&&c[1]===n.y){const t=Pt(e,o,l);if(t===Zt.LEFT_TURN)continue;if(t===Zt.ZERO)continue}let h=new Qe(c[0],c[1]).subtract(n).multiply(.8);h.length()<1&&(h=new Je(0,0)),h.length()<i.length()&&(i=h)}return i}class Ei extends Si{constructor(e,t,i,s,n,o){super(e,s,n,o),this.w=t,this.h=i}getBaseDict(){return Object.assign(super.getBaseDict(),{width:this.w,height:this.h})}getBoundingBox(){return new Ct(this.refPoint,this.w,this.h)}get points(){if(0===this.w||0===this.h)return[[this.refPoint.x,this.refPoint.y]];const e=this.refPoint.add(new Je(0,this.h)),t=this.refPoint.add(new Je(this.w,this.h)),i=this.refPoint.add(new Je(this.w,0));return[[this.refPoint.x,this.refPoint.y],[e.x,e.y],[t.x,t.y],[i.x,i.y]]}contains(e){return this.refPoint.x<=e.x&&this.refPoint.x+this.w>=e.x&&this.refPoint.y<=e.y&&this.refPoint.y+this.h>=e.y}center(e){if(void 0===e)return this.refPoint.add(new Je(this.w/2,this.h/2));this.refPoint=new Qe(e.x-this.w/2,e.y-this.h/2)}visibleInCanvas(e){if(super.visibleInCanvas(e))return!0;const t=!(ot(this.refPoint.x)>e.width||rt(this.refPoint.y)>e.height||ot(this.refPoint.x+this.w)<0||rt(this.refPoint.y+this.h)<0);return!!t}snapToGrid(){const e=yt.gridSize,t=this.center(),i=t.x,s=t.y;let n,o;n=this.w/e%2===0?Math.round(i/e)*e-this.w/2:(Math.round((i+e/2)/e)-.5)*e-this.w/2,o=this.h/e%2===0?Math.round(s/e)*e-this.h/2:(Math.round((s+e/2)/e)-.5)*e-this.h/2;const r=ki(new Je(n-this.refPoint.x,o-this.refPoint.y),this);this.refPoint=this.refPoint.add(r),this.invalidate(!1)}resizeToGrid(){const e=yt.gridSize;this.refPoint=new Qe(Math.round(this.refPoint.x/e)*e,Math.round(this.refPoint.y/e)*e),this.w=Math.max(Math.round(this.w/e)*e,e),this.h=Math.max(Math.round(this.h/e)*e,e),this.invalidate(!1)}resize(e,t){const i=yt.zoomFactor;switch(e){case 0:this.w=ot(this.refPoint.x)+this.w*i-t.x,this.h=rt(this.refPoint.y)+this.h*i-t.y,this.refPoint=ht(t);break;case 1:this.w=ot(this.refPoint.x)+this.w*i-t.x,this.h=t.y-rt(this.refPoint.y),this.refPoint=new Qe(ut(t.x),this.refPoint.y);break;case 2:this.w=t.x-ot(this.refPoint.x),this.h=t.y-rt(this.refPoint.y);break;case 3:this.w=t.x-ot(this.refPoint.x),this.h=rt(this.refPoint.y)+this.h*i-t.y,this.refPoint=new Qe(this.refPoint.x,dt(t.y));break}this.w/=i,this.h/=i,this.w<0&&(this.refPoint=this.refPoint.add(new Je(this.w,0)),this.w=Math.abs(this.w)),this.h<0&&(this.refPoint=this.refPoint.add(new Je(0,this.h)),this.h=Math.abs(this.h))}}class Ii extends Ei{constructor(e,t,i,s,n){super(t,i,s,void 0,void 0,n),this.type="assetrect",this.src="",this.img=e}asDict(){return Object.assign(this.getBaseDict(),{src:this.src})}fromDict(e){super.fromDict(e),this.src=e.src}draw(e){super.draw(e);try{e.drawImage(this.img,ot(this.refPoint.x),rt(this.refPoint.y),at(this.w),at(this.h))}catch(t){console.warn(`Shape ${this.uuid} could not load the image ${this.src}`)}}getInitiativeRepr(){return{uuid:this.uuid,visible:!yt.IS_DM,group:!1,source:this.src,has_img:!0,effects:[],index:1/0}}}class Oi extends Si{constructor(e,t,i,s,n){super(e,i,s,n),this.type="circle",this.r=t||1}asDict(){return Object.assign(this.getBaseDict(),{radius:this.r})}fromDict(e){super.fromDict(e),this.r=e.radius}getBoundingBox(){return new Ct(new Qe(this.refPoint.x-this.r,this.refPoint.y-this.r),2*this.r,2*this.r)}get points(){return this.getBoundingBox().points}draw(e){super.draw(e),e.beginPath(),"fog"===this.fillColour?e.fillStyle=yt.getFogColour():e.fillStyle=this.fillColour;const t=nt(this.refPoint);e.arc(t.x,t.y,at(this.r),0,2*Math.PI),e.fill(),"rgba(0, 0, 0, 0)"!==this.strokeColour&&(e.beginPath(),e.lineWidth=at(5),e.strokeStyle=this.strokeColour,e.arc(t.x,t.y,at(this.r),0,2*Math.PI),e.stroke())}contains(e){return Math.pow(e.x-this.refPoint.x,2)+Math.pow(e.y-this.refPoint.y,2)<Math.pow(this.r,2)}center(e){if(void 0===e)return this.refPoint;this.refPoint=e}visibleInCanvas(e){return this.getBoundingBox().visibleInCanvas(e)}snapToGrid(){const e=yt.gridSize;let t,i;t=2*this.r/e%2===0?Math.round(this.refPoint.x/e)*e:Math.round((this.refPoint.x-e/2)/e)*e+this.r,i=2*this.r/e%2===0?Math.round(this.refPoint.y/e)*e:Math.round((this.refPoint.y-e/2)/e)*e+this.r;const s=ki(new Je(t-this.refPoint.x,i-this.refPoint.y),this);this.refPoint=this.refPoint.add(s),this.invalidate(!1)}resizeToGrid(){const e=yt.gridSize;this.r=Math.max(Math.round(this.r/e)*e,e/2),this.invalidate(!1)}resize(e,t){const i=ht(t).subtract(this.refPoint);this.r=Math.sqrt(Math.pow(i.length(),2)/2)}}class Ti extends Oi{constructor(e,t,i,s,n,o,r){super(e,t,n,o,r),this.type="circulartoken",this.text=i,this.font=s}asDict(){return Object.assign(this.getBaseDict(),{radius:this.r,text:this.text,font:this.font})}fromDict(e){super.fromDict(e),this.r=e.radius,this.text=e.text,this.font=e.font}draw(e){super.draw(e),e.font=this.font,e.save();const t=nt(this.center());e.textAlign="center",e.textBaseline="middle";const i=he(e,this.text,at(this.r),at(this.r)),s=0;e.transform(i,s,-s,i,t.x,t.y),e.fillStyle=tt["mostReadable"](this.fillColour,["#000","#fff"]).toHexString(),e.fillText(this.text,0,0),e.restore()}getInitiativeRepr(){return{uuid:this.uuid,visible:!yt.IS_DM,group:!1,source:""===this.name||"Unknown shape"===this.name?this.text:this.name,has_img:!1,effects:[],index:1/0}}}class Mi extends Si{constructor(e,t,i,s,n){super(e,"rgba(0, 0, 0, 0)",s||"#000",n),this.type="line",this.endPoint=t,this.lineWidth=void 0===i?1:i}asDict(){return Object.assign(this.getBaseDict(),{x2:this.endPoint.x,y2:this.endPoint.y,line_width:this.lineWidth})}get points(){return[[this.refPoint.x,this.refPoint.y],[this.endPoint.x,this.endPoint.y]]}getBoundingBox(){return new Ct(new Qe(Math.min(this.refPoint.x,this.endPoint.x),Math.min(this.refPoint.y,this.endPoint.y)),Math.abs(this.refPoint.x-this.endPoint.x),Math.abs(this.refPoint.y-this.endPoint.y))}draw(e){super.draw(e),e.strokeStyle=this.strokeColour,e.beginPath(),e.moveTo(ot(this.refPoint.x),rt(this.refPoint.y)),e.lineTo(ot(this.endPoint.x),rt(this.endPoint.y)),e.lineWidth=this.lineWidth,e.stroke()}contains(e){return!1}center(e){}visibleInCanvas(e){return this.getBoundingBox().visibleInCanvas(e)}snapToGrid(){}resizeToGrid(){}resize(e,t){0===e?this.refPoint=ht(t):this.endPoint=ht(t)}}class Pi extends Si{constructor(e,t,i,s,n){super(e,"rgba(0, 0, 0, 0)",s||"#000",n),this.type="multiline",this._points=[],this._points=t||[],this.lineWidth=i||3}get refPoint(){return this._refPoint}set refPoint(e){const t=e.subtract(this._refPoint);this._refPoint=e;for(let i=0;i<this._points.length;i++)this._points[i]=this._points[i].add(t)}asDict(){return Object.assign(this.getBaseDict(),{line_width:this.lineWidth,points:this._points.map(e=>({x:e.x,y:e.y}))})}fromDict(e){super.fromDict(e),this._points=e.points.map(e=>new Qe(e.x,e.y))}get points(){return this._points.map(e=>[e.x,e.y])}getBoundingBox(){let e=this.refPoint.x,t=this.refPoint.x,i=this.refPoint.y,s=this.refPoint.y;for(const n of this._points)n.x<e&&(e=n.x),n.x>t&&(t=n.x),n.y<i&&(i=n.y),n.y>s&&(s=n.y);return new Ct(new Qe(e,i),t-e,s-i)}draw(e){super.draw(e),e.beginPath(),e.lineCap="round",e.lineJoin="round",e.moveTo(ot(this.refPoint.x),rt(this.refPoint.y));for(const t of this._points)e.lineTo(ot(t.x),rt(t.y));"fog"===this.strokeColour?e.strokeStyle=yt.getFogColour():e.strokeStyle=this.strokeColour,e.lineWidth=at(this.lineWidth),e.stroke()}contains(e){return this.getBoundingBox().contains(e)}center(e){return this.getBoundingBox().center()}visibleInCanvas(e){return this.getBoundingBox().visibleInCanvas(e)}snapToGrid(){}resizeToGrid(){}resize(e,t){0===e?this._refPoint=ht(t):this._points[e-1]=ht(t)}}class Di extends Ei{constructor(e,t,i,s,n,o){super(e,t,i,s,n,o),this.type="rect"}asDict(){return super.getBaseDict()}draw(e){super.draw(e),"fog"===this.fillColour?e.fillStyle=yt.getFogColour():e.fillStyle=this.fillColour;const t=yt.zoomFactor,i=nt(this.refPoint);e.fillRect(i.x,i.y,this.w*t,this.h*t),"rgba(0, 0, 0, 0)"!==this.strokeColour&&(e.strokeStyle=this.strokeColour,e.lineWidth=5,e.strokeRect(i.x,i.y,this.w*t,this.h*t))}}class Ni extends Si{constructor(e,t,i,s,n,o,r){super(e,n,o,r),this.type="text",this.text=t,this.font=i,this.angle=s||0}asDict(){return Object.assign(this.getBaseDict(),{text:this.text,font:this.font,angle:this.angle})}get points(){return[[this.refPoint.x,this.refPoint.y]]}getBoundingBox(){return new Ct(this.refPoint,5,5)}draw(e){super.draw(e),e.font=this.font,e.fillStyle=this.fillColour,e.save();const t=nt(this.refPoint);e.translate(t.x,t.y),e.rotate(this.angle),e.textAlign="center",this.getLines(e).map(t=>e.fillText(t.text,t.x,t.y)),e.restore()}contains(e){return!1}center(e){}visibleInCanvas(e){return this.getBoundingBox().visibleInCanvas(e)}snapToGrid(){}resizeToGrid(){}resize(e,t){}getMaxHeight(e){const t=this.getLines(e),i=30;return i*t.length}getMaxWidth(e){const t=this.getLines(e),i=t.map(t=>e.measureText(t.text).width);return Math.max(...i)}getLines(e){const t=this.text.split("\n"),i=[],s=e.canvas.width,n=30,o=0;let r=0;for(const a of t){let t="";const l=a.split(" ");for(const a of l){const l=t+a+" ",c=e.measureText(l),h=c.width;h>s?(e.fillText(t,o,r),i.push({text:t,x:o,y:r}),t=a+" ",r+=n):t=l}i.push({text:t,x:o,y:r}),r+=n}return i}}class Ai extends Si{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;super(e,i,s,n),this.type="polygon",this._vertices=[],this._vertices=t}get refPoint(){return this._refPoint}set refPoint(e){const t=e.subtract(this._refPoint);this._refPoint=e;for(let i=0;i<this._vertices.length;i++)this._vertices[i]=this._vertices[i].add(t)}get vertices(){return[this._refPoint,...this._vertices]}asDict(){return Object.assign(this.getBaseDict(),{vertices:this._vertices.map(e=>({x:e.x,y:e.y}))})}fromDict(e){super.fromDict(e),this._vertices=e.vertices.map(e=>new Qe(e.x,e.y))}get points(){return this.vertices.map(e=>[e.x,e.y])}draw(e){super.draw(e),e.lineCap="round",e.lineJoin="round","fog"===this.strokeColour?e.strokeStyle=yt.getFogColour():2===this.vertices.length?e.strokeStyle=this.fillColour:e.strokeStyle=this.strokeColour,"fog"===this.fillColour?e.fillStyle=yt.getFogColour():e.fillStyle=this.fillColour,e.lineWidth=at(2),e.beginPath(),e.moveTo(ot(this.vertices[0].x),rt(this.vertices[0].y));for(let t=1;t<=this.vertices.length;t++){const i=this.vertices[t%this.vertices.length];e.lineTo(ot(i.x),rt(i.y))}e.fill(),e.stroke()}contains(e){return this.getBoundingBox().contains(e)}center(e){return this.getBoundingBox().center()}visibleInCanvas(e){return this.getBoundingBox().visibleInCanvas(e)}snapToGrid(){}resizeToGrid(){}resize(e,t){0===e?this._refPoint=ht(t):this._vertices[e-1]=ht(t)}getBoundingBox(){let e=this.refPoint.x,t=this.refPoint.x,i=this.refPoint.y,s=this.refPoint.y;for(const n of this._vertices)n.x<e&&(e=n.x),n.x>t&&(t=n.x),n.y<i&&(i=n.y),n.y>s&&(s=n.y);return new Ct(new Qe(e,i),t-e,s-i)}}function Ri(e){let t;const i=new Qe(e.x,e.y);if("rect"===e.type_){const s=e;t=new Di(i,s.width,s.height,s.fill_colour,s.stroke_colour,s.uuid)}else if("circle"===e.type_){const s=e;t=new Oi(i,s.radius,s.fill_colour,s.stroke_colour,s.uuid)}else if("circulartoken"===e.type_){const s=e;t=new Ti(i,s.radius,s.text,s.font,s.fill_colour,s.stroke_colour,s.uuid)}else if("line"===e.type_){const s=e;t=new Mi(i,new Qe(s.x2,s.y2),s.line_width,s.stroke_colour,s.uuid)}else if("multiline"===e.type_){const s=e;t=new Pi(i,s.points.map(e=>new Qe(e.x,e.y)),s.line_width,s.stroke_colour,s.uuid)}else if("polygon"===e.type_){const s=e;t=new Ai(i,s.vertices.map(e=>new Qe(e.x,e.y)),s.fill_colour,s.stroke_colour,s.uuid)}else if("text"===e.type_){const s=e;t=new Ni(i,s.text,s.font,s.angle,s.fill_colour,s.stroke_colour,s.uuid)}else{if("assetrect"!==e.type_)return;{const s=e,n=new Image(s.width,s.height);s.src.startsWith("http")?n.src=new URL(s.src).pathname:n.src=s.src,t=new Ii(n,i,s.width,s.height,s.uuid),n.onload=()=>{xt.getLayer(e.layer).invalidate(!1)}}}return t.fromDict(e),t}class Vi{constructor(e,t){this.selectable=!1,this.playerEditable=!1,this.isVisionLayer=!1,this.valid=!1,this.shapes=[],this.selection=[],this.selectionColor="#CC0000",this.selectionWidth=2,this.canvas=e,this.name=t,this.width=e.width,this.height=e.height,this.ctx=e.getContext("2d")}invalidate(e){this.valid=!1,e||xt.invalidateLight()}addShape(e,t,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];void 0===i&&(i=!1),e.layer=this.name,this.shapes.push(e),xt.UUIDMap.set(e.uuid,e),e.checkVisionSources(s),e.setMovementBlock(e.movementObstruction,s),e.ownedBy(yt.username)&&e.isToken&&yt.ownedtokens.push(e.uuid),e.annotation.length&&yt.annotations.push(e.uuid),t&&Xe.emit("Shape.Add",{shape:e.asDict(),temporary:i}),s&&this.invalidate(!t)}setShapes(e){for(const t of e){const e=Ri(t);if(void 0===e)return void console.log(`Shape with unknown type ${t.type_} could not be added`);this.addShape(e,!1,!1,!1)}this.clearSelection(),this.invalidate(!1)}removeShape(e,t,i){void 0===i&&(i=!1),this.shapes.splice(this.shapes.indexOf(e),1),t&&Xe.emit("Shape.Remove",{shape:e.asDict(),temporary:i});const s=yt.visionSources.findIndex(t=>t.shape===e.uuid),n=mi.visionBlockers.findIndex(t=>t===e.uuid),o=yt.movementblockers.findIndex(t=>t===e.uuid),r=yt.annotations.findIndex(t=>t===e.uuid);s>=0&&yt.visionSources.splice(s,1),n>=0&&mi.visionBlockers.splice(n,1),o>=0&&yt.movementblockers.splice(o,1),r>=0&&yt.annotations.splice(r,1);const a=yt.annotations.indexOf(e.uuid);a>=0&&yt.annotations.splice(a,1);const l=yt.ownedtokens.indexOf(e.uuid);l>=0&&yt.ownedtokens.splice(l,1),xt.UUIDMap.delete(e.uuid);const c=this.selection.indexOf(e);c>=0&&this.selection.splice(c,1),n>=0&&mi.deleteFromTriag({target:bi.VISION,vertices:e.triagVertices,standalone:!0}),o>=0&&mi.deleteFromTriag({target:bi.MOVEMENT,vertices:e.triagVertices,standalone:!0}),this.invalidate(!t)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}clearSelection(){this.selection=[],Ke.$emit("SelectionInfo.Shape.Set",null)}draw(e){if(!this.valid){const t=this.ctx,i=t.globalCompositeOperation;e=void 0===e||e,e&&this.clear();const s=this;if(this.shapes.forEach(e=>{e.options.has("skipDraw")&&e.options.get("skipDraw")||void 0!==xt.getLayer()&&e.visibleInCanvas(s.canvas)&&("fow"===s.name&&e.visionObstruction&&xt.getLayer().name!==s.name||e.drawAuras(t))}),this.shapes.forEach(e=>{e.options.has("skipDraw")&&e.options.get("skipDraw")||0===e.labels.length&&yt.filterNoLabel||e.labels.length&&yt.labelFilters.length&&!e.labels.some(e=>yt.labelFilters.includes(e.uuid))||void 0!==xt.getLayer()&&e.visibleInCanvas(s.canvas)&&("fow"===s.name&&e.visionObstruction&&xt.getLayer().name!==s.name||e.draw(t))}),null!=this.selection){t.fillStyle=this.selectionColor,t.strokeStyle=this.selectionColor,t.lineWidth=this.selectionWidth;const e=yt.zoomFactor;this.selection.forEach(i=>{t.globalCompositeOperation=i.globalCompositeOperation;const s=i.getBoundingBox();t.strokeRect(ot(s.topLeft.x),rt(s.topLeft.y),s.w*e,s.h*e);for(const e of i.points)t.beginPath(),t.arc(ot(e[0]),rt(e[1]),3,0,2*Math.PI),t.fill();t.beginPath(),t.moveTo(ot(i.points[0][0]),rt(i.points[0][1]));for(let e=1;e<=i.points.length;e++){const s=i.points[e%i.points.length];t.lineTo(ot(s[0]),rt(s[1]))}t.stroke()})}t.globalCompositeOperation=i,this.valid=!0}}moveShapeOrder(e,t,i){const s=this.shapes.indexOf(e);s!==t&&(this.shapes.splice(s,1),this.shapes.splice(t,0,e),i&&Xe.emit("Shape.Order.Set",{shape:e.asDict(),index:t}),this.invalidate(!0))}}class $i{}function Ui(e,t,i){const s=xt.getLayer("draw");if(void 0===s)return;const n=s.ctx;n.lineJoin="round",n.strokeStyle=void 0===i?`rgb(${255*Math.random()}, ${255*Math.random()}, ${255*Math.random()})`:i,n.moveTo(ot(e[0]),rt(e[1])),n.beginPath(),n.arc(ot(e[0]),rt(e[1]),t,0,2*Math.PI),n.closePath(),n.stroke()}function Fi(e,t){const i=xt.getLayer("draw");if(void 0===i)return;const s=i.ctx;s.lineJoin="round",s.lineJoin="round",s.beginPath(),s.strokeStyle=void 0===t?`rgb(${255*Math.random()}, ${255*Math.random()}, ${255*Math.random()})`:t,s.moveTo(ot(e[0][0]),rt(e[0][1]));for(const n of e)s.lineTo(ot(n[0]),rt(n[1]));s.closePath(),s.stroke()}function zi(e,t){const i=xt.getLayer("draw");if(void 0===i)return;const s=i.ctx;s.lineJoin="round",s.lineJoin="round",s.beginPath(),s.strokeStyle=void 0===t?`rgb(${255*Math.random()}, ${255*Math.random()}, ${255*Math.random()})`:t,s.moveTo(e[0][0],e[0][1]);for(const n of e)s.lineTo(n[0],n[1]);s.closePath(),s.stroke()}function Bi(e,t){return t?e:ot(e)}function Hi(e,t){return t?e:rt(e)}$i.angleSteps=4,$i.drawAngleLines=!1,$i.drawFirstLightHit=!1,$i.skipPlayerFOW=!1,$i.skipLightFOW=!1,$i.tempFill="fog";let Gi=0,ji=0;function Wi(e,t,i,s){const n=xt.getLayer("draw");if(void 0===n)return;const o=n.ctx;o.beginPath(),o.strokeStyle=i?"rgba(255, 255, 0, 0.30)":"rgba(0, 0, 0, 0.30)",o.moveTo(Bi(e[0],s),Hi(e[1],s)),o.lineTo(Bi(t[0],s),Hi(t[1],s)),o.closePath(),o.stroke()}function Xi(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Gi=0,ji=0;let n=0;const o=xt.getLayer("draw");if(void 0===o)return;const r=o.ctx;i&&r.clearRect(0,0,window.innerWidth,window.innerHeight),r.lineJoin="round",r.lineJoin="round";const a=new oi(e);while(a.valid)a.next(),a.collect();a.collect();do{const e=a.edge.first.vertices[It(a.edge.second)].point,t=a.edge.first.vertices[Et(a.edge.second)].point;if(s>0){if(e[0]===-1/0||t[0]===-1/0){a.next();continue}ji++,a.edge.first.constraints[a.edge.second]?(Gi++,2===s&&console.log(`Edge: (*) ${e} > ${t}   (${a.edge.first.uid})`)):2===s&&console.log(`Edge: ${e} > ${t}   (${a.edge.first.uid})`)}do{a.next(),a.collect()}while(a.valid)}while(null!==a.pos);for(const l of e.triangles){if(l.isInfinite())continue;n++;const e=[];r.fillStyle="blue",void 0!==l.vertices[0]&&(e.push(l.vertices[0].point),r.beginPath(),r.arc(Bi(l.vertices[0].point[0],t),Hi(l.vertices[0].point[1],t),5,0,2*Math.PI),r.closePath(),r.fill()),void 0!==l.vertices[1]&&(e.push(l.vertices[1].point),r.arc(Bi(l.vertices[1].point[0],t),Hi(l.vertices[1].point[1],t),5,0,2*Math.PI),r.closePath(),r.fill()),void 0!==l.vertices[2]&&(e.push(l.vertices[2].point),r.arc(Bi(l.vertices[2].point[0],t),Hi(l.vertices[2].point[1],t),5,0,2*Math.PI),r.closePath(),r.fill()),2===s&&console.log(`[T ${l.uid}] `,...e,l.constraints),r.moveTo(Bi(l.vertices[0].point[0],t),Hi(l.vertices[0].point[1],t)),void 0!==l.vertices[0]&&void 0!==l.vertices[1]&&Wi(l.vertices[0].point,l.vertices[1].point,l.constraints[2],t),void 0!==l.vertices[1]&&void 0!==l.vertices[2]&&Wi(l.vertices[1].point,l.vertices[2].point,l.constraints[0],t),void 0!==l.vertices[2]&&void 0!==l.vertices[0]&&Wi(l.vertices[2].point,l.vertices[0].point,l.constraints[1],t)}s>0&&(console.log(`Edges: ${Gi}/${ji}`),console.log(`Faces: ${n}`))}function Yi(e,t,i){void 0===i&&(i=yt.drawTEContour);const s=[e.x,e.y],n=[],o=yi[t].locate(s,null).loc;return null===o?(console.error("Triangle not found"),[]):(n.push(o.vertices[1].point),o.isConstrained(0)||Ki(s,o.vertices[2].point,o.vertices[1].point,o,0,n),n.push(o.vertices[2].point),o.isConstrained(1)||Ki(s,o.vertices[0].point,o.vertices[2].point,o,1,n),n.push(o.vertices[0].point),o.isConstrained(2)||Ki(s,o.vertices[1].point,o.vertices[0].point,o,2,n),i&&Fi(n,"red"),n)}function Ki(e,t,i,s,n,o){const r=s.neighbours[n],a=r.indexT(s),l=It(a),c=Et(a),h=r.vertices[a],u=r.vertices[c],d=r.vertices[l],p=[r,l],f=[r,c],v=Pt(e,i,h.point),g=Pt(e,t,h.point);if(v===Zt.COUNTERCLOCKWISE)if(p[0].isConstrained(p[1]))i!==u.point&&o.push(qi(e,i,h.point,u.point)),g===Zt.COUNTERCLOCKWISE&&o.push(qi(e,t,h.point,u.point));else{if(g===Zt.COUNTERCLOCKWISE)return Ki(e,t,i,r,l,o);Ki(e,h.point,i,r,l,o)}if(v!==Zt.CLOCKWISE&&g!==Zt.COUNTERCLOCKWISE&&o.push(h.point),g===Zt.CLOCKWISE)return f[0].isConstrained(f[1])?(v===Zt.CLOCKWISE&&o.push(qi(e,i,h.point,d.point)),void(t!==d.point&&o.push(qi(e,t,h.point,d.point)))):v===Zt.CLOCKWISE?Ki(e,t,i,r,c,o):Ki(e,t,h.point,r,c,o)}function qi(e,t,i,s){const n=(s[1]-i[1])*(t[0]-e[0])-(s[0]-i[0])*(t[1]-e[1]),o=((s[0]-i[0])*(e[1]-i[1])-(s[1]-i[1])*(e[0]-i[0]))/n,r=e[0]+o*(t[0]-e[0]),a=e[1]+o*(t[1]-e[1]);return[r,a]}window.DC=Ui,window.DL=Wi,window.DP=Fi,window.DPL=zi,window.DPT=Xi;class Qi extends Vi{constructor(e,t){super(e,t),this.isVisionLayer=!0,this.preFogShapes=[],this.virtualCanvas=document.createElement("canvas"),this.virtualCanvas.width=window.innerWidth,this.virtualCanvas.height=window.innerHeight,this.vCtx=this.virtualCanvas.getContext("2d")}addShape(e,t,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];super.addShape(e,t,i,s),e.options.has("preFogShape")&&e.options.get("preFogShape")&&this.preFogShapes.push(e)}removeShape(e,t,i){if(e.options.has("preFogShape")&&e.options.get("preFogShape")){const t=this.preFogShapes.findIndex(t=>t.uuid===e.uuid);this.preFogShapes.splice(t,1)}super.removeShape(e,t,i)}draw(){if(!this.valid){const e=this.ctx;if($i.skipLightFOW)return e.clearRect(0,0,this.canvas.width,this.canvas.height),void(this.valid=!0);const t=e.globalCompositeOperation;e.clearRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="rgba(0, 0, 0, 1)";const i=xt.getLayer("draw").ctx;($i.drawAngleLines||$i.drawFirstLightHit)&&i.clearRect(0,0,i.canvas.width,i.canvas.height),yt.fullFOW&&xt.hasLayer("tokens")&&xt.getLayer("tokens").shapes.forEach(t=>{if(!t.ownedBy()||!t.isToken)return;const i=t.getBoundingBox(),s=nt(t.center()),n=.8*at(i.w);e.beginPath(),e.arc(s.x,s.y,n,0,2*Math.PI);const o=e.createRadialGradient(s.x,s.y,n/2,s.x,s.y,n);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=o,e.fill()}),this.vCtx.clearRect(0,0,window.innerWidth,window.innerHeight);for(const s of yt.visionSources){const t=xt.UUIDMap.get(s.shape);if(void 0===t)continue;const n=t.auras.find(e=>e.uuid===s.aura);if(void 0===n)continue;const o=lt(n.value+n.dim),r=t.center(),a=nt(r),l=new Oi(r,o);if(l.visibleInCanvas(e.canvas))if("bvh"===mi.visionMode){let t=-1;const s=new Path2D;let l;s.moveTo(a.x,a.y);for(let c=0;c<2*Math.PI;c+=$i.angleSteps/180*Math.PI){const h=new Qe(r.x+o*Math.cos(c),r.y+o*Math.sin(c));$i.drawAngleLines&&(i.beginPath(),i.moveTo(ot(r.x),rt(r.y)),i.lineTo(ot(h.x),rt(h.y)),i.stroke());const u=et.fromPoints(r,h),d=mi.BV.intersect(u);if(0===c&&(l=d.hit?d.intersect:h),d.hit)-1!==t&&(s.arc(a.x,a.y,ct(n.value+n.dim),t,c),t=-1),s.lineTo(ot(d.intersect.x),rt(d.intersect.y));else if(-1===t){t=c;const i=nt(h);e.lineTo(i.x,i.y)}}if(-1===t?s.lineTo(ot(l.x),rt(l.y)):s.arc(a.x,a.y,ct(n.value+n.dim),t,2*Math.PI),yt.fullFOW){if(n.dim>0){const t=e.createRadialGradient(a.x,a.y,ct(n.value),a.x,a.y,ct(n.value+n.dim));t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=t}else e.fillStyle="rgba(0, 0, 0, 1)";e.fill(s)}n.lastPath=s}else{this.vCtx.globalCompositeOperation="source-over",this.vCtx.fillStyle="rgba(0, 0, 0, 1)";const t=Yi(r,bi.VISION);this.vCtx.beginPath(),this.vCtx.moveTo(ot(t[0][0]),rt(t[0][1]));for(const e of t)this.vCtx.lineTo(ot(e[0]),rt(e[1]));if(this.vCtx.closePath(),this.vCtx.fill(),n.dim>0){const e=this.vCtx.createRadialGradient(a.x,a.y,ct(n.value),a.x,a.y,ct(n.value+n.dim));e.addColorStop(0,"rgba(0, 0, 0, 1)"),e.addColorStop(1,"rgba(0, 0, 0, 0)"),this.vCtx.fillStyle=e}else this.vCtx.fillStyle="rgba(0, 0, 0, 1)";this.vCtx.globalCompositeOperation="source-in",this.vCtx.beginPath(),this.vCtx.arc(a.x,a.y,ct(n.value+n.dim),0,2*Math.PI),this.vCtx.fill(),e.drawImage(this.virtualCanvas,0,0)}}yt.fowLOS&&(e.globalCompositeOperation="source-in",e.drawImage(xt.getLayer("fow-players").canvas,0,0));for(const s of this.preFogShapes){if(!s.visibleInCanvas(this.canvas))continue;const t=s.globalCompositeOperation;yt.fullFOW||("source-over"===s.globalCompositeOperation?s.globalCompositeOperation="destination-out":"destination-out"===s.globalCompositeOperation&&(s.globalCompositeOperation="source-over")),s.draw(e),s.globalCompositeOperation=t}yt.fullFOW&&(e.globalCompositeOperation="source-out",e.fillStyle=yt.getFogColour(),e.fillRect(0,0,e.canvas.width,e.canvas.height)),super.draw(!1),e.globalCompositeOperation=t}}}class Zi extends Vi{constructor(){super(...arguments),this.isVisionLayer=!0}draw(){if(!this.valid){const t=this.ctx;if(!yt.fowLOS||$i.skipPlayerFOW)return t.clearRect(0,0,this.canvas.width,this.canvas.height),void(this.valid=!0);t.clearRect(0,0,this.canvas.width,this.canvas.height);const i=t.globalCompositeOperation;t.fillStyle="rgba(0, 0, 0, 1)",yt.IS_DM||super.draw(!yt.fullFOW);const s=t.canvas.width+t.canvas.height;for(const n of yt.activeTokens){const i=xt.UUIDMap.get(n);if(void 0===i)continue;const o=i.center(),r=nt(o);if("bvh"===mi.visionMode){t.beginPath();let e=-1;for(let i=0;i<2*Math.PI;i+=$i.angleSteps/2/180*Math.PI){const n=Math.cos(i),a=Math.sin(i),l=new et(o,new Je(n,a)),c=mi.BV.intersect(l);c.hit?(-1!==e&&(t.arc(r.x,r.y,s,e,i),e=-1),t.lineTo(ot(c.intersect.x),rt(c.intersect.y))):-1===e&&(t.lineTo(r.x+s*n,r.y+s*a),e=i)}-1!==e?t.arc(r.x,r.y,s,e,2*Math.PI):t.closePath(),t.fill()}else{{const e=t.createRadialGradient(r.x,r.y,ct(yt.visionRangeMin),r.x,r.y,ct(yt.visionRangeMax));e.addColorStop(0,"rgba(0, 0, 0, 1)"),e.addColorStop(1,"rgba(0, 0, 0, 0)"),t.fillStyle=e}try{const s=Yi(i.center(),bi.VISION);t.beginPath(),t.moveTo(ot(s[0][0]),rt(s[0][1]));for(const e of s)t.lineTo(ot(e[0]),rt(e[1]));t.closePath(),t.fill()}catch(e){}}}yt.IS_DM&&super.draw(!yt.fullFOW),t.globalCompositeOperation=i}}}class Ji extends Vi{invalidate(){this.valid=!1}draw(e){this.valid||this.drawGrid()}drawGrid(){const e=this.ctx;this.clear(),e.beginPath();const t=yt.gridSize;for(let i=0;i<this.width;i+=t*yt.zoomFactor)e.moveTo(i+yt.panX%t*yt.zoomFactor,0),e.lineTo(i+yt.panX%t*yt.zoomFactor,this.height),e.moveTo(0,i+yt.panY%t*yt.zoomFactor),e.lineTo(this.width,i+yt.panY%t*yt.zoomFactor);e.strokeStyle=yt.gridColour,e.lineWidth=1,e.stroke(),this.valid=!0}}function es(e){const t=document.createElement("canvas");let i;t.style.zIndex=xt.layers.length.toString(),t.width=window.innerWidth,t.height=window.innerHeight,i="grid"===e.type_?new Ji(t,e.name):"fow"===e.type_?new Qi(t,e.name):"fow-players"===e.type_?new Zi(t,e.name):new Vi(t,e.name),i.selectable=e.selectable,i.playerEditable=e.player_editable,xt.addLayer(i);const s=document.getElementById("layers");null!==s?("fow-players"!==e.name&&s.appendChild(t),"grid"===e.type_&&e.size&&yt.setGridSize({gridSize:e.size,sync:!1}),i.setShapes(e.shapes)):console.warn("Layers div is missing, this will prevent the main game board from loading!")}function ts(e){const t=xt.getLayer();if(void 0===t||null===e||null===e.dataTransfer)return;const i=document.createElement("img");i.src=e.dataTransfer.getData("text/plain");const s=new Ii(i,new Qe(ut(e.clientX),dt(e.clientY)),pt(i.width),pt(i.height));if(s.src=new URL(i.src).pathname,yt.useGrid){const e=yt.gridSize;s.refPoint=new Qe(Math.round(s.refPoint.x/e)*e,Math.round(s.refPoint.y/e)*e),s.w=Math.max(Math.round(s.w/e)*e,e),s.h=Math.max(Math.round(s.h/e)*e,e)}t.addShape(s,!0)}class is{constructor(){this.shown=!1;const e=new Qe(0,0);this.annotationText=new Ni(e,"","bold 20px serif",0,"rgba(230, 230, 230, 1)"),this.annotationRect=new Di(e,0,0,"rgba(0, 0, 0, 0.6)")}setActiveText(e){if(void 0===this.layer){if(!xt.hasLayer("draw"))return void console.warn("There is no draw layer to draw annotations on!");this.layer=xt.getLayer("draw"),this.layer.addShape(this.annotationRect,!1),this.layer.addShape(this.annotationText,!1)}this.shown=""!==e,this.annotationText.refPoint=ht(new Ze(this.layer.canvas.width/2,50)),this.annotationText.text=e;const t=this.shown?this.annotationText.getMaxWidth(this.layer.ctx)+10:0,i=this.shown?this.annotationText.getMaxHeight(this.layer.ctx)+10:0;this.annotationRect.refPoint=ht(new Ze(this.layer.canvas.width/2-t/2,30)),this.annotationRect.w=t/yt.zoomFactor,this.annotationRect.h=i/yt.zoomFactor,this.layer.invalidate(!0)}}class ss{constructor(){this.selectedTool=0,this.annotationManager=new is}addShape(e){if(!xt.hasLayer(e.layer))return void console.log(`Shape with unknown layer ${e.layer} could not be added`);const t=xt.getLayer(e.layer),i=Ri(e);void 0!==i?(t.addShape(i,!1),t.invalidate(!1)):console.log(`Shape with unknown type ${e.type_} could not be added`)}updateShape(e){if(!xt.hasLayer(e.shape.layer))return void console.log(`Shape with unknown layer ${e.shape.layer} could not be added`);const t=Ri(e.shape);if(void 0===t)return void console.log(`Shape with unknown type ${e.shape.type_} could not be added`);const i=xt.UUIDMap.get(e.shape.uuid);if(void 0===i)return void console.log("Shape with unknown id could not be updated");const s=[...i.triagVertices],n=t.owners!==i.owners,o=Object.assign(i,t),r=o.checkVisionSources(),a=o.setMovementBlock(o.movementObstruction);o.setIsToken(o.isToken),e.redraw&&(o.visionObstruction&&!r&&(mi.deleteFromTriag({target:bi.VISION,vertices:s,standalone:!1}),mi.addToTriag({target:bi.VISION,points:o.points})),xt.getLayer(e.shape.layer).invalidate(!1),o.movementObstruction&&!a&&(mi.deleteFromTriag({target:bi.MOVEMENT,vertices:s,standalone:!1}),mi.addToTriag({target:bi.MOVEMENT,points:o.points}))),n&&Ke.$emit("Initiative.ForceUpdate")}setCenterPosition(e){const t=nt(e);yt.increasePanX((window.innerWidth/2-t.x)/yt.zoomFactor),yt.increasePanY((window.innerHeight/2-t.y)/yt.zoomFactor),xt.invalidate(),st(yt.locationOptions)}}const ns=new ss;window.gameManager=ns,Xe.on("connect",()=>{console.log("Connected")}),Xe.on("disconnect",()=>{console.log("Disconnected")}),Xe.on("connect_error",e=>{console.error("Could not connect to game session."),dr.push("/dashboard")}),Xe.on("error",e=>{console.error("Game session does not exist."),dr.push("/dashboard")}),Xe.on("redirect",e=>{console.log("redirecting"),dr.push(e)}),Xe.on("Room.Info.Set",e=>{yt.setRoomName(e.name),yt.setRoomCreator(e.creator),yt.setInvitationCode(e.invitationCode),yt.setIsLocked({isLocked:e.isLocked,sync:!1}),yt.setPlayers(e.players)}),Xe.on("Room.Info.InvitationCode.Set",e=>{yt.setInvitationCode(e),Ke.$emit("DmSettings.RefreshedInviteCode")}),Xe.on("Room.Info.Players.Add",e=>{yt.addPlayer(e)}),Xe.on("Username.Set",e=>{yt.setUsername(e),yt.setDM(e===decodeURIComponent(window.location.pathname.split("/")[2]))}),Xe.on("Client.Options.Set",e=>{yt.setGridColour({colour:e.grid_colour,sync:!1}),yt.setFOWColour({colour:e.fow_colour,sync:!1}),yt.setRulerColour({colour:e.ruler_colour,sync:!1}),yt.setPanX(e.pan_x),yt.setPanY(e.pan_y),yt.setZoomDisplay(gt(e.zoom_factor)),e.active_layer&&xt.selectLayer(e.active_layer,!1),void 0!==xt.getGridLayer()&&xt.getGridLayer().invalidate()}),Xe.on("Location.Set",e=>{void 0!==e.name&&yt.setLocationName(e.name),void 0!==e.unit_size&&yt.setUnitSize({unitSize:e.unit_size,sync:!1}),void 0!==e.use_grid&&yt.setUseGrid({useGrid:e.use_grid,sync:!1}),void 0!==e.full_fow&&yt.setFullFOW({fullFOW:e.full_fow,sync:!1}),void 0!==e.fow_opacity&&yt.setFOWOpacity({fowOpacity:e.fow_opacity,sync:!1}),void 0!==e.fow_los&&yt.setLineOfSight({fowLOS:e.fow_los,sync:!1}),void 0!==e.vision_min_range&&yt.setVisionRangeMin({value:e.vision_min_range,sync:!1}),void 0!==e.vision_max_range&&yt.setVisionRangeMax({value:e.vision_max_range,sync:!1}),void 0!==e.vision_mode&&(mi.setVisionMode({mode:e.vision_mode,sync:!1}),mi.recalculateVision(),mi.recalculateMovement())}),Xe.on("Position.Set",e=>{ns.setCenterPosition(new Qe(e.x,e.y))}),Xe.on("Notes.Set",e=>{for(const t of e)yt.newNote({note:t,sync:!1})}),Xe.on("Asset.List.Set",e=>{yt.setAssets(e)}),Xe.on("Board.Set",e=>{yt.clear(),yt.setLocations(e.locations),document.getElementById("layers").innerHTML="",yt.resetLayerInfo(),xt.reset();for(const t of e.layers)es(t);xt.selectLayer(xt.getLayer().name,!1),Ke.$emit("Initiative.Clear"),mi.recalculateVision(),mi.recalculateMovement(),yt.setBoardInitialized(!0)}),Xe.on("Gridsize.Set",e=>{yt.setGridSize({gridSize:e,sync:!1})}),Xe.on("Shape.Add",e=>{ns.addShape(e)}),Xe.on("Shape.Remove",e=>{if(!xt.UUIDMap.has(e.uuid))return void console.log("Attempted to remove an unknown shape");if(!xt.hasLayer(e.layer))return void console.log(`Attempted to remove shape from an unknown layer ${e.layer}`);const t=xt.getLayer(e.layer);t.removeShape(xt.UUIDMap.get(e.uuid),!1),t.invalidate(!1)}),Xe.on("Shape.Order.Set",e=>{if(!xt.UUIDMap.has(e.shape.uuid))return void console.log("Attempted to move the shape order of an unknown shape");if(!xt.hasLayer(e.shape.layer))return void console.log(`Attempted to remove shape from an unknown layer ${e.shape.layer}`);const t=xt.UUIDMap.get(e.shape.uuid),i=xt.getLayer(t.layer);i.moveShapeOrder(t,e.index,!1)}),Xe.on("Shape.Layer.Change",e=>{const t=xt.UUIDMap.get(e.uuid);void 0!==t&&t.moveLayer(e.layer,!1)}),Xe.on("Shape.Update",e=>{ns.updateShape(e)}),Xe.on("Temp.Clear",e=>{e.forEach(e=>{if(!xt.UUIDMap.has(e.uuid))return void console.log("Attempted to remove an unknown temporary shape");if(!xt.hasLayer(e.layer))return void console.log(`Attempted to remove shape from an unknown layer ${e.layer}`);const t=xt.UUIDMap.get(e.uuid);xt.getLayer(e.layer).removeShape(t,!1)})}),Xe.on("Labels.Set",e=>{for(const t of e)yt.addLabel(t)}),Xe.on("Label.Visibility.Set",e=>{yt.setLabelVisibility(e)}),Xe.on("Label.Add",e=>{yt.addLabel(e)}),Xe.on("Label.Delete",e=>{yt.deleteLabel(e)}),Xe.on("Labels.Filter.Add",e=>{yt.labelFilters.push(e),xt.invalidate()}),Xe.on("Labels.Filter.Remove",e=>{const t=yt.labelFilters.indexOf(e);t>=0&&(yt.labelFilters.splice(t,1),xt.invalidate())}),Xe.on("Labels.Filters.Set",e=>{yt.setLabelFilters(e)});var os=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("modal",{attrs:{visible:e.visible,mask:!1},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[i("div",[e._v("Initiative")]),i("div",{staticClass:"header-close",on:{click:function(t){e.visible=!1}}},[i("i",{staticClass:"far fa-window-close"})])])}}])},[i("div",{staticClass:"modal-body"},[i("draggable",{attrs:{id:"initiative-list",setData:e.fakeSetData,disabled:!e.$store.state.game.IS_DM},on:{change:e.updateOrder},model:{value:e.$store.state.initiative.data,callback:function(t){e.$set(e.$store.state.initiative,"data",t)},expression:"$store.state.initiative.data"}},[e._l(e.$store.state.initiative.data,function(t){return[i("div",{key:t.uuid,staticStyle:{display:"flex","flex-direction":"column","align-items":"flex-end"}},[i("div",{staticClass:"initiative-actor",class:{"initiative-selected":e.$store.state.initiative.currentActor===t.uuid},style:{cursor:e.$store.state.game.IS_DM&&"move"},on:{mouseenter:function(i){return e.toggleHighlight(t,!0)},mouseleave:function(i){return e.toggleHighlight(t,!1)}}},[t.has_img?[i("img",{attrs:{src:t.source,width:"30px",height:"30px"}})]:[i("span",{staticStyle:{width:"auto"}},[e._v(e._s(t.source))])],i("input",{directives:[{name:"model",rawName:"v-model.lazy.number",value:t.initiative,expression:"actor.initiative",modifiers:{lazy:!0,number:!0}}],class:{notAllowed:!e.owns(t)},attrs:{type:"text",placeholder:"value",disabled:!e.owns(t)},domProps:{value:t.initiative},on:{change:[function(i){e.$set(t,"initiative",e._n(i.target.value))},function(i){return e.syncInitiative(t)}],blur:function(t){return e.$forceUpdate()}}}),i("div",{staticClass:"initiative-effects-icon",class:{notAllowed:!e.owns(t)},staticStyle:{opacity:"0.6"},on:{click:function(i){e.createEffect(t,e.getDefaultEffect(),!0)}}},[i("i",{staticClass:"fas fa-stopwatch"}),t.effects?[e._v("\n                                "+e._s(t.effects.length)+"\n                            ")]:[e._v("\n                                0\n                            ")]],2),i("div",{class:{notAllowed:!e.owns(t)},style:{opacity:t.visible?"1.0":"0.3"},on:{click:function(i){return e.toggleOption(t,"visible")}}},[i("i",{staticClass:"fas fa-eye"})]),i("div",{class:{notAllowed:!e.owns(t)},style:{opacity:t.group?"1.0":"0.3"},on:{click:function(i){return e.toggleOption(t,"group")}}},[i("i",{staticClass:"fas fa-users"})]),i("div",{class:{notAllowed:!e.owns(t)},style:{opacity:e.owns(t)?"1.0":"0.3"},on:{click:function(i){return e.removeInitiative(t.uuid,!0,!0)}}},[i("i",{staticClass:"fas fa-trash-alt"})])],2),t.effects?i("div",{staticClass:"initiative-effect"},e._l(t.effects,function(s){return i("div",{key:s.uuid},[i("input",{directives:[{name:"model",rawName:"v-model",value:s.name,expression:"effect.name"}],attrs:{type:"text",size:s.name.length||1},domProps:{value:s.name},on:{change:function(i){return e.updateEffect(t.uuid,s,!0)},input:function(t){t.target.composing||e.$set(s,"name",t.target.value)}}}),i("input",{directives:[{name:"model",rawName:"v-model",value:s.turns,expression:"effect.turns"}],attrs:{type:"text",size:s.turns.toString().length||1},domProps:{value:s.turns},on:{change:function(i){return e.updateEffect(t.uuid,s,!0)},input:function(t){t.target.composing||e.$set(s,"turns",t.target.value)}}})])}),0):e._e()])]})],2),i("div",{attrs:{id:"initiative-bar"}},[i("div",{attrs:{id:"initiative-round"}},[e._v("Round "+e._s(e.$store.state.initiative.roundCounter))]),i("div",{staticStyle:{display:"flex"}}),i("div",{staticClass:"initiative-bar-button",style:e.visionLock?"background-color: #82c8a0":"",on:{click:e.toggleVisionLock}},[i("i",{staticClass:"fas fa-eye"})]),i("div",{staticClass:"initiative-bar-button",style:e.cameraLock?"background-color: #82c8a0":"",on:{click:function(t){e.cameraLock=!e.cameraLock}}},[i("i",{staticClass:"fas fa-video"})]),i("div",{staticClass:"initiative-bar-button",class:{notAllowed:!e.$store.state.game.IS_DM},on:{click:function(t){e.setRound(0,!0),e.updateTurn(e.$store.state.initiative.data[0].uuid,!0)}}},[i("i",{staticClass:"fas fa-sync-alt"})]),i("div",{staticClass:"initiative-bar-button",class:{notAllowed:!e.$store.state.game.IS_DM},on:{click:e.nextTurn}},[i("i",{staticClass:"fas fa-chevron-right"})])])],1)])},rs=[],as=i("310e"),ls=i.n(as);let cs=class extends I["d"]{constructor(){super(...arguments),this.data=[],this.currentActor=null,this.roundCounter=0}contains(e){return this.data.some(t=>t.uuid===e)}syncInitiative(e){D.emit("Initiative.Update",e)}clear(){this.data=[],this.currentActor=null}setData(e){this.data=e}addInitiative(e){const t=this.data.findIndex(t=>t.uuid===e.uuid);t>=0||(void 0===e.initiative&&(e.initiative=0),this.syncInitiative(e))}setRoundCounter(e){this.roundCounter=e}setTurn(e){this.currentActor=e}};v["a"]([I["c"]],cs.prototype,"clear",null),v["a"]([I["c"]],cs.prototype,"setData",null),v["a"]([I["c"]],cs.prototype,"addInitiative",null),v["a"]([I["c"]],cs.prototype,"setRoundCounter",null),v["a"]([I["c"]],cs.prototype,"setTurn",null),cs=v["a"]([Object(I["b"])({dynamic:!0,store:T,name:"initiative",namespaced:!0})],cs);const hs=Object(I["e"])(cs);s["default"].component("draggable",ls.a);let us=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.visionLock=!1,this.cameraLock=!1,this._activeTokens=[]}mounted(){Ke.$on("Initiative.Clear",hs.clear),Ke.$on("Initiative.Remove",e=>this.removeInitiative(e)),Ke.$on("Initiative.Show",()=>this.visible=!0),Ke.$on("Initiative.ForceUpdate",()=>this.$forceUpdate()),Xe.on("Initiative.Set",hs.setData),Xe.on("Initiative.Turn.Set",e=>this.setTurn(e)),Xe.on("Initiative.Turn.Update",e=>this.updateTurn(e,!1)),Xe.on("Initiative.Round.Update",e=>this.setRound(e,!1)),Xe.on("Initiative.Effect.New",e=>{const t=this.getActor(e.actor);void 0!==t&&this.createEffect(t,e.effect,!1)}),Xe.on("Initiative.Effect.Update",e=>this.updateEffect(e.actor,e.effect,!1))}beforeDestroy(){Ke.$off("Initiative.Clear"),Ke.$off("Initiative.Remove"),Ke.$off("Initiative.Show")}getActor(e){return hs.data.find(t=>t.uuid===e)}owns(e){if(yt.IS_DM)return!0;const t=xt.UUIDMap.get(e.uuid);return void 0!==t&&t.owners.includes(yt.username)}getDefaultEffect(){return{uuid:ae(),name:"New Effect",turns:10}}fakeSetData(e){e.setData("Hack","")}removeInitiative(e){const t=hs.data.findIndex(t=>t.uuid===e);if(t<0||hs.data[t].group)return;hs.syncInitiative({uuid:e});const i=xt.UUIDMap.get(e);void 0!==i&&i.showHighlight&&(i.showHighlight=!1,xt.getLayer(i.layer).invalidate(!0))}updateOrder(){yt.IS_DM&&Xe.emit("Initiative.Set",hs.data.map(e=>e.uuid))}updateTurn(e,t){if(!yt.IS_DM&&t)return;hs.currentActor=e;const i=hs.data.find(t=>t.uuid===e);if(void 0!==i){if(i.effects)for(let e=i.effects.length-1;e>=0;e--)i.effects[e].turns<=0?i.effects.splice(e,1):i.effects[e].turns--;if(this.visionLock&&(null!==e&&yt.ownedtokens.includes(e)?yt.setActiveTokens([e]):yt.setActiveTokens([])),this.cameraLock&&null!==e){const t=xt.UUIDMap.get(e);void 0!==t&&t.ownedBy()&&ns.setCenterPosition(t.center())}t&&Xe.emit("Initiative.Turn.Update",e)}}setRound(e,t){!yt.IS_DM&&t||(hs.setRoundCounter(e),t&&Xe.emit("Initiative.Round.Update",e))}setTurn(e){hs.setTurn(e)}nextTurn(){if(!yt.IS_DM)return;const e=hs.data,t=e[(e.findIndex(e=>e.uuid===hs.currentActor)+1)%e.length];hs.data[0].uuid===t.uuid&&this.setRound(hs.roundCounter+1,!0),this.updateTurn(t.uuid,!0)}toggleHighlight(e,t){const i=xt.UUIDMap.get(e.uuid);void 0!==i&&(i.showHighlight=t,xt.getLayer(i.layer).invalidate(!0))}toggleOption(e,t){this.owns(e)&&(e[t]=!e[t],hs.syncInitiative(e))}createEffect(e,t,i){this.owns(e)&&(e.effects.push(t),i&&Xe.emit("Initiative.Effect.New",{actor:e.uuid,effect:t}))}syncEffect(e,t){this.owns(e)&&Xe.emit("Initiative.Effect.Update",{actor:e.uuid,effect:t})}updateEffect(e,t,i){const s=hs.data.find(t=>t.uuid===e);if(void 0===s)return;const n=s.effects.findIndex(e=>e.uuid===t.uuid);void 0!==n&&(s.effects[n]=t,i?this.syncEffect(s,t):this.$forceUpdate())}toggleVisionLock(){this.visionLock=!this.visionLock,this.visionLock?(this._activeTokens=[...yt._activeTokens],null!==hs.currentActor&&yt.ownedtokens.includes(hs.currentActor)&&yt.setActiveTokens([hs.currentActor])):yt.setActiveTokens(this._activeTokens)}};us=v["a"]([Object(g["b"])({components:{Modal:Y,draggable:ls.a}})],us);var ds=us,ps=ds,fs=(i("291a"),Object(r["a"])(ps,os,rs,!1,null,"6bbba6d3",null)),vs=fs.exports,gs=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("Modal",{attrs:{visible:e.visible,mask:!1},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[i("div",[e._v("Label manager")]),i("div",{staticClass:"header-close",on:{click:function(t){e.visible=!1}}},[i("i",{staticClass:"far fa-window-close"})])])}}])},[i("div",{staticClass:"modal-body"},[i("div",{staticClass:"grid"},[i("div",{staticClass:"header"},[i("abbr",{attrs:{title:"Category"}},[e._v("Cat.")])]),i("div",{staticClass:"header name"},[e._v("Name")]),i("div",{staticClass:"header"},[i("abbr",{attrs:{title:"Visible"}},[e._v("Vis.")])]),i("div",{staticClass:"header"},[i("abbr",{attrs:{title:"Delete"}},[e._v("Del.")])]),i("div",{staticClass:"separator spanrow",staticStyle:{margin:"0 0 7px"}}),i("input",{directives:[{name:"model",rawName:"v-model",value:e.search,expression:"search"}],ref:"search",staticClass:"spanrow",attrs:{type:"text",placeholder:"search"},domProps:{value:e.search},on:{input:function(t){t.target.composing||(e.search=t.target.value)}}})]),i("div",{staticClass:"grid scroll"},[e._l(e.categories,function(t){return[e._l(e.labels[t],function(t){return[i("div",{key:"row-"+t.uuid,staticClass:"row",on:{click:function(i){return e.selectLabel(t.uuid)}}},[t.category?[i("div",{key:"cat-"+t.uuid},[e._v(e._s(t.category))]),i("div",{key:"name-"+t.uuid,staticClass:"name"},[e._v(e._s(t.name))])]:e._e(),t.category?e._e():[i("div",{key:"cat-"+t.uuid}),i("div",{key:"name-"+t.uuid,staticClass:"name"},[e._v(e._s(t.name))])],i("div",{key:"visible-"+t.uuid,class:{"lower-opacity":!t.visible},style:{textAlign:"center"},on:{click:function(i){return i.stopPropagation(),e.toggleVisibility(t)}}},[i("i",{staticClass:"fas fa-eye"})]),i("div",{key:"delete-"+t.uuid,on:{click:function(i){return i.stopPropagation(),e.deleteLabel(t.uuid)}}},[i("i",{staticClass:"fas fa-trash-alt"})])],2)]})]}),0===e.labels.length?[i("div",{attrs:{id:"no-labels"}},[e._v("No labels exist yet")])]:e._e()],2),i("div",{staticClass:"grid"},[i("div",{staticClass:"separator spanrow"}),i("input",{directives:[{name:"model",rawName:"v-model.trim",value:e.newCategory,expression:"newCategory",modifiers:{trim:!0}}],attrs:{type:"text"},domProps:{value:e.newCategory},on:{input:function(t){t.target.composing||(e.newCategory=t.target.value.trim())},blur:function(t){return e.$forceUpdate()}}}),i("input",{directives:[{name:"model",rawName:"v-model.trim",value:e.newName,expression:"newName",modifiers:{trim:!0}}],attrs:{type:"text"},domProps:{value:e.newName},on:{input:function(t){t.target.composing||(e.newName=t.target.value.trim())},blur:function(t){return e.$forceUpdate()}}}),i("button",{attrs:{id:"addLabelButton"},on:{click:function(t){return t.stopPropagation(),e.addLabel(t)}}},[e._v("Add")])])])])},ms=[];i("386d");let bs=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.newCategory="",this.newName="",this.search=""}mounted(){Ke.$on("LabelManager.Open",()=>{this.visible=!0,this.newCategory="",this.newName="",this.$nextTick(()=>this.$refs.search.focus())})}beforeDestroy(){Ke.$off("LabelManager.Open")}get labels(){const e={"":[]};for(const t of Object.keys(yt.labels)){const i=yt.labels[t];this.search.length&&`${i.category.toLowerCase()}${i.name.toLowerCase()}`.search(this.search.toLowerCase())<0||i.user===yt.username&&(i.category?(i.category in e||(e[i.category]=[]),e[i.category].push(i),e[i.category].sort((e,t)=>e.name.localeCompare(t.name))):e[""].push(i))}return e}get categories(){return Object.keys(this.labels).sort()}selectLabel(e){Ke.$emit("EditDialog.AddLabel",e),this.visible=!1}toggleVisibility(e){e.visible=!e.visible,Xe.emit("Label.Visibility.Set",{uuid:e.uuid,visible:e.visible})}addLabel(){if(""===this.newName)return;const e={uuid:ae(),category:this.newCategory,name:this.newName,visible:!1,user:yt.username};yt.addLabel(e),Xe.emit("Label.Add",e),this.newCategory="",this.newName=""}deleteLabel(e){yt.deleteLabel({uuid:e,user:yt.username}),Xe.emit("Label.Delete",e)}};bs=v["a"]([Object(g["b"])({components:{Modal:Y}})],bs);var ys=bs,ws=ys,xs=(i("ab66"),Object(r["a"])(ws,gs,ms,!1,null,"3261513c",null)),Cs=xs.exports,_s=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"menuContainer"}},[i("div",{ref:"rm",style:{left:e.visible.settings?"200px":"0",top:e.visible.locations?"100px":"0"},attrs:{id:"radialmenu"}},[i("div",{staticClass:"rm-wrapper"},[i("div",{staticClass:"rm-toggler"},[i("ul",{staticClass:"rm-list",class:{"rm-list-dm":e.IS_DM}},[e.IS_DM?i("li",{staticClass:"rm-item",attrs:{id:"rm-locations"},on:{click:function(t){e.visible.locations=!e.visible.locations}}},[e._m(0)]):e._e(),i("li",{staticClass:"rm-item",attrs:{id:"rm-settings"},on:{click:function(t){e.visible.settings=!e.visible.settings}}},[e._m(1)])])]),e._m(2)])]),i("transition",{attrs:{name:"settings"},on:{enter:function(t){e.$refs.rm.style.transition="left 500ms"}}},[e.visible.settings?i("div",{ref:"settings",attrs:{id:"menu"},on:{click:e.settingsClick}},[i("div",{staticStyle:{width:"200px",height:"90%","overflow-y":"auto","overflow-x":"hidden"}},[e.IS_DM?[i("button",{staticClass:"menu-accordion"},[e._v("Assets")]),i("div",{staticClass:"menu-accordion-panel"},[i("a",{staticClass:"actionButton",attrs:{href:"/assets",target:"blank",title:"Open asset manager"}},[i("i",{staticClass:"fas fa-external-link-alt"})]),i("div",{staticClass:"directory",attrs:{id:"menu-tokens"}},[i("asset-node",{attrs:{asset:e.assets}}),e.assets?e._e():i("div",[e._v("No assets")])],1)]),i("button",{staticClass:"menu-accordion"},[e._v("Notes")]),i("div",{staticClass:"menu-accordion-panel"},[i("div",{staticClass:"menu-accordion-subpanel",attrs:{id:"menu-notes"}},[i("a",{staticClass:"actionButton",on:{click:e.createNote}},[i("i",{staticClass:"far fa-plus-square"})]),e._l(e.notes,function(t){return i("div",{key:t.uuid,staticStyle:{cursor:"pointer"},on:{click:function(i){return e.openNote(t)}}},[e._v("\n                                "+e._s(t.title||"[?]")+"\n                            ")])}),e.notes.length?e._e():i("div",[e._v("No notes")])],2)]),i("button",{staticClass:"menu-accordion",on:{click:e.openDmSettings}},[e._v("DM Options")])]:e._e(),i("button",{staticClass:"menu-accordion"},[e._v("Client Options")]),i("div",{staticClass:"menu-accordion-panel"},[i("div",{staticClass:"menu-accordion-subpanel"},[i("label",{attrs:{for:"gridColour"}},[e._v("Grid Colour:")]),i("color-picker",{attrs:{id:"gridColour",color:e.gridColour},on:{"update:color":function(t){e.gridColour=t}}}),i("label",{attrs:{for:"fowColour"}},[e._v("FOW Colour:")]),i("color-picker",{attrs:{id:"fowColour",color:e.fowColour},on:{"update:color":function(t){e.fowColour=t}}}),i("label",{attrs:{for:"rulerColour"}},[e._v("Ruler Colour:")]),i("color-picker",{attrs:{id:"rulerColour",color:e.rulerColour},on:{"update:color":function(t){e.rulerColour=t}}})],1)])],2),i("router-link",{staticClass:"menu-accordion",staticStyle:{"text-decoration":"none",display:"inline-block",position:"absolute",bottom:"0"},attrs:{to:"/dashboard"}},[e._v("\n                Exit\n            ")])],1):e._e()]),i("transition",{attrs:{name:"locations"},on:{enter:function(t){e.$refs.rm.style.transition="top 500ms"}}},[e.IS_DM&&e.visible.locations?i("div",{attrs:{id:"locations-menu"}},[i("div",[e._l(e.locations,function(t){return i("div",{key:t,on:{click:function(i){return e.changeLocation(t)}}},[e._v("\n                    "+e._s(t)+"\n                ")])}),i("div",{on:{click:e.createLocation}},[i("i",{staticClass:"fas fa-plus"})])],2)]):e._e()]),i("img",{attrs:{id:"dragImage"}})],1)},Ss=[function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("a",{attrs:{href:"#"}},[i("i",{staticClass:"far fa-compass"})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("a",{attrs:{href:"#"}},[i("i",{staticClass:"fas fa-cog"})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",{staticClass:"rm-topper"},[i("i",{staticClass:"icon-share-alt"})])}],ks=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"outer",on:{click:function(t){return t.target!==t.currentTarget?null:e.open(t)}}},[i("div",{staticClass:"current-color",style:e.transparent?"background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAIAAADZF8uwAAAAGUlEQVQYV2M4gwH+YwCGIasIUwhT25BVBADtzYNYrHvv4gAAAABJRU5ErkJggg==)":"background-color:"+e.color,on:{click:function(t){return t.target!==t.currentTarget?null:e.open(t)}}}),i("div",{directives:[{name:"show",rawName:"v-show",value:e.display,expression:"display"}],staticClass:"mask",on:{click:function(t){return t.target!==t.currentTarget?null:e.closePicker(t)}}}),i("chrome-picker",{directives:[{name:"show",rawName:"v-show",value:e.display,expression:"display"}],ref:"chromePicker",style:{position:"fixed",left:e.left+"px",top:e.top+"px","z-index":9999},attrs:{value:e.color,tabindex:"-1"},on:{input:e.updateColor}})],1)},Ls=[],Es=i("c345");let Is=class extends s["default"]{constructor(){super(...arguments),this.display=!1,this.left=0,this.top=0,this.transparent=!1}mounted(){this.transparent=0===this.$refs.chromePicker.val.rgba.a,this.setPosition()}open(){this.display||this.disabled||(this.setPosition(),this.display=!0,this.$nextTick(()=>this.$children[0].$el.focus()))}updateColor(e){this.transparent=0===e.rgba.a;const t=it()(e.rgba).toRgbString();this.$emit("update:color",t),this.$emit("input",t)}closePicker(){this.display=!1,this.$emit("change",this.color)}setPosition(){const e=this.$el.getBoundingClientRect();e.right+224>window.innerWidth?this.left=e.left-224:this.left=e.right,e.bottom+242>window.innerHeight?this.top=e.top-242:this.top=e.bottom}};v["a"]([Object(H["a"])(String)],Is.prototype,"color",void 0),v["a"]([Object(H["a"])(Boolean)],Is.prototype,"disabled",void 0),Is=v["a"]([Object(g["b"])({components:{"chrome-picker":Es["Chrome"]}})],Is);var Os=Is,Ts=Os,Ms=(i("618b"),Object(r["a"])(Ts,ks,Ls,!1,null,"24ff2c54",null)),Ps=Ms.exports,Ds=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[e._l(e.folders,function(t){return i("li",{key:t,staticClass:"folder",on:{click:function(t){return t.stopPropagation(),e.toggle(t)}}},[e._v("\n        "+e._s(t)+"\n        "),i("asset-node",{attrs:{asset:e.asset[t]}})],1)}),e._l(e.files,function(t){return i("li",{key:t.name,staticClass:"file draggable token",attrs:{draggable:"true"},on:{mouseover:function(i){e.showImage=t.hash},mouseout:function(t){e.showImage=null},dragstart:function(i){return e.dragStart(i,"/static/assets/"+t.hash)}}},[e._v("\n        "+e._s(t.name)+"\n        "),e.showImage==t.hash?i("div",{staticClass:"preview"},[i("img",{staticClass:"asset-preview-image",attrs:{src:"/static/assets/"+t.hash}})]):e._e()])})],2)},Ns=[];let As=class extends s["default"]{constructor(){super(...arguments),this.showImage=null}get folders(){return Object.keys(this.asset).filter(e=>!["__files"].includes(e)).sort(le)}get files(){return this.asset.__files?this.asset.__files.concat().sort((e,t)=>e.name.toLowerCase()>t.name.toLowerCase()?1:-1):[]}toggle(e){for(let t=0;t<e.target.children.length;t++){const i=e.target.children[t];i.style.display=""===i.style.display?"block":""}}dragStart(e,t){if(this.showImage=null,null===e||null===e.dataTransfer)return;const i=e.target.querySelector(".preview");e.dataTransfer.setDragImage(i,0,0),e.dataTransfer.setData("text/plain",t)}};v["a"]([Object(H["a"])()],As.prototype,"asset",void 0),As=v["a"]([Object(g["b"])({name:"asset-node"})],As);var Rs=As,Vs=Rs,$s=(i("3ba3"),Object(r["a"])(Vs,Ds,Ns,!1,null,"03f9ac64",null)),Us=$s.exports;let Fs=class extends s["default"]{constructor(){super(...arguments),this.visible={settings:!1,locations:!1}}get IS_DM(){return yt.IS_DM||yt.FAKE_PLAYER}get gridColour(){return yt.gridColour}set gridColour(e){yt.setGridColour({colour:e,sync:!0})}get fowColour(){return yt.fowColour}set fowColour(e){yt.setFOWColour({colour:e,sync:!0})}get rulerColour(){return yt.rulerColour}set rulerColour(e){yt.setRulerColour({colour:e,sync:!0})}settingsClick(e){if(e.target.classList.contains("menu-accordion")){e.target.classList.toggle("menu-accordion-active");const t=e.target.nextElementSibling;null!==t&&(t.style.display=""===t.style.display?"block":"")}}changeLocation(e){Xe.emit("Location.Change",e)}createLocation(){this.$parent.$parent.$refs.prompt.prompt("New location name:","Create new location").then(e=>{Xe.emit("Location.New",e)},()=>{})}createNote(){const e={title:"New note",text:"",uuid:ae()};yt.newNote({note:e,sync:!0}),this.openNote(e)}openNote(e){this.$parent.$parent.$refs.note.open(e)}openDmSettings(){Ke.$emit("DmSettings.Open")}};Fs=v["a"]([Object(g["b"])({components:{"color-picker":Ps,"asset-node":Us},computed:Object.assign({},Object(O["b"])("game",["locations","assets","notes"]))})],Fs);var zs=Fs,Bs=zs,Hs=(i("6146"),Object(r["a"])(Bs,_s,Ss,!1,null,"9190ff3e",null)),Gs=Hs.exports,js=function(){var e=this,t=e.$createElement,i=e._self._c||t;return null!==e.note?i("modal",{attrs:{visible:e.visible,mask:!1},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[i("span",{on:{click:function(t){return e.$refs.title.select()}}},[i("i",{staticClass:"fas fa-pencil-alt",staticStyle:{"font-size":"15px"}})]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.note.title,expression:"note.title"}],ref:"title",domProps:{value:e.note.title},on:{change:e.updateNote,input:function(t){t.target.composing||e.$set(e.note,"title",t.target.value)}}}),i("div",{staticClass:"header-close",on:{click:function(t){e.visible=!1}}},[i("i",{staticClass:"far fa-window-close"})])])}}],null,!1,1320213373)},[i("div",{staticClass:"modal-body"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.note.text,expression:"note.text"}],ref:"textarea",style:{height:e.calcHeight()},domProps:{value:e.note.text},on:{change:e.updateNote,input:function(t){t.target.composing||e.$set(e.note,"text",t.target.value)}}})]),i("div",{staticClass:"modal-footer"},[i("button",{on:{click:e.removeNote}},[i("i",{staticClass:"far fa-trash-alt"}),e._v("\n            Remove\n        ")])])]):e._e()},Ws=[];let Xs=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.note=null}open(e){this.visible=!0,this.note=e}calcHeight(){if(this.$refs.textarea){const e=this.$refs.textarea;return e.style.height="auto",e.style.height=e.scrollHeight+"px",e.scrollHeight+"px"}return"100px"}updateNote(){this.note&&yt.updateNote({note:this.note,sync:!0})}removeNote(){this.$parent.$parent.$refs.confirm.open("Are you sure you wish to remove this?").then(e=>{e&&this.note&&(yt.removeNote({note:this.note,sync:!0}),this.visible=!1)},()=>{})}};Xs=v["a"]([Object(g["b"])({components:{Modal:Y}})],Xs);var Ys=Xs,Ks=Ys,qs=(i("57af"),Object(r["a"])(Ks,js,Ws,!1,null,"2c1a0e9a",null)),Qs=qs.exports,Zs=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{directives:[{name:"show",rawName:"v-show",value:e.shapes.length>0,expression:"shapes.length > 0"}]},e._l(e.shapes,function(t){return i("div",{key:t.uuid},[i("div",{attrs:{id:"selection-menu"}},[i("div",{attrs:{id:"selection-edit-button"},on:{click:e.openEditDialog}},[i("i",{staticClass:"fas fa-edit"})]),i("div",{attrs:{id:"selection-name"}},[e._v(e._s(t.name))]),i("div",{attrs:{id:"selection-trackers"}},[e._l(e.visibleTrackers,function(t){return[i("div",{key:"name-"+t.uuid},[e._v(e._s(t.name))]),i("div",{key:"value-"+t.uuid,staticClass:"selection-tracker-value",on:{click:function(i){return e.changeValue(t,!1)}}},[0===t.maxvalue?[e._v("\n                            "+e._s(t.value)+"\n                        ")]:[e._v("\n                            "+e._s(t.value)+" / "+e._s(t.maxvalue)+"\n                        ")]],2)]})],2),i("div",{attrs:{id:"selection-auras"}},[e._l(e.visibleAuras,function(t){return[i("div",{key:"name-"+t.uuid},[e._v(e._s(t.name))]),i("div",{key:"value-"+t.uuid,staticClass:"selection-tracker-value",on:{click:function(i){return e.changeValue(t,!0)}}},[0===t.dim?[e._v("\n                            "+e._s(t.value)+"\n                        ")]:[e._v("\n                            "+e._s(t.value)+" / "+e._s(t.dim)+"\n                        ")]],2)]})],2)]),i("edit-dialog",{ref:"editDialog",refInFor:!0,attrs:{shape:t}})],1)}),0)},Js=[],en=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("Modal",{attrs:{visible:e.visible,mask:!1},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[i("div",[e._v("Edit asset")]),i("div",{staticClass:"header-close",on:{click:function(t){e.visible=!1}}},[i("i",{staticClass:"far fa-window-close"})])])}}])},[i("div",{staticClass:"modal-body"},[i("div",{staticClass:"grid"},[i("label",{attrs:{for:"shapeselectiondialog-name"}},[e._v("Name")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.shape.name,expression:"shape.name"}],staticStyle:{"grid-column":"numerator / remove"},attrs:{type:"text",id:"shapeselectiondialog-name",disabled:!e.owned},domProps:{value:e.shape.name},on:{change:function(t){return e.updateShape(!1)},input:function(t){t.target.composing||e.$set(e.shape,"name",t.target.value)}}}),i("div",{style:{opacity:e.shape.nameVisible?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(t){e.shape.nameVisible=!e.shape.nameVisible,e.updateShape(!1)}}},[i("i",{staticClass:"fas fa-eye"})]),i("label",{attrs:{for:"shapeselectiondialog-istoken"}},[e._v("Is a token")]),i("input",{staticClass:"styled-checkbox",staticStyle:{"grid-column-start":"remove"},attrs:{type:"checkbox",id:"shapeselectiondialog-istoken",disabled:!e.owned},domProps:{checked:e.shape.isToken},on:{click:e.setToken}}),i("label",{attrs:{for:"shapeselectiondialog-visionblocker"}},[e._v("Blocks vision/light")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.shape.visionObstruction,expression:"shape.visionObstruction"}],staticStyle:{"grid-column-start":"remove"},attrs:{type:"checkbox",id:"shapeselectiondialog-visionblocker",disabled:!e.owned},domProps:{checked:Array.isArray(e.shape.visionObstruction)?e._i(e.shape.visionObstruction,null)>-1:e.shape.visionObstruction},on:{change:[function(t){var i=e.shape.visionObstruction,s=t.target,n=!!s.checked;if(Array.isArray(i)){var o=null,r=e._i(i,o);s.checked?r<0&&e.$set(e.shape,"visionObstruction",i.concat([o])):r>-1&&e.$set(e.shape,"visionObstruction",i.slice(0,r).concat(i.slice(r+1)))}else e.$set(e.shape,"visionObstruction",n)},e.setVisionBlocker]}}),i("label",{attrs:{for:"shapeselectiondialog-moveblocker"}},[e._v("Blocks movement")]),i("input",{staticStyle:{"grid-column-start":"remove"},attrs:{type:"checkbox",id:"shapeselectiondialog-moveblocker",disabled:!e.owned},domProps:{checked:e.shape.movementObstruction},on:{click:e.setMovementBlocker}}),i("label",{attrs:{for:"shapeselectiondialog-strokecolour"}},[e._v("Border colour")]),i("color-picker",{staticStyle:{"grid-column-start":"remove"},attrs:{color:e.shape.strokeColour,disabled:!e.owned},on:{"update:color":function(t){return e.$set(e.shape,"strokeColour",t)},input:function(t){return e.updateShape(!0,!0)},change:function(t){return e.updateShape(!0)}}}),i("label",{attrs:{for:"shapeselectiondialog-fillcolour"}},[e._v("Fill colour")]),i("color-picker",{staticStyle:{"grid-column-start":"remove"},attrs:{color:e.shape.fillColour,disabled:!e.owned},on:{"update:color":function(t){return e.$set(e.shape,"fillColour",t)},input:function(t){return e.updateShape(!0,!0)},change:function(t){return e.updateShape(!0)}}}),i("div",{staticClass:"spanrow header"},[e._v("Access")]),e._l(e.shape.owners,function(t){return[i("input",{key:t,staticStyle:{"grid-column-start":"name"},attrs:{type:"text",placeholder:"name",disabled:!e.owned},domProps:{value:t},on:{change:function(i){return e.updateOwner(i,t)}}}),""!==t?i("div",{key:"remove-"+t,style:{opacity:e.owned?1:.3,textAlign:"center",gridColumnStart:"remove"},attrs:{disabled:!e.owned},on:{click:function(i){return e.removeOwner(t)}}},[i("i",{staticClass:"fas fa-trash-alt"})]):e._e()]}),i("div",{staticClass:"spanrow header"},[e._v("Trackers")]),e._l(e.shape.trackers,function(t){return[i("input",{directives:[{name:"model",rawName:"v-model",value:t.name,expression:"tracker.name"}],key:"name-"+t.uuid,staticStyle:{"grid-column-start":"name"},attrs:{type:"text",placeholder:"name",disabled:!e.owned},domProps:{value:t.name},on:{change:function(t){return e.updateShape(!1)},input:function(i){i.target.composing||e.$set(t,"name",i.target.value)}}}),i("input",{directives:[{name:"model",rawName:"v-model.number",value:t.value,expression:"tracker.value",modifiers:{number:!0}}],key:"value-"+t.uuid,attrs:{type:"text",title:"Current value",disabled:!e.owned},domProps:{value:t.value},on:{change:function(t){return e.updateShape(!1)},input:function(i){i.target.composing||e.$set(t,"value",e._n(i.target.value))},blur:function(t){return e.$forceUpdate()}}}),i("span",{key:"fspan-"+t.uuid},[e._v("/")]),i("input",{directives:[{name:"model",rawName:"v-model.number",value:t.maxvalue,expression:"tracker.maxvalue",modifiers:{number:!0}}],key:"maxvalue-"+t.uuid,attrs:{type:"text",title:"Current value",disabled:!e.owned},domProps:{value:t.maxvalue},on:{change:function(t){return e.updateShape(!1)},input:function(i){i.target.composing||e.$set(t,"maxvalue",e._n(i.target.value))},blur:function(t){return e.$forceUpdate()}}}),i("span",{key:"sspan-"+t.uuid}),i("div",{key:"visibility-"+t.uuid,style:{opacity:t.visible?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(i){t.visible=!t.visible,e.updateShape(!1)}}},[i("i",{staticClass:"fas fa-eye"})]),i("span",{key:"tspan-"+t.uuid}),""!==t.name||0!==t.value?i("div",{key:"remove-"+t.uuid,style:{opacity:e.owned?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(i){return e.removeTracker(t.uuid)}}},[i("i",{staticClass:"fas fa-trash-alt"})]):e._e()]}),i("div",{staticClass:"spanrow header"},[e._v("Auras")]),e._l(e.shape.auras,function(t){return[i("input",{directives:[{name:"model",rawName:"v-model",value:t.name,expression:"aura.name"}],key:"name-"+t.uuid,staticStyle:{"grid-column-start":"name"},attrs:{type:"text",placeholder:"name",disabled:!e.owned},domProps:{value:t.name},on:{change:function(t){return e.updateShape(!1)},input:function(i){i.target.composing||e.$set(t,"name",i.target.value)}}}),i("input",{directives:[{name:"model",rawName:"v-model.number",value:t.value,expression:"aura.value",modifiers:{number:!0}}],key:"value-"+t.uuid,attrs:{type:"text",title:"Current value",disabled:!e.owned},domProps:{value:t.value},on:{change:function(t){return e.updateShape(!0)},input:function(i){i.target.composing||e.$set(t,"value",e._n(i.target.value))},blur:function(t){return e.$forceUpdate()}}}),i("span",{key:"fspan-"+t.uuid},[e._v("/")]),i("input",{directives:[{name:"model",rawName:"v-model.number",value:t.dim,expression:"aura.dim",modifiers:{number:!0}}],key:"dimvalue-"+t.uuid,attrs:{type:"text",title:"Dim value",disabled:!e.owned},domProps:{value:t.dim},on:{change:function(t){return e.updateShape(!0)},input:function(i){i.target.composing||e.$set(t,"dim",e._n(i.target.value))},blur:function(t){return e.$forceUpdate()}}}),i("color-picker",{key:"colour-"+t.uuid,attrs:{color:t.colour,disabled:!e.owned},on:{"update:color":function(i){return e.$set(t,"colour",i)},input:function(i){return e.updateAuraColour(t,i)},change:function(t){return e.updateShape(!0)}}}),i("div",{key:"visibility-"+t.uuid,style:{opacity:t.visible?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(i){t.visible=!t.visible,e.updateShape(!0)}}},[i("i",{staticClass:"fas fa-eye"})]),i("div",{key:"visionsource-"+t.uuid,style:{opacity:t.visionSource?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(i){return e.updateAuraVisionSource(t)}}},[i("i",{staticClass:"fas fa-lightbulb"})]),""!==t.name||0!==t.value?i("div",{key:"remove-"+t.uuid,style:{opacity:e.owned?1:.3,textAlign:"center"},attrs:{disabled:!e.owned},on:{click:function(i){return e.removeAura(t.uuid)}}},[i("i",{staticClass:"fas fa-trash-alt"})]):e._e()]}),i("div",{staticClass:"spanrow header"},[e._v("Labels")]),i("div",{staticClass:"spanrow",attrs:{id:"labels"}},[e._l(e.shape.labels,function(t){return i("div",{key:t.uuid,staticClass:"label"},[t.category?[i("div",{staticClass:"label-user"},[e._v(e._s(t.category))]),i("div",{staticClass:"label-main",on:{click:function(i){return e.removeLabel(t.uuid)}}},[e._v(e._s(t.name))])]:e._e(),t.category?e._e():[i("div",{staticClass:"label-main",on:{click:function(i){return e.removeLabel(t.uuid)}}},[e._v(e._s(t.name))])]],2)}),e.owned?i("div",{staticClass:"label",attrs:{id:"label-add"}},[i("div",{staticClass:"label-main",on:{click:e.openLabelManager}},[e._v("+")])]):e._e()],2),i("div",{staticClass:"spanrow header"},[e._v("Annotation")]),i("textarea",{staticClass:"spanrow",attrs:{disabled:!e.owned},domProps:{value:e.shape.annotation},on:{change:e.updateAnnotation}})],2)])])},tn=[];let sn=class extends s["default"]{constructor(){super(...arguments),this.visible=!1}get owned(){return this.shape.ownedBy()}mounted(){Ke.$on("EditDialog.Open",e=>{this.shape=e,this.visible=!0}),Ke.$on("EditDialog.AddLabel",e=>{this.visible&&(this.shape.labels.push(yt.labels[e]),this.updateShape(!0))})}beforeDestroy(){Ke.$off("EditDialog.Open"),Ke.$off("EditDialog.AddLabel")}updated(){this.addEmpty()}addEmpty(){""!==this.shape.owners[this.shape.owners.length-1]&&this.shape.addOwner(""),this.shape.trackers.length&&""===this.shape.trackers[this.shape.trackers.length-1].name&&0===this.shape.trackers[this.shape.trackers.length-1].value||this.shape.trackers.push({uuid:ae(),name:"",value:0,maxvalue:0,visible:!1}),this.shape.auras.length&&""===this.shape.auras[this.shape.auras.length-1].name&&0===this.shape.auras[this.shape.auras.length-1].value||this.shape.auras.push({uuid:ae(),name:"",value:0,dim:0,visionSource:!1,colour:"rgba(0,0,0,0)",visible:!1})}updateShape(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.owned&&(Xe.emit("Shape.Update",{shape:this.shape.asDict(),redraw:e,temporary:t}),e&&xt.invalidate(),this.addEmpty())}setToken(e){this.owned&&(this.shape.setIsToken(e.target.checked),this.updateShape(!0))}setVisionBlocker(e){this.owned&&(this.shape.checkVisionSources(),this.updateShape(!0))}setMovementBlocker(e){this.owned&&(this.shape.setMovementBlock(e.target.checked),this.updateShape(!1))}updateAnnotation(e){if(!this.owned)return;const t=""!==this.shape.annotation;this.shape.annotation=e.target.value,""===this.shape.annotation||t?""===this.shape.annotation&&t&&(yt.annotations.splice(yt.annotations.findIndex(e=>e===this.shape.uuid)),xt.hasLayer("draw")&&xt.getLayer("draw").invalidate(!0)):(yt.annotations.push(this.shape.uuid),xt.hasLayer("draw")&&xt.getLayer("draw").invalidate(!0)),this.updateShape(!1)}updateOwner(e,t){this.owned&&(this.shape.updateOwner(t,e.target.value),this.updateShape(yt.fowLOS))}removeOwner(e){this.owned&&(this.shape.removeOwner(e),this.updateShape(yt.fowLOS))}removeTracker(e){this.owned&&(this.shape.trackers=this.shape.trackers.filter(t=>t.uuid!==e),this.updateShape(!1))}removeAura(e){this.owned&&(this.shape.auras=this.shape.auras.filter(t=>t.uuid!==e),this.shape.checkVisionSources(),this.updateShape(!0))}updateAuraVisionSource(e){if(!this.owned)return;e.visionSource=!e.visionSource;const t=yt.visionSources.findIndex(t=>t.aura===e.uuid);e.visionSource&&-1===t?yt.visionSources.push({shape:this.shape.uuid,aura:e.uuid}):!e.visionSource&&t>=0&&yt.visionSources.splice(t,1),this.updateShape(!0)}updateAuraColour(e,t){if(!this.owned)return;const i=xt.getLayer(this.shape.layer);void 0!==i&&i.invalidate(!e.visionSource)}openLabelManager(){Ke.$emit("LabelManager.Open")}removeLabel(e){this.owned&&(this.shape.labels=this.shape.labels.filter(t=>t.uuid!==e),this.updateShape(!0))}};v["a"]([Object(H["a"])()],sn.prototype,"shape",void 0),sn=v["a"]([Object(g["b"])({components:{Modal:Y,"color-picker":Ps}})],sn);var nn=sn,on=nn,rn=(i("6da0"),Object(r["a"])(on,en,tn,!1,null,"40314b6e",null)),an=rn.exports;let ln=class extends s["default"]{constructor(){super(...arguments),this.shape=null}mounted(){Ke.$on("SelectionInfo.Shape.Set",e=>{this.shape=e})}get shapes(){return null===this.shape?[]:[this.shape]}get visibleTrackers(){return null===this.shape?[]:this.shape.trackers.filter(e=>""!==e.name||0!==e.value)}get visibleAuras(){return null===this.shape?[]:this.shape.auras.filter(e=>""!==e.name||0!==e.value)}beforeDestroy(){Ke.$off("SelectionInfo.Shape.Set")}openEditDialog(){this.$refs.editDialog.visible=!0}changeValue(e,t){null!==this.shape&&this.$parent.$parent.$refs.prompt.prompt(`New  ${e.name} value:`,`Updating ${e.name}`).then(i=>{if(null===this.shape)return;const s=e.value;"+"===i[0]||"-"===i[0]?e.value+=parseInt(i,10):e.value=parseInt(i,10),isNaN(e.value)&&(e.value=s),Xe.emit("Shape.Update",{shape:this.shape.asDict(),redraw:t,temporary:!1}),t&&xt.invalidate()},()=>{})}};ln=v["a"]([Object(g["b"])({components:{"edit-dialog":an}})],ln);var cn=ln,hn=cn,un=(i("ae5a"),Object(r["a"])(hn,Zs,Js,!1,null,"4ce4ab65",null)),dn=un.exports,pn=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("div",{attrs:{id:"toolselect"}},[i("ul",e._l(e.visibleTools,function(t){return i("li",{directives:[{name:"show",rawName:"v-show",value:e.toolVisible(t),expression:"toolVisible(tool)"}],key:t,ref:t+"-selector",refInFor:!0,class:{"tool-selected":e.currentTool===t},on:{mousedown:function(i){e.currentTool=t}}},[i("a",{attrs:{href:"#"}},[e._v(e._s(t))])])}),0)]),i("div",[[i("select-tool",{directives:[{name:"show",rawName:"v-show",value:"Select"===e.currentTool,expression:"currentTool === 'Select'"}],ref:"selectTool"}),i("pan-tool",{directives:[{name:"show",rawName:"v-show",value:"Pan"===e.currentTool,expression:"currentTool === 'Pan'"}]}),i("keep-alive",[i("draw-tool",{directives:[{name:"show",rawName:"v-show",value:"Draw"===e.currentTool,expression:"currentTool === 'Draw'"}]})],1),i("ruler-tool",{directives:[{name:"show",rawName:"v-show",value:"Ruler"===e.currentTool,expression:"currentTool === 'Ruler'"}]}),i("map-tool",{directives:[{name:"show",rawName:"v-show",value:"Map"===e.currentTool,expression:"currentTool === 'Map'"}]}),i("filter-tool",{directives:[{name:"show",rawName:"v-show",value:"Filter"===e.currentTool,expression:"currentTool === 'Filter'"}]}),i("vision-tool",{directives:[{name:"show",rawName:"v-show",value:"Vision"===e.currentTool,expression:"currentTool === 'Vision'"}]}),i("shape-menu",{ref:"shapecontext"}),i("createtoken-dialog",{ref:"createtokendialog"})]],2)])},fn=[],vn=function(){var e=this,t=e.$createElement,i=e._self._c||t;return void 0!==e.getActiveLayer()?i("ContextMenu",{attrs:{visible:e.visible,left:e.x+"px",top:e.y+"px"},on:{close:e.close}},[e.getLayers().length>1?i("li",[e._v("\n        Layer\n        "),i("ul",e._l(e.getLayers(),function(t){return i("li",{key:t.name,style:[e.getActiveLayer().name===t.name?{"background-color":"#82c8a0"}:{}],on:{click:function(i){return e.setLayer(t.name)}}},[e._v("\n                "+e._s(t.name)+"\n            ")])}),0)]):e._e(),i("li",{on:{click:e.moveToBack}},[e._v("Move to back")]),i("li",{on:{click:e.moveToFront}},[e._v("Move to front")]),i("li",{on:{click:e.addInitiative}},[e._v(e._s(e.getInitiativeWord())+" initiative")]),i("li",{on:{click:e.openEditDialog}},[e._v("Show properties")])]):e._e()},gn=[];let mn=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.x=0,this.y=0,this.shape=null}get activeLayer(){const e=xt.getLayer();return void 0===e?"":e.name}open(e,t){this.visible=!0,this.x=e.pageX,this.y=e.pageY,this.shape=t,this.$nextTick(()=>this.$children[0].$el.focus())}close(){this.visible=!1,this.shape=null}getLayers(){return xt.layers.filter(e=>e.selectable&&(yt.IS_DM||e.playerEditable))}getActiveLayer(){return xt.getLayer()}getInitiativeWord(){return null===this.shape?"":hs.contains(this.shape.uuid)?"Show":"Add"}setLayer(e){null!==this.shape&&(this.shape.moveLayer(e,!0),this.close())}moveToBack(){if(null===this.shape)return;const e=this.getActiveLayer();e.moveShapeOrder(this.shape,0,!0),this.close()}moveToFront(){if(null===this.shape)return;const e=this.getActiveLayer();e.moveShapeOrder(this.shape,e.shapes.length-1,!0),this.close()}addInitiative(){null!==this.shape&&(this.$parent.$parent.$parent,hs.contains(this.shape.uuid)||hs.addInitiative(this.shape.getInitiativeRepr()),Ke.$emit("Initiative.Show"),this.close())}openEditDialog(){Ke.$emit("EditDialog.Open",this.shape),this.close()}};mn=v["a"]([Object(g["b"])({components:{ContextMenu:k}})],mn);var bn=mn,yn=bn,wn=(i("8d74"),Object(r["a"])(yn,vn,gn,!1,null,"1a591495",null)),xn=wn.exports,Cn=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("modal",{attrs:{visible:e.visible},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[e._v("\n        Create basic token\n    ")])}}])},[i("div",{staticClass:"modal-body"},[i("label",{attrs:{for:"createtokendialog-text"}},[e._v("Text")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"}],attrs:{type:"text",id:"createtokendialog-name"},domProps:{value:e.text},on:{input:function(t){t.target.composing||(e.text=t.target.value)}}}),i("label",[e._v("Colours")]),i("div",{staticClass:"colours"},[i("span",[e._v("Fill:")]),i("color-picker",{attrs:{color:e.fillColour},on:{"update:color":function(t){e.fillColour=t}}}),i("span",[e._v("Border:")]),i("color-picker",{attrs:{color:e.borderColour},on:{"update:color":function(t){e.borderColour=t}}})],1),i("canvas",{ref:"canvas",attrs:{width:"100px",height:"100px"}})]),i("div",{staticClass:"modal-footer"},[i("button",{on:{click:e.submit}},[e._v("Submit")])])])},_n=[];let Sn=class extends s["default"]{constructor(){super(...arguments),this.x=0,this.y=0,this.visible=!1,this.text="X",this.fillColour="rgba(255, 255, 255, 1)",this.borderColour="rgba(0, 0, 0, 1)"}mounted(){this.updatePreview()}onTextChange(e,t){this.updatePreview()}onFillChange(e,t){this.updatePreview()}onBorderChange(e,t){this.updatePreview()}open(e,t){this.visible=!0,this.x=e,this.y=t}submit(){const e=xt.getLayer();if(void 0===e)return;const t=new Ti(ht(new Ze(this.x,this.y)),lt(yt.unitSize/2),this.text,"10px serif",this.fillColour,this.borderColour);t.addOwner(yt.username),e.addShape(t,!0),e.invalidate(!1),this.visible=!1}updatePreview(){const e=this.$refs.canvas.getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),e.beginPath();const t={x:e.canvas.width/2,y:e.canvas.height/2},i=.9*Math.min(t.x,t.y);e.fillStyle=this.fillColour,e.arc(t.x,t.y,i,0,2*Math.PI),e.fill(),"rgba(0, 0, 0, 0)"!==this.borderColour&&(e.beginPath(),e.lineWidth=5,e.strokeStyle=this.borderColour,e.arc(t.x,t.y,i,0,2*Math.PI),e.stroke()),e.save(),e.textAlign="center",e.textBaseline="middle";const s=he(e,this.text,i,i),n=0;e.transform(s,n,-n,s,t.x,t.y),e.fillStyle=tt["mostReadable"](this.fillColour,["#000","#fff"]).toHexString(),e.fillText(this.text,0,0),e.restore()}};v["a"]([Object(H["b"])("text")],Sn.prototype,"onTextChange",null),v["a"]([Object(H["b"])("fillColour")],Sn.prototype,"onFillChange",null),v["a"]([Object(H["b"])("borderColour")],Sn.prototype,"onBorderChange",null),Sn=v["a"]([Object(g["b"])({components:{Modal:Y,"color-picker":Ps},computed:Object.assign({},Object(O["b"])("game",["unitSize"]))})],Sn);var kn=Sn,Ln=kn,En=(i("2a75"),Object(r["a"])(Ln,Cn,_n,!1,null,"bf063922",null)),In=En.exports,On=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.selected?i("div",{staticClass:"tool-detail",style:{"--detailRight":e.detailRight,"--detailArrow":e.detailArrow}},[i("div",{directives:[{name:"show",rawName:"v-show",value:e.IS_DM,expression:"IS_DM"}]},[e._v("Mode")]),i("div",{directives:[{name:"show",rawName:"v-show",value:e.IS_DM,expression:"IS_DM"}],staticClass:"selectgroup"},e._l(e.modes,function(t){return i("div",{key:t,staticClass:"option",class:{"option-selected":e.modeSelect===t},on:{click:function(i){e.modeSelect=t}}},[e._v("\n            "+e._s(t)+"\n        ")])}),0),i("div",[e._v("Shape")]),i("div",{staticClass:"selectgroup"},e._l(e.shapes,function(t){return i("div",{key:t,staticClass:"option",class:{"option-selected":e.shapeSelect===t},on:{click:function(i){e.shapeSelect=t}}},[i("i",{staticClass:"fas",class:"fa-"+t})])}),0),i("div",[e._v("Colours")]),i("div",{staticClass:"selectgroup"},[i("color-picker",{staticClass:"option",attrs:{color:e.fillColour},on:{"update:color":function(t){e.fillColour=t}}}),i("color-picker",{staticClass:"option",attrs:{color:e.borderColour},on:{"update:color":function(t){e.borderColour=t}}})],1),i("div",{directives:[{name:"show",rawName:"v-show",value:"paint-brush"===e.shapeSelect,expression:"shapeSelect === 'paint-brush'"}]},[e._v("Brush size")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.brushSize,expression:"brushSize"},{name:"show",rawName:"v-show",value:"paint-brush"===e.shapeSelect,expression:"shapeSelect === 'paint-brush'"}],staticStyle:{"max-width":"100px"},attrs:{type:"text"},domProps:{value:e.brushSize},on:{input:function(t){t.target.composing||(e.brushSize=t.target.value)}}})]):e._e()},Tn=[];let Mn=class extends s["default"]{constructor(){super(...arguments),this.name="",this.selected=!1,this.active=!1}get detailRight(){const e=this.$parent.$refs[this.name+"-selector"][0].getBoundingClientRect(),t=e.left+e.width/2;return`${window.innerWidth-Math.min(window.innerWidth-25,t+75)}px`}get detailArrow(){const e=this.$parent.$refs[this.name+"-selector"][0].getBoundingClientRect(),t=e.left+e.width/2,i=Math.min(window.innerWidth-25,t+75);return`${i-t-14}px`}created(){this.$parent.$on("mousedown",(e,t)=>{t===this.name&&this.onMouseDown(e)}),this.$parent.$on("mouseup",(e,t)=>{t===this.name&&this.onMouseUp(e)}),this.$parent.$on("mousemove",(e,t)=>{t===this.name&&this.onMouseMove(e)}),this.$parent.$on("contextmenu",(e,t)=>{t===this.name&&this.onContextMenu(e)}),this.$parent.$on("tools-select-change",(e,t)=>{t===this.name?(this.selected=!1,this.onDeselect()):e===this.name&&(this.selected=!0,this.onSelect())})}onSelect(){}onDeselect(){}onMouseDown(e){}onMouseUp(e){}onMouseMove(e){}onContextMenu(e){}};Mn=v["a"]([g["b"]],Mn);var Pn,Dn,Nn=Mn,An=Nn,Rn=(i("12d3"),Object(r["a"])(An,Pn,Dn,!1,null,null,null)),Vn=Rn.exports;let $n=class extends Vn{constructor(){super(...arguments),this.name="Draw",this.active=!1,this.startPoint=null,this.shape=null,this.brushHelper=null,this.ruler=null,this.fillColour="rgba(0, 0, 0, 1)",this.borderColour="rgba(255, 255, 255, 0)",this.shapeSelect="square",this.shapes=["square","circle","draw-polygon","paint-brush"],this.modeSelect="normal",this.modes=["normal","reveal","hide"],this.brushSize=lt(yt.unitSize)}get helperSize(){return"paint-brush"===this.shapeSelect?this.brushSize/2:lt(this.unitSize)/8}get IS_DM(){return yt.IS_DM}get unitSize(){return yt.unitSize}get useGrid(){return yt.useGrid}onFillChange(){this.brushHelper&&(this.brushHelper.fillColour=this.fillColour)}onModeUpdate(e,t){this.onModeChange(e,t)}setupBrush(){null!==this.brushHelper&&("reveal"===this.modeSelect||"hide"===this.modeSelect?(this.brushHelper.options.set("preFogShape",!0),this.brushHelper.options.set("skipDraw",!0),this.brushHelper.fillColour="rgba(0, 0, 0, 1)","reveal"===this.modeSelect?this.brushHelper.globalCompositeOperation="source-over":"hide"===this.modeSelect&&(this.brushHelper.globalCompositeOperation="destination-out")):(this.brushHelper.options.delete("preFogShape"),this.brushHelper.options.delete("skipDraw"),this.brushHelper.globalCompositeOperation="source-over",this.brushHelper.fillColour=this.fillColour))}onModeChange(e,t){if(null===this.brushHelper)return;const i=xt.getLayer("fow"),s=xt.getLayer();void 0!==i&&void 0!==s&&(this.setupBrush(),"normal"!==e&&"normal"===t?(s.removeShape(this.brushHelper,!1),i.addShape(this.brushHelper,!1)):"normal"===e&&"normal"!==t&&(s.addShape(this.brushHelper,!1),i.removeShape(this.brushHelper,!1)))}getLayer(){return"normal"===this.modeSelect?xt.getLayer():xt.getLayer("fow")}onMouseDown(e){const t=this.getLayer();if(void 0!==t){if(this.active)null!==this.shape&&this.shape instanceof Ai&&this.shape._vertices.push(ht(ft(e)));else{switch(this.startPoint=ht(ft(e)),this.active=!0,this.shapeSelect){case"square":this.shape=new Di(this.startPoint.clone(),0,0,this.fillColour,this.borderColour);break;case"circle":this.shape=new Oi(this.startPoint.clone(),this.helperSize,this.fillColour,this.borderColour);break;case"paint-brush":this.shape=new Pi(this.startPoint.clone(),[],this.brushSize),this.shape.fillColour=this.fillColour;break;case"draw-polygon":this.shape=new Ai(this.startPoint.clone(),[],this.fillColour,this.borderColour);break;default:return}"normal"!==this.modeSelect&&(this.shape.options.set("preFogShape",!0),this.shape.options.set("skipDraw",!0),this.shape.fillColour="rgba(0, 0, 0, 1)"),"reveal"===this.modeSelect?this.shape.globalCompositeOperation="source-over":"hide"===this.modeSelect&&(this.shape.globalCompositeOperation="destination-out"),this.shape.addOwner(yt.username),"fow"===t.name&&"normal"===this.modeSelect&&(this.shape.visionObstruction=!0),t.addShape(this.shape,!0,!1,!1),this.pushBrushBack()}if(null!==this.shape&&this.shape instanceof Ai){const i=ht(ft(e));null===this.ruler?(this.ruler=new Mi(i,i,3,"black"),t.addShape(this.ruler,!1)):(this.ruler.refPoint=i,this.ruler.endPoint=i),this.shape.visionObstruction&&yi.vision.insertConstraint(this.shape.points[this.shape.points.length-2],this.shape.points[this.shape.points.length-1]),t.invalidate(!1),Xe.emit("Shape.Update",{shape:this.shape.asDict(),redraw:!0,temporary:!0})}}else console.log("No active layer!")}onMouseMove(e){const t=ht(ft(e)),i=this.getLayer();if(void 0!==i){if(null!==this.brushHelper&&(this.brushHelper.r=this.helperSize,this.brushHelper.refPoint=t,this.active||i.invalidate(!1)),this.active&&null!==this.startPoint&&null!==this.shape){switch(this.shapeSelect){case"square":{const e=this.shape,i=Math.abs(t.x-this.startPoint.x),s=Math.abs(t.y-this.startPoint.y);if(i===e.w&&s===e.h)return;e.w=i,e.h=s,(t.x<this.startPoint.x||t.y<this.startPoint.y)&&(this.shape.refPoint=new Qe(Math.min(this.startPoint.x,t.x),Math.min(this.startPoint.y,t.y)));break}case"circle":{const e=this.shape,i=t.subtract(this.startPoint).length();if(e.r===i)return;e.r=i;break}case"paint-brush":{const e=this.shape;if(mt(e.points[e.points.length-1],[t.x,t.y]))return;e._points.push(t);break}case"draw-polygon":this.ruler.endPoint=t;break}this.shape instanceof Ai||(Xe.emit("Shape.Update",{shape:this.shape.asDict(),redraw:!0,temporary:!0}),this.shape.visionObstruction&&(this.shape.triagVertices.length>1&&mi.deleteFromTriag({target:bi.VISION,vertices:this.shape.triagVertices,standalone:!1}),mi.addToTriag({target:bi.VISION,points:this.shape.points}))),i.invalidate(!1)}}else console.log("No active layer!")}onMouseUp(e){!this.active||null===this.shape||this.shape instanceof Ai||(!e.altKey&&this.useGrid&&(mi.deleteFromTriag({target:bi.VISION,vertices:this.shape.triagVertices,standalone:!1}),this.shape.resizeToGrid(),mi.addToTriag({target:bi.VISION,points:this.shape.points})),this.finaliseShape())}onContextMenu(e){if(!this.active||null===this.shape||!(this.shape instanceof Ai))return;const t=this.getLayer();void 0!==t?(t.removeShape(this.ruler,!1),this.ruler=null,this.finaliseShape()):console.log("No active layer!")}finaliseShape(){null!==this.shape&&(this.shape.visionObstruction&&mi.recalculateVision(),this.shape.movementObstruction&&mi.recalculateMovement(),Xe.emit("Shape.Update",{shape:this.shape.asDict(),redraw:!0,temporary:!1}),this.active=!1)}onSelect(){const e=this.getLayer();void 0!==e&&(this.brushHelper=new Oi(new Qe(-1e3,-1e3),this.brushSize/2,this.fillColour),this.setupBrush(),e.addShape(this.brushHelper,!1))}onDeselect(){const e=this.getLayer();null!==this.brushHelper&&void 0!==e&&e.removeShape(this.brushHelper,!1),this.active&&void 0!==e&&null!==this.shape&&(e.removeShape(this.shape,!0,!1),this.shape=null,this.active=!1,e.invalidate(!1))}pushBrushBack(){const e=this.getLayer();void 0!==e?(null!==this.brushHelper&&e.removeShape(this.brushHelper,!1),this.brushHelper=new Oi(new Qe(-1e3,-1e3),this.brushSize/2,this.fillColour),this.setupBrush(),e.addShape(this.brushHelper,!1)):console.log("No active layer!")}};v["a"]([Object(H["b"])("fillColour")],$n.prototype,"onFillChange",null),v["a"]([Object(H["b"])("modeSelect")],$n.prototype,"onModeUpdate",null),$n=v["a"]([Object(g["b"])({components:{"color-picker":Ps}})],$n);var Un=$n,Fn=Un,zn=(i("3d9b"),Object(r["a"])(Fn,On,Tn,!1,null,"5d5e81ae",null)),Bn=zn.exports,Hn=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.selected?i("div",{staticClass:"tool-detail",style:{"--detailRight":e.detailRight,"--detailArrow":e.detailArrow}},[i("div",{attrs:{id:"accordion-container"}},e._l(e.categories,function(t){return i("accordion",{key:t,attrs:{title:""===t?"no category":t,showArrow:!1,items:e.labels[t],initialValues:e.initalValues[t]},on:{selectionupdate:e.updateSelection}})}),1)]):e._e()},Gn=[],jn=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"accordion"},[i("div",{attrs:{id:"header"},on:{click:function(t){return t.preventDefault(),e.toggleDisplay(t)}}},[i("input",{ref:"overall",attrs:{type:"checkbox"},on:{click:function(t){return t.stopPropagation(),e.toggleCategory(t)}}}),i("strong",[e._v(e._s(e.title))]),e.showArrow?[i("span",{directives:[{name:"show",rawName:"v-show",value:e.showArrow&&!e.active,expression:"showArrow && !active"}],staticClass:"down-Arrow"},[e._v("▼")]),i("span",{directives:[{name:"show",rawName:"v-show",value:e.showArrow&&e.active,expression:"showArrow && active"}],staticClass:"up-Arrow"},[e._v("▲")])]:e._e()],2),i("div",{directives:[{name:"show",rawName:"v-show",value:e.active,expression:"active"}],attrs:{id:"body"}},e._l(e.items,function(t){return i("div",{key:t[0],staticClass:"item",on:{click:function(i){return e.toggleSelection(t[0])}}},[i("input",{attrs:{type:"checkbox"},domProps:{checked:e.selected.includes(t[0])},on:{click:function(e){e.preventDefault()}}}),e._v("\n            "+e._s(t[1])+"\n        ")])}),0)])},Wn=[];let Xn=class extends s["default"]{constructor(){super(...arguments),this.selected=[],this.active=!1}mounted(){this.selected=this.initialValues,this.updateCategory()}toggleDisplay(e){this.active=!this.active}toggleCategory(){const e=this.$refs.overall;e.checked?this.selected=this.items.map(e=>e[0]):this.selected=[],this.$emit("selectionupdate",{title:this.title,selection:this.selected})}updateCategory(){const e=this.$refs.overall;0===this.selected.length?(e.checked=!1,e.indeterminate=!1):this.selected.length===this.items.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}toggleSelection(e){const t=this.selected.indexOf(e);-1===t?this.selected.push(e):this.selected.splice(t,1),this.updateCategory(),this.$emit("selectionupdate",{title:this.title,selection:this.selected})}};v["a"]([Object(H["a"])(String)],Xn.prototype,"title",void 0),v["a"]([Object(H["a"])({default:!0,type:Boolean})],Xn.prototype,"showArrow",void 0),v["a"]([Object(H["a"])({default:()=>[]})],Xn.prototype,"items",void 0),v["a"]([Object(H["a"])({default:()=>[]})],Xn.prototype,"initialValues",void 0),Xn=v["a"]([g["b"]],Xn);var Yn=Xn,Kn=Yn,qn=(i("aa79"),Object(r["a"])(Kn,jn,Wn,!1,null,"32e257d0",null)),Qn=qn.exports;let Zn=class extends Vn{constructor(){super(...arguments),this.name="Filter",this.active=!1}get labels(){const e={"":[]};for(const t of Object.keys(yt.labels)){const i=yt.labels[t];i.category?(i.category in e||(e[i.category]=[]),e[i.category].push([i.uuid,i.name]),e[i.category].sort((e,t)=>e[1].localeCompare(t[1]))):e[""].push([i.uuid,i.name])}return e}get initalValues(){const e={};for(const t of Object.keys(this.labels))e[t]=yt.labelFilters.filter(e=>this.labels[t].map(e=>e[0]).includes(e));return e}get categories(){return Object.keys(this.labels).sort()}isFilter(e){return yt.labelFilters.includes(e)}toggleFilter(e){const t=yt.labelFilters.indexOf(e);t>=0?yt.labelFilters.splice(t,1):yt.labelFilters.push(e),xt.invalidate()}toggleUnlabeled(){yt.toggleUnlabeledFilter(),xt.invalidate()}updateSelection(e){if(e.title in this.labels){for(const i of this.labels[e.title]){var t=Object(_t["a"])(i,2);const s=t[0],n=(t[1],yt.labelFilters.indexOf(s)),o=e.selection.includes(s);n>=0&&!o?(yt.labelFilters.splice(n,1),Xe.emit("Labels.Filter.Remove",s)):n<0&&o&&(yt.labelFilters.push(s),Xe.emit("Labels.Filter.Add",s))}xt.invalidate()}}};Zn=v["a"]([Object(g["b"])({components:{accordion:Qn}})],Zn);var Jn=Zn,eo=Jn,to=(i("e3f5"),i("4a14"),Object(r["a"])(eo,Hn,Gn,!1,null,"75b63661",null)),io=to.exports,so=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.selected?i("div",{staticClass:"tool-detail",style:{"--detailRight":e.detailRight,"--detailArrow":e.detailArrow}},[i("div",[e._v("#X")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.xCount,expression:"xCount"}],attrs:{type:"text"},domProps:{value:e.xCount},on:{input:function(t){t.target.composing||(e.xCount=t.target.value)}}}),i("div",[e._v("#Y")]),i("input",{directives:[{name:"model",rawName:"v-model",value:e.yCount,expression:"yCount"}],attrs:{type:"text"},domProps:{value:e.yCount},on:{input:function(t){t.target.composing||(e.yCount=t.target.value)}}})]):e._e()},no=[];let oo=class extends Vn{constructor(){super(...arguments),this.name="Map",this.active=!1,this.xCount=3,this.yCount=3,this.startPoint=null,this.rect=null}onMouseDown(e){const t=xt.getLayer();void 0!==t?(this.active=!0,this.startPoint=ht(ft(e)),this.rect=new Di(this.startPoint.clone(),0,0,"rgba(0,0,0,0)","black"),t.addShape(this.rect,!1,!1)):console.log("No active layer!")}onMouseMove(e){if(!this.active||null===this.rect||null===this.startPoint)return;const t=xt.getLayer();if(void 0===t)return void console.log("No active layer!");const i=ht(ft(e));this.rect.w=Math.abs(i.x-this.startPoint.x),this.rect.h=Math.abs(i.y-this.startPoint.y),this.rect.refPoint=new Qe(Math.min(this.startPoint.x,i.x),Math.min(this.startPoint.y,i.y)),t.invalidate(!1)}onMouseUp(e){if(!this.active||null===this.rect)return;const t=xt.getLayer();if(void 0===t)return void console.log("No active layer!");if(this.active=!1,1!==t.selection.length)return void t.removeShape(this.rect,!1,!1);const i=this.rect.w,s=this.rect.h,n=t.selection[0];n instanceof Ei&&(n.w*=this.xCount*yt.gridSize/i,n.h*=this.yCount*yt.gridSize/s),t.removeShape(this.rect,!1,!1)}};oo=v["a"]([g["b"]],oo);var ro=oo,ao=ro,lo=Object(r["a"])(ao,so,no,!1,null,null,null),co=lo.exports;let ho=class extends Vn{constructor(){super(...arguments),this.name="Pan",this.panStart=new Ze(0,0),this.active=!1}onMouseDown(e){this.panStart=ft(e),this.active=!0}onMouseMove(e){if(!this.active)return;const t=ft(e),i=t.subtract(this.panStart).multiply(1/yt.zoomFactor);yt.increasePanX(Math.round(i.x)),yt.increasePanY(Math.round(i.y)),this.panStart=t,xt.invalidate()}onMouseUp(e){this.active=!1,st(yt.locationOptions)}};ho=v["a"]([g["b"]],ho);var uo=ho,po=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("SelectContext",{ref:"selectcontext"})},fo=[],vo=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ContextMenu",{attrs:{visible:e.visible,left:e.x+"px",top:e.y+"px"},on:{close:e.close}},[e.IS_DM?i("li",{on:{click:e.bringPlayers}},[e._v("Bring players")]):e._e(),i("li",{on:{click:e.createToken}},[e._v("Create basic token")]),i("li",{on:{click:e.showInitiative}},[e._v("Show initiative")])])},go=[];let mo=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.x=0,this.y=0}get IS_DM(){return yt.IS_DM}open(e){this.visible=!0,this.x=e.pageX,this.y=e.pageY,this.$nextTick(()=>this.$children[0].$el.focus())}close(){this.visible=!1}bringPlayers(){yt.IS_DM&&(Xe.emit("Players.Bring",{x:ut(this.x),y:dt(this.y)}),this.close())}createToken(){this.$parent.$parent.$refs.createtokendialog.open(this.x,this.y),this.close()}showInitiative(){Ke.$emit("Initiative.Show"),this.close()}};mo=v["a"]([Object(g["b"])({components:{ContextMenu:k}})],mo);var bo,yo=mo,wo=yo,xo=(i("9c0f"),Object(r["a"])(wo,vo,go,!1,null,"7983fcf6",null)),Co=xo.exports;(function(e){e[e["Noop"]=0]="Noop",e[e["Resize"]=1]="Resize",e[e["Drag"]=2]="Drag",e[e["GroupSelect"]=3]="GroupSelect"})(bo||(bo={}));const _o=new Qe(-1e3,-1e3);let So=class extends Vn{constructor(){super(...arguments),this.name="Select",this.showContextMenu=!1,this.active=!1,this.mode=bo.Noop,this.resizePoint=0,this.deltaChanged=!1,this.dragRay=new et(new Ze(0,0),new Je(0,0)),this.selectionStartPoint=_o,this.selectionHelper=new Di(_o,0,0)}created(){this.selectionHelper.globalCompositeOperation="source-over",yt.setSelectionHelperId(this.selectionHelper.uuid)}onMouseDown(e){const t=xt.getLayer();if(void 0===t)return void console.log("No active layer!");this.selectionHelper.owners.includes(yt.username)||this.selectionHelper.addOwner(yt.username);const i=ft(e),s=ht(i);let n,o=!1;n=t.selection.length?t.shapes.concat(t.selection):t.shapes;for(let r=n.length-1;r>=0;r--){const e=n[r];if(this.resizePoint=e.getPointIndex(s,pt(3)),this.resizePoint>=0){t.selection=[e],Ke.$emit("SelectionInfo.Shape.Set",e),this.mode=bo.Resize,t.invalidate(!0),o=!0;break}if(e.contains(s)){const s=e;-1===t.selection.indexOf(s)&&(t.selection=[s],Ke.$emit("SelectionInfo.Shape.Set",s)),this.mode=bo.Drag;const n=nt(s.refPoint);this.dragRay=new et(n,i.subtract(n)),t.invalidate(!0),o=!0;break}}if(!o){this.mode=bo.GroupSelect;for(const e of t.selection)Ke.$emit("SelectionInfo.Shape.Set",e);this.selectionStartPoint=s,this.selectionHelper.refPoint=this.selectionStartPoint,this.selectionHelper.w=0,this.selectionHelper.h=0,t.selection=[this.selectionHelper],t.invalidate(!0)}this.active=!0}onMouseMove(e){const t=xt.getLayer();if(void 0===t)return void console.log("No active layer!");const i=ft(e),s=ht(i);if(this.deltaChanged=!1,this.mode===bo.GroupSelect){const e=s;this.selectionHelper.w=Math.abs(e.x-this.selectionStartPoint.x),this.selectionHelper.h=Math.abs(e.y-this.selectionStartPoint.y),this.selectionHelper.refPoint=new Qe(Math.min(this.selectionStartPoint.x,e.x),Math.min(this.selectionStartPoint.y,e.y)),t.invalidate(!0)}else if(t.selection.length){const n=nt(t.selection[t.selection.length-1].refPoint),o=n.add(this.dragRay.direction);let r=i.subtract(o).multiply(1/yt.zoomFactor);const a=r;if(this.mode===bo.Drag){if("tokens"===t.name&&(!e.shiftKey||!yt.IS_DM))for(const e of t.selection)e.ownedBy()&&e.uuid!==this.selectionHelper.uuid&&(r=ki(r,e),r!==a&&(this.deltaChanged=!0));for(const e of t.selection)e.ownedBy()&&(e.visionObstruction&&mi.deleteFromTriag({target:bi.VISION,vertices:e.triagVertices,standalone:!1}),e.refPoint=e.refPoint.add(r),e.visionObstruction&&mi.addToTriag({target:bi.VISION,points:e.points}),e!==this.selectionHelper&&Xe.emit("Shape.Update",{shape:e.asDict(),redraw:!0,temporary:!0}));t.invalidate(!1)}else if(this.mode===bo.Resize)for(const e of t.selection)e.ownedBy()&&(e.visionObstruction&&mi.deleteFromTriag({target:bi.VISION,vertices:e.triagVertices,standalone:!1}),e.resize(this.resizePoint,i),e!==this.selectionHelper&&(e.visionObstruction&&mi.addToTriag({target:bi.VISION,points:e.points}),Xe.emit("Shape.Update",{shape:e.asDict(),redraw:!0,temporary:!0})),t.invalidate(!1),this.updateCursor(t,s));else this.updateCursor(t,s)}else document.body.style.cursor="default"}onMouseUp(e){if(!this.active)return;if(void 0===xt.getLayer())return void console.log("No active layer!");const t=xt.getLayer();this.mode===bo.GroupSelect?(t.clearSelection(),t.shapes.forEach(e=>{if(!e.ownedBy())return;if(e===this.selectionHelper)return;const i=e.getBoundingBox();e.ownedBy()&&this.selectionHelper.refPoint.x<=i.topRight.x&&this.selectionHelper.refPoint.x+this.selectionHelper.w>=i.topLeft.x&&this.selectionHelper.refPoint.y<=i.botLeft.y&&this.selectionHelper.refPoint.y+this.selectionHelper.h>=i.topLeft.y&&t.selection.push(e)}),t.selection.length>0&&t.selection.push(this.selectionHelper),t.invalidate(!0)):t.selection.length&&t.selection.forEach(i=>{if(i.ownedBy()){if(this.mode===bo.Drag){if(this.dragRay.origin.x===ot(i.refPoint.x)&&this.dragRay.origin.y===rt(i.refPoint.y))return;!yt.useGrid||e.altKey||this.deltaChanged||(i.visionObstruction&&mi.deleteFromTriag({target:bi.VISION,vertices:i.triagVertices,standalone:!1}),i.movementObstruction&&mi.deleteFromTriag({target:bi.MOVEMENT,vertices:i.triagVertices,standalone:!1}),i.snapToGrid(),i.visionObstruction&&mi.addToTriag({target:bi.VISION,points:i.points}),i.movementObstruction&&mi.addToTriag({target:bi.MOVEMENT,points:i.points})),i!==this.selectionHelper&&Xe.emit("Shape.Update",{shape:i.asDict(),redraw:!0,temporary:!1}),t.invalidate(!1)}this.mode===bo.Resize&&(yt.useGrid&&!e.altKey&&(i.visionObstruction&&mi.deleteFromTriag({target:bi.VISION,vertices:i.triagVertices,standalone:!1}),i.movementObstruction&&mi.deleteFromTriag({target:bi.MOVEMENT,vertices:i.triagVertices,standalone:!1}),i.snapToGrid(),i.visionObstruction&&mi.addToTriag({target:bi.VISION,points:i.points}),i.visionObstruction&&mi.addToTriag({target:bi.VISION,points:i.points})),i!==this.selectionHelper&&Xe.emit("Shape.Update",{shape:i.asDict(),redraw:!0,temporary:!1}),t.invalidate(!1))}}),this.mode=bo.Noop,this.active=!1}onContextMenu(e){if(void 0===xt.getLayer())return void console.log("No active layer!");const t=xt.getLayer(),i=ft(e),s=ht(i);for(const n of t.selection)if(n.contains(s)&&n!==this.selectionHelper)return t.selection=[n],Ke.$emit("SelectionInfo.Shape.Set",n),t.invalidate(!0),void this.$parent.$refs.shapecontext.open(e,n);this.$refs.selectcontext.open(e)}updateCursor(e,t){for(const i of e.selection){const e=i.getPointIndex(t,pt(3));if(e<0)document.body.style.cursor="default";else{let t=i.getPointOrientation(e).angle();t<0&&(t+=360);const s=22.5;(t>=315+s||t<s||t>=135+s&&t<225-s)&&(document.body.style.cursor="ew-resize"),(t>=45+s&&t<135-s||t>=225+s&&t<315-s)&&(document.body.style.cursor="ns-resize"),(t>=s&&t<90-s||t>=180+s&&t<270-s)&&(document.body.style.cursor="nwse-resize"),(t>=90+s&&t<180-s||t>=270+s&&t<360-s)&&(document.body.style.cursor="nesw-resize")}}}};So=v["a"]([Object(g["b"])({components:{SelectContext:Co}})],So);var ko=So,Lo=ko,Eo=Object(r["a"])(Lo,po,fo,!1,null,null,null),Io=Eo.exports,Oo=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.selected?i("div",{staticClass:"tool-detail",style:{"--detailRight":e.detailRight,"--detailArrow":e.detailArrow}},e._l(e.tokens,function(t){return i("div",{key:t.uuid,staticClass:"token",class:{selected:e.selection.includes(t.uuid)},on:{click:function(i){return e.toggle(t.uuid)}}},[t.src?i("img",{attrs:{src:t.src,width:"30px",height:"30px"}}):e._e(),i("div",[e._v(e._s(t.name))])])}),0):e._e()},To=[];let Mo=class extends Vn{constructor(){super(...arguments),this.name="Vision",this.active=!1}get selection(){return yt.activeTokens}get tokens(){return yt.ownedtokens.map(e=>xt.UUIDMap.get(e))}toggle(e){this.selection.includes(e)?yt.removeActiveToken(e):yt.addActiveToken(e)}};Mo=v["a"]([g["b"]],Mo);var Po=Mo,Do=Po,No=(i("7392"),Object(r["a"])(Do,Oo,To,!1,null,"f995dfd4",null)),Ao=No.exports;let Ro=class extends Vn{constructor(){super(...arguments),this.name="Ruler",this.active=!1,this.startPoint=null,this.ruler=null,this.text=null}onMouseDown(e){const t=xt.getLayer("draw");void 0!==t?(this.active=!0,this.startPoint=ht(ft(e)),this.ruler=new Mi(this.startPoint,this.startPoint,3,yt.rulerColour),this.text=new Ni(this.startPoint.clone(),"","bold 20px serif"),this.ruler.addOwner(yt.username),this.text.addOwner(yt.username),t.addShape(this.ruler,!0,!0),t.addShape(this.text,!0,!0)):console.log("No draw layer!")}onMouseMove(e){if(!this.active||null===this.ruler||null===this.startPoint||null===this.text)return;const t=xt.getLayer("draw");if(void 0===t)return void console.log("No draw layer!");const i=ht(ft(e));this.ruler.endPoint=i,Xe.emit("Shape.Update",{shape:this.ruler.asDict(),redraw:!0,temporary:!0});const s=Math.sign(i.x-this.startPoint.x)*Math.sign(i.y-this.startPoint.y),n=Math.abs(i.x-this.startPoint.x),o=Math.abs(i.y-this.startPoint.y),r=Math.round(Math.sqrt(Math.pow(n,2)+Math.pow(o,2))*yt.unitSize/yt.gridSize)+" ft",a=Math.atan2(s*o,n),l=Math.min(this.startPoint.x,i.x)+n/2,c=Math.min(this.startPoint.y,i.y)+o/2;this.text.refPoint=new Qe(l,c),this.text.text=r,this.text.angle=a,Xe.emit("Shape.Update",{shape:this.text.asDict(),redraw:!0,temporary:!0}),t.invalidate(!0)}onMouseUp(e){if(!this.active||null===this.ruler||null===this.startPoint||null===this.text)return;const t=xt.getLayer("draw");void 0!==t?(this.active=!1,t.removeShape(this.ruler,!0,!0),t.removeShape(this.text,!0,!0),t.invalidate(!0),this.ruler=this.startPoint=this.text=null):console.log("No active layer!")}};Ro=v["a"]([g["b"]],Ro);let Vo=class extends s["default"]{constructor(){super(...arguments),this.currentTool="Select",this.tools=["Select","Pan","Draw","Ruler","Map","Filter","Vision"],this.dmTools=["Map"]}get IS_DM(){return yt.IS_DM}get currentToolComponent(){return`${this.currentTool.toLowerCase()}-tool`}get visibleTools(){return this.tools.filter(e=>!this.dmTools.includes(e)||this.IS_DM)}toolVisible(e){return"Filter"===e?Object.keys(yt.labels).length>0:"Vision"!==e||yt.ownedtokens.length>1}mousedown(e){if("CANVAS"!==e.target.tagName)return;let t=this.currentTool;if(1===e.button)t="Pan";else if(0!==e.button)return;this.$emit("mousedown",e,t)}mouseup(e){if("CANVAS"!==e.target.tagName)return;let t=this.currentTool;if(1===e.button)t="Pan";else if(0!==e.button)return;this.$emit("mouseup",e,t)}mousemove(e){if("CANVAS"!==e.target.tagName)return;let t=this.currentTool;if(0!==(4&e.buttons))t="Pan";else if((1&e.button)>1)return;this.$emit("mousemove",e,t);let i=!1;for(const s of yt.annotations)if(xt.UUIDMap.has(s)&&xt.hasLayer("draw")){const t=xt.UUIDMap.get(s);t.contains(ht(ft(e)))&&(i=!0,ns.annotationManager.setActiveText(t.annotation))}!i&&ns.annotationManager.shown&&ns.annotationManager.setActiveText("")}mouseleave(e){0!==(1&e.buttons)&&this.$emit("mouseup",e,this.currentTool)}contextmenu(e){"CANVAS"===e.target.tagName&&2===e.button&&"CANVAS"===e.target.tagName&&this.$emit("contextmenu",e,this.currentTool)}};Vo=v["a"]([Object(g["b"])({components:{"select-tool":Io,"pan-tool":uo,"draw-tool":Bn,"ruler-tool":Ro,"map-tool":co,"filter-tool":io,"vision-tool":Ao,"shape-menu":xn,"createtoken-dialog":In},watch:{currentTool(e,t){this.$emit("tools-select-change",e,t)}}})],Vo);var $o=Vo,Uo=$o,Fo=(i("4612"),Object(r["a"])(Uo,pn,fn,!1,null,"4302f32a",null)),zo=Fo.exports;function Bo(e){if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)&&("Delete"===e.key||"Del"===e.key||"Backspace"===e.key)){if(void 0===xt.getLayer)return void console.log("No active layer selected for delete operation");const e=xt.getLayer();for(let t=e.selection.length-1;t>=0;t--){const i=e.selection[t];yt.selectionHelperID!==i.uuid?(e.removeShape(i,!0,!1),Ke.$emit("SelectionInfo.Shape.Set",null),Ke.$emit("Initiative.Remove",i.uuid)):e.selection.splice(t,1)}}}function Ho(e){if(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)65===e.keyCode&&e.ctrlKey&&e.target.select();else if(e.keyCode>=37&&e.keyCode<=40){const t=Math.round(yt.gridSize);let i=t*(e.keyCode%2),s=t*(e.keyCode%2?0:1);if(xt.hasSelection()){const t=xt.getSelection();i*=e.keyCode<=38?-1:1,s*=e.keyCode<=38?-1:1;let n=new Je(i,s);if(!e.shiftKey||!yt.IS_DM)for(const e of t)yt.selectionHelperID!==e.uuid&&(n=ki(n,e));if(0===n.length())return;for(const e of t)yt.selectionHelperID!==e.uuid&&(e.movementObstruction&&mi.deleteFromTriag({target:bi.VISION,vertices:e.triagVertices,standalone:!1}),e.refPoint=e.refPoint.add(n),e.movementObstruction&&mi.addToTriag({target:bi.VISION,points:e.points}),Xe.emit("Shape.Position.Update",{shape:e.asDict(),redraw:!0,temporary:!1}));xt.getLayer().invalidate(!1)}else yt.increasePanX(i*(e.keyCode<=38?1:-1)),yt.increasePanY(s*(e.keyCode<=38?1:-1)),xt.invalidate(),st(yt.locationOptions)}else if(68===e.keyCode){const e=xt.getLayer();e&&(e.clearSelection(),e.invalidate(!0))}else if("u"===e.key&&e.ctrlKey)e.preventDefault(),e.stopPropagation(),yt.toggleUI();else if("c"===e.key&&e.ctrlKey){const e=xt.getLayer();if(!e)return;if(!e.selection)return;const t=[];for(const i of e.selection)yt.selectionHelperID!==i.uuid&&t.push(i.asDict());yt.setClipboard(t)}else if("v"===e.key&&e.ctrlKey){const e=xt.getLayer();if(!e)return;if(!yt.clipboard)return;e.selection=[];for(const t of yt.clipboard){t.x+=10,t.y+=10,t.uuid=ae();const i=t.trackers;t.trackers=[];for(const e of i){const i=Object.assign({},e,{uuid:ae()});t.trackers.push(i)}const s=t.auras;t.auras=[];for(const e of s){const i=Object.assign({},e,{uuid:ae()});t.auras.push(i)}const n=Ri(t);void 0!==n&&(e.addShape(n,!0),e.selection.push(n))}1===e.selection.length?Ke.$emit("SelectionInfo.Shape.Set",e.selection[0]):Ke.$emit("SelectionInfo.Shape.Set",null),e.invalidate(!1)}}function Go(e){if(!e.target||!e.target.tagName||"CANVAS"!==e.target.tagName)return;let t;t=-1*Math.sign(e.deltaY),yt.updateZoom({newZoomDisplay:yt.zoomDisplay-.1*t,zoomLocation:ht(ft(e))})}var jo=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("Modal",{attrs:{visible:e.visible,colour:"rgba(255, 255, 255, 0.8)",mask:!1},on:{close:function(t){e.visible=!1}},scopedSlots:e._u([{key:"header",fn:function(t){return i("div",{staticClass:"modal-header",attrs:{draggable:"true"},on:{dragstart:t.dragStart,dragend:t.dragEnd}},[i("div",[e._v("DM Settings")]),i("div",{staticClass:"header-close",on:{click:function(t){e.visible=!1}}},[i("i",{staticClass:"far fa-window-close"})])])}}])},[i("div",{staticClass:"modal-body",on:{click:e.handleClick}},[i("div",{attrs:{id:"categories"}},e._l(e.categories,function(t,s){return i("div",{key:t,staticClass:"category",class:{selected:e.selection===s},on:{click:function(t){e.selection=s}}},[e._v("\n                "+e._s(t)+"\n            ")])}),0),i("div",{directives:[{name:"show",rawName:"v-show",value:0===e.selection,expression:"selection === 0"}],staticClass:"panel"},[i("div",{staticClass:"spanrow header"},[e._v("Players")]),e._l(e.$store.state.game.players,function(t){return i("div",{key:t.id,staticClass:"row smallrow"},[i("div",[e._v(e._s(t.name))]),i("div",[i("div",{on:{click:function(i){return e.kickPlayer(t.id)}}},[e._v("Kick")])])])}),0===Object.values(e.$store.state.game.players).length?i("div",{staticClass:"row smallrow"},[i("div",{staticClass:"spanrow"},[e._v("There are no players yet, invite some using the link below!")])]):e._e(),i("div",{staticClass:"spanrow header"},[e._v("Invite code")]),i("div",{staticClass:"row"},[i("div",[e._v("Invitation URL:")]),e.showRefreshState?[i("InputCopyElement",{attrs:{value:e.refreshState}})]:[i("InputCopyElement",{attrs:{value:e.invitationUrl}})]],2),i("div",{staticClass:"row",on:{click:e.refreshInviteCode}},[i("div"),i("div",[i("button",[e._v("Refresh invitation code")])])]),i("div",{staticClass:"spanrow header"},[e._v("Danger Zone")]),i("div",{staticClass:"row"},[i("div",[e.locked?[e._v("\n                        Unlock\n                    ")]:[e._v("\n                        Lock\n                    ")],e._v("\n                    Session \n                    "),i("i",[e._v("(DM access only)")])],2),i("div",[i("button",{staticClass:"danger",on:{click:e.toggleSessionLock}},[e.locked?[e._v("\n                            Unlock\n                        ")]:[e._v("\n                            Lock\n                        ")],e._v("\n                        this Session\n                    ")],2)])]),i("div",{staticClass:"row"},[i("div",[e._v("Remove Session")]),i("div",[i("button",{staticClass:"danger",on:{click:e.deleteSession}},[e._v("Delete this Session")])])])],2),i("div",{directives:[{name:"show",rawName:"v-show",value:1===e.selection,expression:"selection === 1"}],staticClass:"panel"},[i("div",{staticClass:"row"},[i("label",{attrs:{for:"useGridInput"}},[e._v("Use grid")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:e.useGrid,expression:"useGrid"}],attrs:{id:"useGridInput",type:"checkbox"},domProps:{checked:Array.isArray(e.useGrid)?e._i(e.useGrid,null)>-1:e.useGrid},on:{change:function(t){var i=e.useGrid,s=t.target,n=!!s.checked;if(Array.isArray(i)){var o=null,r=e._i(i,o);s.checked?r<0&&(e.useGrid=i.concat([o])):r>-1&&(e.useGrid=i.slice(0,r).concat(i.slice(r+1)))}else e.useGrid=n}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"gridSizeInput"}},[e._v("Grid Size (in pixels):")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model.number",value:e.gridSize,expression:"gridSize",modifiers:{number:!0}}],attrs:{id:"gridSizeInput",type:"number",min:"0"},domProps:{value:e.gridSize},on:{input:function(t){t.target.composing||(e.gridSize=e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"unitSizeInput"}},[e._v("Unit Size (in ft.):")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model.number",value:e.unitSize,expression:"unitSize",modifiers:{number:!0}}],attrs:{id:"unitSizeInput",type:"number"},domProps:{value:e.unitSize},on:{input:function(t){t.target.composing||(e.unitSize=e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})])])]),i("div",{directives:[{name:"show",rawName:"v-show",value:2===e.selection,expression:"selection === 2"}],staticClass:"panel"},[i("div",{staticClass:"spanrow header"},[e._v("Core")]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"fakePlayerInput"}},[e._v("Fake player:")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:e.fakePlayer,expression:"fakePlayer"}],attrs:{id:"fakePlayerInput",type:"checkbox"},domProps:{checked:Array.isArray(e.fakePlayer)?e._i(e.fakePlayer,null)>-1:e.fakePlayer},on:{change:function(t){var i=e.fakePlayer,s=t.target,n=!!s.checked;if(Array.isArray(i)){var o=null,r=e._i(i,o);s.checked?r<0&&(e.fakePlayer=i.concat([o])):r>-1&&(e.fakePlayer=i.slice(0,r).concat(i.slice(r+1)))}else e.fakePlayer=n}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"useFOWInput"}},[e._v("Fill entire canvas with FOW:")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:e.fullFOW,expression:"fullFOW"}],attrs:{id:"useFOWInput",type:"checkbox"},domProps:{checked:Array.isArray(e.fullFOW)?e._i(e.fullFOW,null)>-1:e.fullFOW},on:{change:function(t){var i=e.fullFOW,s=t.target,n=!!s.checked;if(Array.isArray(i)){var o=null,r=e._i(i,o);s.checked?r<0&&(e.fullFOW=i.concat([o])):r>-1&&(e.fullFOW=i.slice(0,r).concat(i.slice(r+1)))}else e.fullFOW=n}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"fowLOS"}},[e._v("Only show lights in LoS:")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:e.fowLOS,expression:"fowLOS"}],attrs:{id:"fowLOS",type:"checkbox"},domProps:{checked:Array.isArray(e.fowLOS)?e._i(e.fowLOS,null)>-1:e.fowLOS},on:{change:function(t){var i=e.fowLOS,s=t.target,n=!!s.checked;if(Array.isArray(i)){var o=null,r=e._i(i,o);s.checked?r<0&&(e.fowLOS=i.concat([o])):r>-1&&(e.fowLOS=i.slice(0,r).concat(i.slice(r+1)))}else e.fowLOS=n}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"fowOpacity"}},[e._v("FOW opacity:")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model.number",value:e.fowOpacity,expression:"fowOpacity",modifiers:{number:!0}}],attrs:{id:"fowOpacity",type:"number",min:"0",max:"1",step:"0.1"},domProps:{value:e.fowOpacity},on:{input:function(t){t.target.composing||(e.fowOpacity=e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})])]),i("div",{staticClass:"spanrow header"},[e._v("Advanced")]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"visionMode"}},[e._v("Vision Mode:")]),i("div",[i("select",{attrs:{id:"visionMode"},on:{change:e.changeVisionMode}},[i("option",{domProps:{selected:"bvh"===e.$store.state.visibility.visionMode}},[e._v("BVH")]),i("option",{domProps:{selected:"triangle"===e.$store.state.visibility.visionMode}},[e._v("Triangle")])])])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"vmininp"}},[e._v("Minimal full vision (ft):")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model.lazy.number",value:e.visionRangeMin,expression:"visionRangeMin",modifiers:{lazy:!0,number:!0}}],attrs:{id:"vmininp",type:"number",min:"0"},domProps:{value:e.visionRangeMin},on:{change:function(t){e.visionRangeMin=e._n(t.target.value)},blur:function(t){return e.$forceUpdate()}}})])]),i("div",{staticClass:"row"},[i("label",{attrs:{for:"vmaxinp"}},[e._v("Maximal vision (ft):")]),i("div",[i("input",{directives:[{name:"model",rawName:"v-model.lazy.number",value:e.visionRangeMax,expression:"visionRangeMax",modifiers:{lazy:!0,number:!0}}],attrs:{id:"vmaxinp",type:"number",min:"0"},domProps:{value:e.visionRangeMax},on:{change:function(t){e.visionRangeMax=e._n(t.target.value)},blur:function(t){return e.$forceUpdate()}}})])])])])])},Wo=[],Xo=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"input-copy"},on:{mouseleave:function(t){e.showPopup=!1}}},[i("input",{attrs:{type:"text",disabled:"disabled",id:"input-element"},domProps:{value:e.value}}),i("div",{directives:[{name:"show",rawName:"v-show",value:e.showPopup,expression:"showPopup"}],attrs:{id:"show-popup"}},[e._v(e._s(e.popupString))]),i("div",{attrs:{id:"copy-button"},on:{click:e.copy}},[i("i",{staticClass:"far fa-copy"})])])},Yo=[];let Ko=class extends s["default"]{constructor(){super(...arguments),this.borderColour="lightgray",this.popupString="",this.showPopup=!1}copy(){navigator.clipboard.writeText(this.value).then(()=>{this.popupString="Copied!",this.showPopup=!0},()=>{console.log("Could not copy to clipboard :("),this.popupString="Error!",this.showPopup=!0})}};v["a"]([Object(H["a"])()],Ko.prototype,"value",void 0),Ko=v["a"]([g["b"]],Ko);var qo=Ko,Qo=qo,Zo=(i("e60f"),Object(r["a"])(Qo,Xo,Yo,!1,null,"628dde30",null)),Jo=Zo.exports;let er=class extends s["default"]{constructor(){super(...arguments),this.visible=!1,this.categories=["Admin","Grid","Vision"],this.selection=0,this.showRefreshState=!1,this.refreshState="pending"}mounted(){Ke.$on("DmSettings.Open",()=>{this.visible=!0}),Ke.$on("DmSettings.RefreshedInviteCode",()=>{this.showRefreshState=!1})}beforeDestroy(){Ke.$off("DmSettings.Open"),Ke.$off("DmSettings.RefreshedInviteCode")}get invitationUrl(){return window.location.protocol+"//"+window.location.host+"/invite/"+yt.invitationCode}get locked(){return yt.isLocked}get useGrid(){return yt.useGrid}set useGrid(e){yt.setUseGrid({useGrid:e,sync:!0})}get unitSize(){return yt.unitSize}set unitSize(e){"number"===typeof e&&yt.setUnitSize({unitSize:e,sync:!0})}get gridSize(){return yt.gridSize}set gridSize(e){"number"===typeof e&&yt.setGridSize({gridSize:e,sync:!0})}get fakePlayer(){return yt.FAKE_PLAYER}set fakePlayer(e){yt.setFakePlayer(e)}get fullFOW(){return yt.fullFOW}set fullFOW(e){yt.setFullFOW({fullFOW:e,sync:!0})}get fowOpacity(){return yt.fowOpacity}set fowOpacity(e){"number"===typeof e&&yt.setFOWOpacity({fowOpacity:e,sync:!0})}get fowLOS(){return yt.fowLOS}set fowLOS(e){yt.setLineOfSight({fowLOS:e,sync:!0})}get visionRangeMin(){return yt.visionRangeMin}set visionRangeMin(e){"number"===typeof e&&yt.setVisionRangeMin({value:e,sync:!0})}get visionRangeMax(){return yt.visionRangeMax}set visionRangeMax(e){"number"===typeof e&&yt.setVisionRangeMax({value:e,sync:!0})}changeVisionMode(e){const t=e.target.value.toLowerCase();"bvh"!==t&&"triangle"!==t||(mi.setVisionMode({mode:t,sync:!0}),mi.recalculateVision(),mi.recalculateMovement(),xt.invalidate())}handleClick(e){const t=e.target.firstElementChild;t instanceof HTMLInputElement&&t.click()}refreshInviteCode(){Xe.emit("Room.Info.InviteCode.Refresh"),this.refreshState="pending",this.showRefreshState=!0}kickPlayer(e){Xe.emit("Room.Info.Players.Kick",e),yt.kickPlayer(e)}toggleSessionLock(){yt.setIsLocked({isLocked:!yt.isLocked,sync:!0})}deleteSession(){this.$parent.$parent.$refs.prompt.prompt(`ENTER ${yt.roomCreator}/${yt.roomName} TO CONFIRM SESSION REMOVAL.`,"DELETING SESSION").then(e=>{e===`${yt.roomCreator}/${yt.roomName}`&&(Xe.emit("Room.Delete"),this.$router.push("/"))},()=>{})}};er=v["a"]([Object(g["b"])({components:{InputCopyElement:Jo,Modal:Y},computed:Object.assign({},Object(O["b"])("game",["invitationCode"]))})],er);var tr=er,ir=tr,sr=(i("559e"),Object(r["a"])(ir,jo,Wo,!1,null,"261cc18f",null)),nr=sr.exports;let or=class extends s["default"]{constructor(){super(...arguments),this.ready={manager:!1,tools:!1}}get showUI(){return yt.showUI}get IS_DM(){return yt.IS_DM}get FAKE_PLAYER(){return yt.FAKE_PLAYER}get layers(){return yt.layers}get selectedLayer(){return yt.selectedLayer}get zoomDisplay(){return yt.zoomDisplay}set zoomDisplay(e){yt.updateZoom({newZoomDisplay:e,zoomLocation:ht(new Ze(window.innerWidth/2,window.innerHeight/2))})}mounted(){window.addEventListener("resize",this.resizeWindow),window.addEventListener("keyup",Bo),window.addEventListener("keydown",Ho),this.ready.manager=!0}destroyed(){window.removeEventListener("resize",this.resizeWindow),window.removeEventListener("keyup",Bo),window.removeEventListener("keydown",Ho),this.ready.manager=!1}zoom(e){Ge()(Go)(e)}resizeWindow(){xt.setWidth(window.innerWidth),xt.setHeight(window.innerHeight),xt.invalidate()}mousedown(e){this.$refs.tools.mousedown(e)}mouseup(e){this.$refs.tools.mouseup(e)}mousemove(e){this.$refs.tools.mousemove(e)}mouseleave(e){this.$refs.tools.mouseleave(e)}contextmenu(e){this.$refs.tools.contextmenu(e)}selectLayer(e){xt.selectLayer(e)}drop(e){if(null!==e&&null!==e.dataTransfer)if(e.dataTransfer.files.length>0)this.$refs.confirm.open("Uploading files should be done through the asset manager.","Ok","").then(()=>{},()=>{});else{if(""===e.dataTransfer.getData("text/plain"))return;ts(e)}}};or=v["a"]([Object(g["b"])({components:{"tool-bar":zo,"selection-info":dn,"prompt-dialog":re,"confirm-dialog":J,"menu-bar":Gs,"initiative-dialog":vs,"zoom-slider":We.a,"note-dialog":Qs,"label-dialog":Cs,"dm-settings":nr},beforeRouteEnter(e,t,i){Ye(e),i()},beforeRouteLeave(e,t,i){Xe.disconnect(),i()}})],or);var rr=or,ar=rr,lr=(i("561b"),i("d3f9"),Object(r["a"])(ar,ze,Be,!1,null,"5bd5872f",null)),cr=lr.exports;let hr=class extends s["default"]{beforeRouteEnter(e,t,i){u.a.post("/api/invite",{code:e.params.code}).then(e=>{i({path:e.data.sessionUrl})}).catch(e=>{console.error("Invitation code could not be redeemed"),i({path:"/dashboard"})})}};hr=v["a"]([Object(g["b"])({template:""})],hr);var ur=hr;s["default"].use(d["a"]);const dr=new d["a"]({mode:"history",base:"/",routes:[{path:"/",redirect:"/dashboard"},{path:"/_load",name:"load",component:De},{path:"/assets",component:ve,meta:{auth:!0}},{path:"/auth",component:{template:"<router-view></router-view>"},children:[{path:"login",component:Se},{path:"logout",component:Le}]},{path:"/invite/:code",component:ur,meta:{auth:!0}},{path:"/dashboard",component:Fe,meta:{auth:!0}},{path:"/game/:creator/:room",component:cr,meta:{auth:!0}}]});dr.beforeEach((e,t,i)=>{ye.initialized||"/_load"===e.path?e.matched.some(e=>e.meta.auth)&&!ye.authenticated?i({path:"/auth/login",query:{redirect:e.path}}):i():(i({path:"/_load"}),u.a.get("/api/auth").then(t=>{t.data.auth&&(ye.setAuthenticated(!0),ye.setUsername(t.data.username)),ye.setInitialized(!0),dr.push(e.path)}).catch(()=>{console.error("Authentication check could not be fulfilled.")}))}),i.d(t,"app",function(){return pr}),s["default"].config.productionTip=!1,s["default"].config.devtools=!0,s["default"].config.performance=!0;const pr=new s["default"]({router:dr,store:T,render:e=>e(c)}).$mount("#app");window.app=pr},d3f9:function(e,t,i){"use strict";var s=i("2777"),n=i.n(s);n.a},d450:function(e,t,i){},d9e0:function(e,t,i){"use strict";var s=i("c098"),n=i.n(s);n.a},e1a0:function(e,t,i){},e3f5:function(e,t,i){"use strict";var s=i("a126"),n=i.n(s);n.a},e60f:function(e,t,i){"use strict";var s=i("c4d5"),n=i.n(s);n.a},fb5d:function(e,t,i){"use strict";var s=i("4315"),n=i.n(s);n.a},fce9:function(e,t,i){},fe11:function(e,t,i){}});
//# sourceMappingURL=app.020745ab.js.map